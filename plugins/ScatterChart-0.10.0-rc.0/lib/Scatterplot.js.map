{"version":3,"sources":["../../src/Scatterplot.tsx"],"sourcesContent":["// Copyright 2023 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { ReactElement, useMemo } from 'react';\nimport { EChart, OnEventsType, useChartsTheme } from '@perses-dev/components';\nimport { use, EChartsCoreOption } from 'echarts/core';\nimport { ScatterChart as EChartsScatterChart } from 'echarts/charts';\nimport {\n  DatasetComponent,\n  DataZoomComponent,\n  LegendComponent,\n  GridComponent,\n  TitleComponent,\n  TooltipComponent,\n} from 'echarts/components';\nimport { CanvasRenderer } from 'echarts/renderers';\nimport { EChartsOption, ScatterSeriesOption } from 'echarts';\nimport { formatValue } from '@perses-dev/core';\nimport {\n  replaceVariablesInString,\n  useAllVariableValues,\n  useRouterContext,\n  useTimeRange,\n} from '@perses-dev/plugin-system';\nimport { EChartTraceValue } from './ScatterChartPanel';\n\nuse([\n  DatasetComponent,\n  DataZoomComponent,\n  LegendComponent,\n  EChartsScatterChart,\n  GridComponent,\n  TitleComponent,\n  TooltipComponent,\n  CanvasRenderer,\n]);\n\nexport interface ScatterplotProps {\n  width: number;\n  height: number;\n  options: EChartsOption;\n  link?: string;\n}\n\nconst DATE_FORMATTER = new Intl.DateTimeFormat(undefined, {\n  dateStyle: 'long',\n  timeStyle: 'medium',\n}).format;\n\nexport function Scatterplot(props: ScatterplotProps): ReactElement {\n  const { width, height, options, link: linkTemplate } = props;\n  const chartsTheme = useChartsTheme();\n  const { absoluteTimeRange } = useTimeRange();\n  const variableValues = useAllVariableValues();\n  const { navigate } = useRouterContext();\n\n  // Apache EChart Options Docs: https://echarts.apache.org/en/option.html\n  const eChartOptions: EChartsCoreOption = {\n    dataset: options.dataset,\n    series: options.series,\n    dataZoom: options.dataZoom,\n    grid: {\n      top: 45,\n      bottom: 20,\n      left: 30,\n      right: 20,\n    },\n    xAxis: {\n      type: 'time',\n      min: absoluteTimeRange.start,\n      max: absoluteTimeRange.end,\n    },\n    yAxis: {\n      scale: true,\n      type: 'value',\n      name: 'Duration',\n      splitNumber: 4,\n      axisLabel: {\n        formatter: (durationMs: number) => formatValue(durationMs, { unit: 'milliseconds' }),\n      },\n    },\n    animation: false,\n    tooltip: {\n      padding: 5,\n      borderWidth: 1,\n      trigger: 'axis',\n      axisPointer: {\n        type: 'cross',\n      },\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      formatter: function (params: any) {\n        // TODO: import type from ECharts instead of using any\n        const data = params[0].data as EChartTraceValue;\n        return [\n          `<b>Service name</b>: ${data.rootServiceName}<br/>`,\n          `<b>Span name</b>: ${data.rootTraceName}<br/>`,\n          `<b>Time</b>: ${DATE_FORMATTER(data.startTime)}<br/>`,\n          `<b>Duration</b>: ${formatValue(data.durationMs, { unit: 'milliseconds' })}<br/>`,\n          `<b>Span count</b>: ${data.spanCount} (${data.errorCount} errors)<br/>`,\n        ].join('');\n      },\n    },\n    legend: {\n      show: true,\n      type: 'scroll',\n      orient: 'horizontal',\n      bottom: 0,\n    },\n  };\n\n  const handleEvents: OnEventsType<ScatterSeriesOption['data'] | unknown> = useMemo(() => {\n    const handlers: OnEventsType<ScatterSeriesOption['data'] | unknown> = {};\n    if (navigate && linkTemplate) {\n      handlers.click = (params): void => {\n        const linkVariables = params.data.linkVariables as Record<string, string> | undefined;\n        const link = replaceVariablesInString(linkTemplate, variableValues, linkVariables);\n        navigate(link);\n      };\n    }\n    return handlers;\n  }, [linkTemplate, navigate, variableValues]);\n\n  return (\n    <EChart\n      style={{\n        width: width,\n        height: height,\n      }}\n      option={eChartOptions}\n      theme={chartsTheme.echartsTheme}\n      onEvents={handleEvents}\n    />\n  );\n}\n"],"names":["useMemo","EChart","useChartsTheme","use","ScatterChart","EChartsScatterChart","DatasetComponent","DataZoomComponent","LegendComponent","GridComponent","TitleComponent","TooltipComponent","CanvasRenderer","formatValue","replaceVariablesInString","useAllVariableValues","useRouterContext","useTimeRange","DATE_FORMATTER","Intl","DateTimeFormat","undefined","dateStyle","timeStyle","format","Scatterplot","props","width","height","options","link","linkTemplate","chartsTheme","absoluteTimeRange","variableValues","navigate","eChartOptions","dataset","series","dataZoom","grid","top","bottom","left","right","xAxis","type","min","start","max","end","yAxis","scale","name","splitNumber","axisLabel","formatter","durationMs","unit","animation","tooltip","padding","borderWidth","trigger","axisPointer","params","data","rootServiceName","rootTraceName","startTime","spanCount","errorCount","join","legend","show","orient","handleEvents","handlers","click","linkVariables","style","option","theme","echartsTheme","onEvents"],"mappings":"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"}
{"version":3,"sources":["../../../src/model/loki-client.ts"],"sourcesContent":["// Copyright 2025 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {\n  LokiQueryResponse,\n  LokiQueryRangeResponse,\n  LokiLabelsResponse,\n  LokiLabelValuesResponse,\n  LokiSeriesResponse,\n  LokiIndexStatsResponse,\n  LokiVolumeResponse,\n  LokiRequestHeaders,\n} from './loki-client-types';\n\nexport interface LokiQueryParams {\n  query: string;\n  time?: string;\n  direction?: 'forward' | 'backward';\n  limit?: number;\n}\n\nexport interface LokiQueryRangeParams {\n  query: string;\n  start: string;\n  end: string;\n  step?: string;\n  interval?: string;\n  direction?: 'forward' | 'backward';\n  limit?: number;\n}\n\nexport interface LokiVolumeParams {\n  query: string;\n  start: string;\n  end: string;\n  step?: string;\n  limit?: number;\n}\n\nexport interface LokiApiOptions {\n  datasourceUrl: string;\n  headers?: LokiRequestHeaders;\n}\n\nexport interface LokiClient {\n  options: {\n    datasourceUrl: string;\n  };\n  query: (params: LokiQueryParams, headers?: LokiRequestHeaders) => Promise<LokiQueryResponse>;\n  queryRange: (params: LokiQueryRangeParams, headers?: LokiRequestHeaders) => Promise<LokiQueryRangeResponse>;\n  labels: (start?: string, end?: string, headers?: LokiRequestHeaders) => Promise<LokiLabelsResponse>;\n  labelValues: (\n    label: string,\n    start?: string,\n    end?: string,\n    headers?: LokiRequestHeaders\n  ) => Promise<LokiLabelValuesResponse>;\n  series: (match: string[], start?: string, end?: string, headers?: LokiRequestHeaders) => Promise<LokiSeriesResponse>;\n  volume: (params: LokiVolumeParams, headers?: LokiRequestHeaders) => Promise<LokiVolumeResponse>;\n  volumeRange: (params: LokiVolumeParams, headers?: LokiRequestHeaders) => Promise<LokiVolumeResponse>;\n  indexStats: (\n    query: string,\n    start?: string,\n    end?: string,\n    headers?: LokiRequestHeaders\n  ) => Promise<LokiIndexStatsResponse>;\n}\n\nexport async function query(params: LokiQueryParams, options: LokiApiOptions): Promise<LokiQueryResponse> {\n  const url = buildUrl('/loki/api/v1/query', options.datasourceUrl);\n  url.searchParams.append('query', params.query);\n  if (params.time) url.searchParams.append('time', params.time);\n  if (params.direction) url.searchParams.append('direction', params.direction);\n  if (params.limit) url.searchParams.append('limit', params.limit.toString());\n\n  const response = await fetch(url.toString(), {\n    method: 'GET',\n    headers: {\n      'Content-Type': 'application/json',\n      ...options.headers,\n    },\n  });\n  return response.json();\n}\n\nfunction buildUrl(path: string, datasourceUrl: string): URL {\n  if (datasourceUrl.startsWith('http://') || datasourceUrl.startsWith('https://')) {\n    return new URL(path, datasourceUrl);\n  }\n\n  let fullPath = datasourceUrl;\n  // Assume relative path, ensure no double slashes\n  if (datasourceUrl.endsWith('/') && path.startsWith('/')) {\n    fullPath = datasourceUrl + path.slice(1);\n  } else if (!datasourceUrl.endsWith('/') && !path.startsWith('/')) {\n    fullPath = datasourceUrl + '/' + path;\n  } else {\n    fullPath = datasourceUrl + path;\n  }\n\n  return new URL(fullPath, window.location.origin);\n}\n\nexport function toUnixSeconds(val: string | number | Date): string {\n  if (val instanceof Date) return Math.floor(val.getTime() / 1000).toString();\n  if (typeof val === 'number') {\n    // If it's in ms (>= 10^12), convert to s\n    return Math.floor(val > 1e11 ? val / 1000 : val).toString();\n  }\n  if (/^\\d+$/.test(val)) {\n    const num = Number(val);\n    return Math.floor(num > 1e11 ? num / 1000 : num).toString();\n  }\n  const d = new Date(val);\n  return Math.floor(d.getTime() / 1000).toString();\n}\n\nexport async function queryRange(\n  params: LokiQueryRangeParams,\n  options: LokiApiOptions\n): Promise<LokiQueryRangeResponse> {\n  const url = buildUrl('/loki/api/v1/query_range', options.datasourceUrl);\n  url.searchParams.append('query', params.query);\n  url.searchParams.append('start', toUnixSeconds(params.start));\n  url.searchParams.append('end', toUnixSeconds(params.end));\n  if (params.step) url.searchParams.append('step', params.step);\n  if (params.interval) url.searchParams.append('interval', params.interval);\n  if (params.direction) url.searchParams.append('direction', params.direction);\n  if (params.limit) url.searchParams.append('limit', params.limit.toString());\n\n  const response = await fetch(url.toString(), {\n    method: 'GET',\n    headers: {\n      'Content-Type': 'application/json',\n      ...options.headers,\n    },\n  });\n  return response.json();\n}\n\nexport async function labels(\n  start: string | undefined,\n  end: string | undefined,\n  options: LokiApiOptions\n): Promise<LokiLabelsResponse> {\n  const url = buildUrl('/loki/api/v1/labels', options.datasourceUrl);\n  if (start) url.searchParams.append('start', start);\n  if (end) url.searchParams.append('end', end);\n\n  const response = await fetch(url.toString(), {\n    method: 'GET',\n    headers: {\n      'Content-Type': 'application/json',\n      ...options.headers,\n    },\n  });\n  return response.json();\n}\n\nexport async function labelValues(\n  label: string,\n  start: string | undefined,\n  end: string | undefined,\n  options: LokiApiOptions\n): Promise<LokiLabelValuesResponse> {\n  const url = buildUrl(`/loki/api/v1/label/${label}/values`, options.datasourceUrl);\n  if (start) url.searchParams.append('start', start);\n  if (end) url.searchParams.append('end', end);\n\n  const response = await fetch(url.toString(), {\n    method: 'GET',\n    headers: {\n      'Content-Type': 'application/json',\n      ...options.headers,\n    },\n  });\n  return response.json();\n}\n\nexport async function series(\n  match: string[],\n  start: string | undefined,\n  end: string | undefined,\n  options: LokiApiOptions\n): Promise<LokiSeriesResponse> {\n  const url = buildUrl('/loki/api/v1/series', options.datasourceUrl);\n  match.forEach((m) => url.searchParams.append('match[]', m));\n  if (start) url.searchParams.append('start', start);\n  if (end) url.searchParams.append('end', end);\n\n  const response = await fetch(url.toString(), {\n    method: 'GET',\n    headers: {\n      'Content-Type': 'application/json',\n      ...options.headers,\n    },\n  });\n  return response.json();\n}\n\nexport async function volume(params: LokiVolumeParams, options: LokiApiOptions): Promise<LokiVolumeResponse> {\n  const url = buildUrl('/loki/api/v1/index/volume', options.datasourceUrl);\n  url.searchParams.append('query', params.query);\n  url.searchParams.append('start', params.start);\n  url.searchParams.append('end', params.end);\n  if (params.step) url.searchParams.append('step', params.step);\n  if (params.limit) url.searchParams.append('limit', params.limit.toString());\n\n  const response = await fetch(url.toString(), {\n    method: 'GET',\n    headers: {\n      'Content-Type': 'application/json',\n      ...options.headers,\n    },\n  });\n  return response.json();\n}\n\nexport async function volumeRange(params: LokiVolumeParams, options: LokiApiOptions): Promise<LokiVolumeResponse> {\n  const url = buildUrl('/loki/api/v1/index/volume_range', options.datasourceUrl);\n  url.searchParams.append('query', params.query);\n  url.searchParams.append('start', params.start);\n  url.searchParams.append('end', params.end);\n  if (params.step) url.searchParams.append('step', params.step);\n  if (params.limit) url.searchParams.append('limit', params.limit.toString());\n\n  const response = await fetch(url.toString(), {\n    method: 'GET',\n    headers: {\n      'Content-Type': 'application/json',\n      ...options.headers,\n    },\n  });\n  return response.json();\n}\n\nexport async function indexStats(\n  query: string,\n  start: string | undefined,\n  end: string | undefined,\n  options: LokiApiOptions\n): Promise<LokiIndexStatsResponse> {\n  const url = buildUrl('/loki/api/v1/index/stats', options.datasourceUrl);\n  url.searchParams.append('query', query);\n  if (start) url.searchParams.append('start', start);\n  if (end) url.searchParams.append('end', end);\n\n  const response = await fetch(url.toString(), {\n    method: 'GET',\n    headers: {\n      'Content-Type': 'application/json',\n      ...options.headers,\n    },\n  });\n  return response.json();\n}\n"],"names":["query","params","options","url","buildUrl","datasourceUrl","searchParams","append","time","direction","limit","toString","response","fetch","method","headers","json","path","startsWith","URL","fullPath","endsWith","slice","window","location","origin","toUnixSeconds","val","Date","Math","floor","getTime","test","num","Number","d","queryRange","start","end","step","interval","labels","labelValues","label","series","match","forEach","m","volume","volumeRange","indexStats"],"mappings":"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"}
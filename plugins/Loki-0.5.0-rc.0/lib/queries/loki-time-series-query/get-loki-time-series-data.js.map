{"version":3,"sources":["../../../../src/queries/loki-time-series-query/get-loki-time-series-data.ts"],"sourcesContent":["// Copyright 2025 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { TimeSeries, DurationString, parseDurationString } from '@perses-dev/core';\nimport { TimeSeriesQueryPlugin, replaceVariables } from '@perses-dev/plugin-system';\nimport { milliseconds } from 'date-fns';\nimport { LokiClient } from '../../model/loki-client';\nimport { LokiMatrixResult } from '../../model/loki-client-types';\nimport { DEFAULT_DATASOURCE } from '../constants';\nimport { LokiTimeSeriesQuerySpec, LokiTimeSeriesQueryResponse } from './loki-time-series-query-types';\n\nexport type LokiMatrixResponse = {\n  resultType: 'matrix';\n  result: LokiMatrixResult[];\n};\n\n// Constants for Loki step calculation\nconst MAX_LOKI_DATA_POINTS = 10000; // Similar to Prometheus\nconst DEFAULT_MIN_STEP_SECONDS = 15; // 15 seconds default minimum\n\n/**\n * Converts a duration string (like \"15s\", \"1m\") to seconds\n */\nfunction getDurationStringSeconds(durationString?: DurationString): number | undefined {\n  if (!durationString) return undefined;\n\n  const duration = parseDurationString(durationString);\n  const ms = milliseconds(duration);\n  return Math.floor(ms / 1000);\n}\n\n/**\n * Calculates appropriate step for Loki range queries\n */\nfunction getLokiRangeStep(\n  startMs: number,\n  endMs: number,\n  minStepSeconds = DEFAULT_MIN_STEP_SECONDS,\n  suggestedStepMs = 0\n): number {\n  const suggestedStepSeconds = suggestedStepMs / 1000;\n  const queryRangeSeconds = (endMs - startMs) / 1000;\n\n  let safeStep = queryRangeSeconds / MAX_LOKI_DATA_POINTS;\n  if (safeStep > 1) {\n    safeStep = Math.ceil(safeStep);\n  }\n\n  return Math.max(suggestedStepSeconds, minStepSeconds, safeStep);\n}\n\n/**\n * Formats step in seconds as a duration string for Loki API\n */\nfunction formatStepForLoki(stepSeconds: number): string {\n  if (stepSeconds < 60) {\n    return `${Math.round(stepSeconds)}s`;\n  } else if (stepSeconds < 3600) {\n    return `${Math.round(stepSeconds / 60)}m`;\n  } else {\n    return `${Math.round(stepSeconds / 3600)}h`;\n  }\n}\n\nfunction convertMatrixToTimeSeries(matrix: LokiMatrixResult[]): TimeSeries[] {\n  return matrix.map((series) => {\n    const name = Object.entries(series.metric)\n      .map(([k, v]) => `${k}=${v}`)\n      .join(', ');\n    return {\n      name,\n      values: series.values.map(([timestamp, value]) => [\n        Number(timestamp) * 1000, // Convert seconds to milliseconds\n        Number(value),\n      ]),\n      labels: series.metric,\n    };\n  });\n}\n\nexport const getLokiTimeSeriesData: TimeSeriesQueryPlugin<LokiTimeSeriesQuerySpec>['getTimeSeriesData'] = async (\n  spec,\n  context\n) => {\n  if (!spec.query) {\n    return {\n      series: [],\n      timeRange: { start: context.timeRange.start, end: context.timeRange.end },\n      stepMs: DEFAULT_MIN_STEP_SECONDS * 1000,\n    };\n  }\n\n  const query = replaceVariables(spec.query, context.variableState);\n  const client = (await context.datasourceStore.getDatasourceClient<LokiClient>(\n    spec.datasource ?? DEFAULT_DATASOURCE\n  )) as LokiClient;\n\n  const { start, end } = context.timeRange;\n\n  // Calculate proper step using similar logic to Prometheus\n  const minStepSeconds = spec.step\n    ? (getDurationStringSeconds(spec.step as DurationString) ?? DEFAULT_MIN_STEP_SECONDS)\n    : DEFAULT_MIN_STEP_SECONDS;\n  const stepSeconds = getLokiRangeStep(start.getTime(), end.getTime(), minStepSeconds, context.suggestedStepMs);\n  const stepString = formatStepForLoki(stepSeconds);\n  const stepMs = stepSeconds * 1000;\n\n  const response: LokiTimeSeriesQueryResponse = await client.queryRange({\n    query,\n    start: start.getTime().toString(),\n    end: end.getTime().toString(),\n    step: stepString,\n  });\n\n  if (response.data.resultType === 'matrix') {\n    const convertedSeries = convertMatrixToTimeSeries(response.data.result as LokiMatrixResult[]);\n\n    return {\n      series: convertedSeries,\n      timeRange: { start, end },\n      stepMs,\n      metadata: {\n        executedQueryString: query,\n      },\n    };\n  }\n\n  return {\n    series: [],\n    timeRange: { start, end },\n    stepMs,\n  };\n};\n"],"names":["parseDurationString","replaceVariables","milliseconds","DEFAULT_DATASOURCE","MAX_LOKI_DATA_POINTS","DEFAULT_MIN_STEP_SECONDS","getDurationStringSeconds","durationString","undefined","duration","ms","Math","floor","getLokiRangeStep","startMs","endMs","minStepSeconds","suggestedStepMs","suggestedStepSeconds","queryRangeSeconds","safeStep","ceil","max","formatStepForLoki","stepSeconds","round","convertMatrixToTimeSeries","matrix","map","series","name","Object","entries","metric","k","v","join","values","timestamp","value","Number","labels","getLokiTimeSeriesData","spec","context","query","timeRange","start","end","stepMs","variableState","client","datasourceStore","getDatasourceClient","datasource","step","getTime","stepString","response","queryRange","toString","data","resultType","convertedSeries","result","metadata","executedQueryString"],"mappings":"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"}
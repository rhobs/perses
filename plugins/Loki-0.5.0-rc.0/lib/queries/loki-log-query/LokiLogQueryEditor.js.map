{"version":3,"sources":["../../../../src/queries/loki-log-query/LokiLogQueryEditor.tsx"],"sourcesContent":["// Copyright 2025 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {\n  DatasourceSelect,\n  DatasourceSelectProps,\n  isVariableDatasource,\n  OptionsEditorProps,\n  useDatasourceSelectValueToSelector,\n  useDatasourceClient,\n  useTimeRange,\n} from '@perses-dev/plugin-system';\nimport { InputLabel, Stack, ToggleButton, ToggleButtonGroup } from '@mui/material';\nimport { ReactElement, useCallback, useMemo } from 'react';\nimport { produce } from 'immer';\nimport { OptionsEditorControl } from '@perses-dev/components';\nimport { LogQLEditor } from '../../components';\nimport { isDefaultLokiSelector, LOKI_DATASOURCE_KIND, LokiDatasourceSelector, LokiClient } from '../../model';\nimport { DATASOURCE_KIND, DEFAULT_DATASOURCE } from '../constants';\nimport { useQueryState } from '../query-editor-model';\nimport { LokiLogQuerySpec } from './loki-log-query-types';\n\ntype LokiQueryEditorProps = OptionsEditorProps<LokiLogQuerySpec>;\n\nexport function LokiLogQueryEditor(props: LokiQueryEditorProps): ReactElement {\n  const { onChange, value } = props;\n  const { datasource } = value;\n  const datasourceSelectValue = datasource ?? DEFAULT_DATASOURCE;\n  const selectedDatasource = useDatasourceSelectValueToSelector(\n    datasourceSelectValue,\n    LOKI_DATASOURCE_KIND\n  ) as LokiDatasourceSelector;\n  const { query, handleQueryChange, handleQueryBlur } = useQueryState(props);\n\n  // Get client and time range for autocompletion\n  const { data: client } = useDatasourceClient<LokiClient>(selectedDatasource);\n  const { absoluteTimeRange } = useTimeRange();\n\n  // Create completion config for autocompletion\n  const completionConfig = useMemo(() => {\n    if (!client) return undefined;\n    return {\n      client,\n      timeRange: absoluteTimeRange,\n    };\n  }, [client, absoluteTimeRange]);\n\n  const handleDatasourceChange: DatasourceSelectProps['onChange'] = (newDatasourceSelection) => {\n    if (!isVariableDatasource(newDatasourceSelection) && newDatasourceSelection.kind === DATASOURCE_KIND) {\n      onChange(\n        produce(value, (draft) => {\n          // If they're using the default, just omit the datasource prop (i.e. set to undefined)\n          const nextDatasource = isDefaultLokiSelector(newDatasourceSelection) ? undefined : newDatasourceSelection;\n          draft.datasource = nextDatasource;\n        })\n      );\n      return;\n    }\n\n    throw new Error('Got unexpected non LokiQuery datasource selection');\n  };\n\n  const handleLogsDirection = (_: React.MouseEvent, v: 'backward' | 'forward') =>\n    onChange(\n      produce(value, (draft: LokiLogQuerySpec) => {\n        draft.direction = v;\n      })\n    );\n\n  // Immediate query execution on Enter or blur\n  const handleQueryExecute = (query: string) => {\n    onChange(\n      produce(value, (draft) => {\n        draft.query = query;\n      })\n    );\n  };\n\n  const handleLogsQueryChange = useCallback(\n    (e: string) => {\n      handleQueryChange(e);\n    },\n    [handleQueryChange]\n  );\n\n  return (\n    <Stack spacing={1.5} paddingBottom={1}>\n      <div>\n        <InputLabel\n          sx={{\n            display: 'block',\n            marginBottom: '4px',\n            fontWeight: 500,\n          }}\n        >\n          Datasource\n        </InputLabel>\n        <DatasourceSelect\n          datasourcePluginKind={DATASOURCE_KIND}\n          value={selectedDatasource}\n          onChange={handleDatasourceChange}\n          label=\"Loki Datasource\"\n          notched\n        />\n      </div>\n\n      <div>\n        <InputLabel\n          sx={{\n            display: 'block',\n            marginBottom: '4px',\n            fontWeight: 500,\n          }}\n        >\n          LogQL Query\n        </InputLabel>\n        <LogQLEditor\n          value={query}\n          onChange={handleLogsQueryChange}\n          onBlur={handleQueryBlur}\n          onKeyDown={(event) => {\n            if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {\n              event.preventDefault();\n              handleQueryExecute(query);\n            }\n          }}\n          placeholder='Enter LogQL query (e.g. {job=\"mysql\"} |= \"error\")'\n          completionConfig={completionConfig}\n          // height=\"120px\"\n        />\n      </div>\n      <div>\n        <OptionsEditorControl\n          label=\"Order\"\n          // description=\"Percentage means thresholds relative to min & max\"\n          control={\n            <ToggleButtonGroup\n              exclusive\n              value={value?.direction ?? 'backward'}\n              onChange={handleLogsDirection}\n              sx={{ height: '36px', marginLeft: '10px', width: 'max-content' }}\n            >\n              <ToggleButton aria-label=\"backward\" value=\"backward\" sx={{ fontWeight: 500 }}>\n                Newest first\n              </ToggleButton>\n              <ToggleButton aria-label=\"forward\" value=\"forward\" sx={{ fontWeight: 500 }}>\n                Oldest first\n              </ToggleButton>\n            </ToggleButtonGroup>\n          }\n        />\n      </div>\n    </Stack>\n  );\n}\n"],"names":["DatasourceSelect","isVariableDatasource","useDatasourceSelectValueToSelector","useDatasourceClient","useTimeRange","InputLabel","Stack","ToggleButton","ToggleButtonGroup","useCallback","useMemo","produce","OptionsEditorControl","LogQLEditor","isDefaultLokiSelector","LOKI_DATASOURCE_KIND","DATASOURCE_KIND","DEFAULT_DATASOURCE","useQueryState","LokiLogQueryEditor","props","onChange","value","datasource","datasourceSelectValue","selectedDatasource","query","handleQueryChange","handleQueryBlur","data","client","absoluteTimeRange","completionConfig","undefined","timeRange","handleDatasourceChange","newDatasourceSelection","kind","draft","nextDatasource","Error","handleLogsDirection","_","v","direction","handleQueryExecute","handleLogsQueryChange","e","spacing","paddingBottom","div","sx","display","marginBottom","fontWeight","datasourcePluginKind","label","notched","onBlur","onKeyDown","event","key","ctrlKey","metaKey","preventDefault","placeholder","control","exclusive","height","marginLeft","width","aria-label"],"mappings":"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"}
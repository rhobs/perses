{"version":3,"sources":["../../src/DataTable.tsx"],"sourcesContent":["// Copyright 2024 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { Avatar, Box, Chip, Link, Tooltip, Typography, useTheme } from '@mui/material';\nimport {\n  QueryDefinition,\n  ServiceStats,\n  TraceData,\n  TraceSearchResult,\n  formatDuration,\n  msToPrometheusDuration,\n} from '@perses-dev/core';\nimport { PanelData, replaceVariablesInString, useAllVariableValues, useRouterContext } from '@perses-dev/plugin-system';\nimport InformationIcon from 'mdi-material-ui/Information';\nimport { useChartsTheme } from '@perses-dev/components';\nimport { DataGrid, GridColDef } from '@mui/x-data-grid';\nimport { ReactElement, useCallback, useMemo } from 'react';\nimport { getServiceColor } from './utils/utils';\nimport { TraceTableOptions } from './trace-table-model';\n\nconst DATE_FORMATTER = new Intl.DateTimeFormat(undefined, {\n  dateStyle: 'long',\n  timeStyle: 'medium',\n}).format;\nconst UTC_DATE_FORMATTER = new Intl.DateTimeFormat(undefined, {\n  dateStyle: 'long',\n  timeStyle: 'long',\n  timeZone: 'UTC',\n}).format;\n\nexport type TraceLink = (params: { query: QueryDefinition; traceId: string }) => string;\n\nexport interface DataTableProps {\n  options: TraceTableOptions;\n  result: Array<PanelData<TraceData>>;\n}\n\ninterface Row extends TraceSearchResult {\n  traceLink?: string;\n}\n\nexport function DataTable(props: DataTableProps): ReactElement {\n  const { options, result } = props;\n  const muiTheme = useTheme();\n  const chartsTheme = useChartsTheme();\n  const variableValues = useAllVariableValues();\n\n  const paletteMode = options.visual?.palette?.mode;\n  const serviceColorGenerator = useCallback(\n    (serviceName: string) => getServiceColor(muiTheme, chartsTheme, paletteMode, serviceName),\n    [muiTheme, chartsTheme, paletteMode]\n  );\n\n  const rows: Row[] = [];\n  for (const query of result) {\n    const pluginSpec = query.definition.spec.plugin.spec as { datasource?: { name?: string } } | undefined;\n    const datasourceName = pluginSpec?.datasource?.name;\n\n    for (const trace of query.data?.searchResult || []) {\n      const traceLink = options.links?.trace\n        ? replaceVariablesInString(options.links.trace, variableValues, {\n            datasourceName: datasourceName ?? '',\n            traceId: trace.traceId,\n          })\n        : undefined;\n      rows.push({\n        ...trace,\n        traceLink,\n      });\n    }\n  }\n\n  const columns = useMemo<Array<GridColDef<Row>>>(\n    () => [\n      {\n        field: 'name',\n        headerName: 'Trace name',\n        type: 'string',\n        flex: 4,\n        display: 'flex',\n        valueGetter: (_, trace): string => `${trace.rootServiceName}: ${trace.rootTraceName}`,\n        renderCell: ({ row }): ReactElement => (\n          <Box sx={{ my: 1 }}>\n            <TraceName row={row} />\n            <br />\n            {Object.entries(row.serviceStats).map(([serviceName, stats]) => (\n              <ServiceChip\n                key={serviceName}\n                serviceName={serviceName}\n                stats={stats}\n                serviceColor={serviceColorGenerator(serviceName)}\n              />\n            ))}\n          </Box>\n        ),\n      },\n      {\n        field: 'spanCount',\n        headerName: 'Spans',\n        type: 'number',\n        headerAlign: 'left',\n        align: 'left',\n        flex: 2,\n        minWidth: 145,\n        display: 'flex',\n        valueGetter: (_, trace) => Object.values(trace.serviceStats).reduce((acc, val) => acc + val.spanCount, 0),\n        renderCell: ({ row }): ReactElement => {\n          let totalSpanCount = 0;\n          let totalErrorCount = 0;\n          for (const stats of Object.values(row.serviceStats)) {\n            totalSpanCount += stats.spanCount;\n            totalErrorCount += stats.errorCount ?? 0;\n          }\n          return (\n            <>\n              <Typography display=\"inline\">{totalSpanCount} spans</Typography>\n              {totalErrorCount > 0 && (\n                <Chip\n                  label={`${totalErrorCount} error${totalErrorCount === 1 ? '' : 's'}`}\n                  sx={{ marginLeft: '5px' }}\n                  icon={<InformationIcon />}\n                  variant=\"outlined\"\n                  size=\"small\"\n                  color=\"error\"\n                />\n              )}\n            </>\n          );\n        },\n      },\n      {\n        field: 'durationMs',\n        headerName: 'Duration',\n        type: 'number',\n        headerAlign: 'left',\n        align: 'left',\n        flex: 1,\n        minWidth: 70,\n        display: 'flex',\n        renderCell: ({ row }) => (\n          <Typography display=\"inline\">\n            {row.durationMs < 1 ? '<1ms' : formatDuration(msToPrometheusDuration(row.durationMs))}\n          </Typography>\n        ),\n      },\n      {\n        field: 'startTimeUnixMs',\n        headerName: 'Start time',\n        type: 'number',\n        headerAlign: 'left',\n        align: 'left',\n        flex: 3,\n        minWidth: 240,\n        display: 'flex',\n        renderCell: ({ row }) => (\n          <Tooltip title={UTC_DATE_FORMATTER(new Date(row.startTimeUnixMs))} placement=\"top\" arrow>\n            <Typography display=\"inline\" key={`st-${row.traceId}`}>\n              {DATE_FORMATTER(new Date(row.startTimeUnixMs))}\n            </Typography>\n          </Tooltip>\n        ),\n      },\n    ],\n    [serviceColorGenerator]\n  );\n\n  return (\n    <DataGrid\n      sx={{ borderWidth: 0 }}\n      columns={columns}\n      rows={rows}\n      getRowId={(row) => row.traceId}\n      getRowHeight={() => 'auto'}\n      getEstimatedRowHeight={() => 66}\n      disableRowSelectionOnClick={true}\n      pageSizeOptions={[10, 20, 50, 100]}\n      initialState={{\n        pagination: { paginationModel: { pageSize: 20 } },\n        sorting: {\n          sortModel: [{ field: 'startTimeUnixMs', sort: 'desc' }],\n        },\n      }}\n    />\n  );\n}\n\ninterface TraceNameProps {\n  row: Row;\n}\n\nfunction TraceName({ row: trace }: TraceNameProps): ReactElement {\n  const { RouterComponent } = useRouterContext();\n\n  if (RouterComponent && trace.traceLink) {\n    return (\n      <Link variant=\"body1\" color=\"inherit\" underline=\"hover\" component={RouterComponent} to={trace.traceLink}>\n        <strong>{trace.rootServiceName}:</strong> {trace.rootTraceName}\n      </Link>\n    );\n  }\n\n  return (\n    <Typography display=\"inline\">\n      <strong>{trace.rootServiceName}:</strong> {trace.rootTraceName}\n    </Typography>\n  );\n}\n\ninterface ServiceChipProps {\n  serviceName: string;\n  stats: ServiceStats;\n  serviceColor: string;\n}\n\nfunction ServiceChip({ serviceName, stats, serviceColor }: ServiceChipProps): ReactElement {\n  return (\n    <Chip\n      label={serviceName}\n      variant=\"outlined\"\n      size=\"small\"\n      style={{ ['--service-color' as string]: serviceColor }}\n      sx={{ marginTop: '5px', marginRight: '5px', borderColor: 'var(--service-color)' }}\n      avatar={\n        <Avatar\n          sx={{\n            minWidth: 'fit-content', // by default width is fixed to 18px, which is not enough for multi-digit span counts\n            padding: '6px',\n            backgroundColor: 'var(--service-color)',\n            fontSize: '0.65rem',\n            fontWeight: 'bold',\n            textShadow: '0 0 5px #fff',\n          }}\n        >\n          {stats.spanCount}\n        </Avatar>\n      }\n    />\n  );\n}\n"],"names":["Avatar","Box","Chip","Link","Tooltip","Typography","useTheme","formatDuration","msToPrometheusDuration","replaceVariablesInString","useAllVariableValues","useRouterContext","InformationIcon","useChartsTheme","DataGrid","useCallback","useMemo","getServiceColor","DATE_FORMATTER","Intl","DateTimeFormat","undefined","dateStyle","timeStyle","format","UTC_DATE_FORMATTER","timeZone","DataTable","props","options","result","muiTheme","chartsTheme","variableValues","paletteMode","visual","palette","mode","serviceColorGenerator","serviceName","rows","query","pluginSpec","definition","spec","plugin","datasourceName","datasource","name","trace","data","searchResult","traceLink","links","traceId","push","columns","field","headerName","type","flex","display","valueGetter","_","rootServiceName","rootTraceName","renderCell","row","sx","my","TraceName","br","Object","entries","serviceStats","map","stats","ServiceChip","serviceColor","headerAlign","align","minWidth","values","reduce","acc","val","spanCount","totalSpanCount","totalErrorCount","errorCount","label","marginLeft","icon","variant","size","color","durationMs","title","Date","startTimeUnixMs","placement","arrow","borderWidth","getRowId","getRowHeight","getEstimatedRowHeight","disableRowSelectionOnClick","pageSizeOptions","initialState","pagination","paginationModel","pageSize","sorting","sortModel","sort","RouterComponent","underline","component","to","strong","style","marginTop","marginRight","borderColor","avatar","padding","backgroundColor","fontSize","fontWeight","textShadow"],"mappings":"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"}
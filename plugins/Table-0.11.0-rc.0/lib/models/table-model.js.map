{"version":3,"sources":["../../../src/models/table-model.ts"],"sourcesContent":["// Copyright 2024 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { Definition, FormatOptions, Transform, UnknownSpec } from '@perses-dev/core';\nimport { TableDensity, TableCellConfig } from '@perses-dev/components';\nimport { OptionsEditorProps } from '@perses-dev/plugin-system';\nimport React from 'react';\nimport { TextField, Stack, MenuItem, Typography } from '@mui/material';\n\nexport interface ColumnSettings {\n  name: string;\n\n  // Text to display in the header for the column.\n  header?: string;\n  /**\n   * Text to display when hovering over the header text. This can be useful for\n   * providing additional information about the column when you want to keep the\n   * header text relatively short to manage the column width.\n   */\n  headerDescription?: string;\n  /**\n   * Text to display when hovering over a cell. This can be useful for\n   * providing additional information about the column when the content is\n   * ellipsized to fit in the space.\n   */\n  cellDescription?: string;\n\n  /**\n   * Panel plugin to render.\n   * By default, the cells are rendered as text.\n   */\n  plugin?: Definition<UnknownSpec>;\n\n  /** Formatting options. Only applicable if plugin is unset. */\n  format?: FormatOptions;\n\n  // Alignment of the content in the cell.\n  align?: 'left' | 'center' | 'right';\n\n  // When `true`, the column will be sortable.\n  enableSorting?: boolean;\n\n  // Default sort order for the column.\n  sort?: 'asc' | 'desc';\n\n  /**\n   * Width of the column when rendered in a table. It should be a number in pixels\n   * or \"auto\" to allow the table to automatically adjust the width to fill\n   * space.\n   */\n  width?: number | 'auto';\n  // When `true`, the column will not be displayed.\n  hide?: boolean;\n  // Customize cell display based on their value for this specific column.\n  cellSettings?: CellSettings[];\n\n  dataLink?: DataLink;\n}\n\nexport interface DataLink {\n  url: string;\n  title?: string;\n  openNewTab: boolean;\n}\n\nexport interface ValueCondition {\n  kind: 'Value';\n  spec: {\n    value: string;\n  };\n}\n\nexport interface RangeCondition {\n  kind: 'Range';\n  spec: {\n    min?: number;\n    max?: number;\n  };\n}\n\nexport interface RegexCondition {\n  kind: 'Regex';\n  spec: {\n    expr: string;\n  };\n}\n\nexport interface MiscCondition {\n  kind: 'Misc';\n  spec: {\n    value: 'empty' | 'null' | 'NaN' | 'true' | 'false';\n  };\n}\n\nexport type Condition = ValueCondition | RangeCondition | RegexCondition | MiscCondition;\n\nexport interface CellSettings {\n  condition: Condition;\n  text?: string;\n  prefix?: string;\n  suffix?: string;\n  textColor?: `#${string}`;\n  backgroundColor?: `#${string}`;\n}\n\n/**\n * The schema for a Table panel.\n */\nexport interface TableDefinition extends Definition<TableOptions> {\n  kind: 'Table';\n}\n\n/**\n * The Options object type supported by the Table panel plugin.\n */\nexport interface TableOptions {\n  // Change row height.\n  density?: TableDensity;\n  // When set to 'auto', the table will try to automatically adjust the width of columns to fit without overflowing.\n  // Only for column without custom width specified in columnSettings.\n  defaultColumnWidth?: 'auto' | number;\n  // When set to 'auto', the table will calculate the cell height based on the line height of the theme and the density setting of the table.\n  // Only for column without custom height specified in columnSettings.\n  defaultColumnHeight?: 'auto' | number;\n  // When true, columns are hidden by default unless specified in columnSettings.\n  defaultColumnHidden?: boolean;\n  // Enable pagination.\n  pagination?: boolean;\n  // Enable filtering for individual columns.\n  enableFiltering?: boolean;\n  // Customize column display and order them by their index in the array.\n  columnSettings?: ColumnSettings[];\n  // Customize cell display based on their value.\n  cellSettings?: CellSettings[];\n  // Apply transforms to the data before rendering the table.\n  transforms?: Transform[];\n}\n\n/**\n * Creates the initial/empty options for a Table panel.\n */\nexport function createInitialTableOptions(): TableOptions {\n  return {\n    density: 'standard',\n    enableFiltering: true,\n  };\n}\n\nexport type TableSettingsEditorProps = OptionsEditorProps<TableOptions>;\n\n/**\n * Formats the display text and colors based on cell settings\n */\nexport function formatCellDisplay(value: unknown, setting: CellSettings, defaultText?: string): TableCellConfig {\n  const baseText = setting.text || defaultText || String(value);\n  const displayText = `${setting.prefix ?? ''}${baseText}${setting.suffix ?? ''}`;\n  return {\n    text: displayText,\n    textColor: setting.textColor,\n    backgroundColor: setting.backgroundColor,\n  };\n}\n\n/**\n * Evaluates if a condition matches the given value\n */\nexport function evaluateCondition(condition: Condition, value: unknown): boolean {\n  switch (condition.kind) {\n    case 'Value':\n      return condition.spec?.value === String(value);\n\n    case 'Range': {\n      if (Number.isNaN(Number(value))) return false;\n      const numericValue = Number(value);\n\n      // Both min and max defined\n      if (condition.spec?.min !== undefined && condition.spec?.max !== undefined) {\n        return numericValue >= +condition.spec.min && numericValue <= +condition.spec.max;\n      }\n\n      // Only min defined\n      if (condition.spec?.min !== undefined) {\n        return numericValue >= +condition.spec.min;\n      }\n\n      // Only max defined\n      if (condition.spec?.max !== undefined) {\n        return numericValue <= +condition.spec.max;\n      }\n\n      return false;\n    }\n\n    case 'Regex':\n      if (!condition.spec?.expr) return false;\n      try {\n        const regex = new RegExp(condition.spec.expr);\n        return regex.test(String(value));\n      } catch {\n        return false; // Invalid regex\n      }\n\n    case 'Misc':\n      switch (condition.spec?.value) {\n        case 'empty':\n          return value === '';\n        case 'null':\n          return value === null || value === undefined;\n        case 'NaN':\n          return Number.isNaN(value);\n        case 'true':\n          return value === true;\n        case 'false':\n          return value === false;\n        default:\n          return false;\n      }\n\n    default:\n      return false;\n  }\n}\n\n/**\n * Evaluates all conditions and returns the cell config for the first matching condition\n */\nexport function evaluateConditionalFormatting(value: unknown, settings: CellSettings[]): TableCellConfig | undefined {\n  for (const setting of settings) {\n    if (evaluateCondition(setting.condition, value)) {\n      // Handle special default text cases\n      let defaultText: string | undefined;\n      if (setting.condition.kind === 'Misc') {\n        switch (setting.condition.spec?.value) {\n          case 'null':\n            defaultText = 'null';\n            break;\n          case 'NaN':\n            defaultText = 'NaN';\n            break;\n        }\n      }\n\n      return formatCellDisplay(value, setting, defaultText);\n    }\n  }\n\n  return undefined; // No conditions matched\n}\n\n/**\n * Renders the condition editor component for a given condition\n * This function can be used by both CellEditor and ColumnEditor to maintain consistency\n */\nexport function renderConditionEditor(\n  condition: Condition,\n  onChange: (condition: Condition) => void,\n  size: 'small' | 'medium' = 'small'\n): React.ReactElement | null {\n  if (condition.kind === 'Value') {\n    return React.createElement(TextField, {\n      label: 'Value',\n      placeholder: 'Exact value',\n      value: condition.spec?.value ?? '',\n      onChange: (e: { target: { value: string } }) =>\n        onChange({ ...condition, spec: { value: e.target.value } } as ValueCondition),\n      fullWidth: true,\n      size: size,\n    });\n  } else if (condition.kind === 'Range') {\n    return React.createElement(\n      Stack,\n      {\n        gap: 1,\n        direction: 'row',\n      },\n      [\n        React.createElement(TextField, {\n          key: 'min',\n          label: 'From',\n          placeholder: 'Start of range',\n          value: condition.spec?.min ?? '',\n          onChange: (e: { target: { value: string } }) =>\n            onChange({ ...condition, spec: { ...condition.spec, min: +e.target.value } } as RangeCondition),\n          fullWidth: true,\n          size: size,\n        }),\n        React.createElement(TextField, {\n          key: 'max',\n          label: 'To',\n          placeholder: 'End of range (inclusive)',\n          value: condition.spec?.max ?? '',\n          onChange: (e: { target: { value: string } }) =>\n            onChange({ ...condition, spec: { ...condition.spec, max: +e.target.value } } as RangeCondition),\n          fullWidth: true,\n          size: size,\n        }),\n      ]\n    );\n  } else if (condition.kind === 'Regex') {\n    return React.createElement(TextField, {\n      label: 'Regular Expression',\n      placeholder: 'JavaScript regular expression',\n      value: condition.spec?.expr ?? '',\n      onChange: (e: { target: { value: string } }) =>\n        onChange({ ...condition, spec: { expr: e.target.value } } as RegexCondition),\n      fullWidth: true,\n      size: size,\n    });\n  } else if (condition.kind === 'Misc') {\n    const options = [\n      { value: 'empty', label: 'Empty', caption: 'Matches empty string' },\n      { value: 'null', label: 'Null', caption: 'Matches null or undefined' },\n      { value: 'NaN', label: 'NaN', caption: 'Matches Not a Number value' },\n      { value: 'true', label: 'True', caption: 'Matches true boolean' },\n      { value: 'false', label: 'False', caption: 'Matches false boolean' },\n    ];\n\n    return React.createElement(\n      TextField,\n      {\n        select: true,\n        label: 'Value',\n        value: condition.spec?.value ?? '',\n        onChange: (e: { target: { value: string } }) =>\n          onChange({ ...condition, spec: { value: e.target.value } } as MiscCondition),\n        fullWidth: true,\n        size: size,\n      },\n      options.map((option) =>\n        React.createElement(\n          MenuItem,\n          {\n            key: option.value,\n            value: option.value,\n          },\n          React.createElement(Stack, { key: 'stack' }, [\n            React.createElement(Typography, { key: 'title' }, option.label),\n            React.createElement(\n              Typography,\n              {\n                key: 'caption',\n                variant: 'caption',\n              },\n              option.caption\n            ),\n          ])\n        )\n      )\n    );\n  }\n  return null;\n}\n"],"names":["React","TextField","Stack","MenuItem","Typography","createInitialTableOptions","density","enableFiltering","formatCellDisplay","value","setting","defaultText","baseText","text","String","displayText","prefix","suffix","textColor","backgroundColor","evaluateCondition","condition","kind","spec","Number","isNaN","numericValue","min","undefined","max","expr","regex","RegExp","test","evaluateConditionalFormatting","settings","renderConditionEditor","onChange","size","createElement","label","placeholder","e","target","fullWidth","gap","direction","key","options","caption","select","map","option","variant"],"mappings":"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"}
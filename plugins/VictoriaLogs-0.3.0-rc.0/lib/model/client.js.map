{"version":3,"sources":["../../../src/model/client.ts"],"sourcesContent":["// Copyright 2025 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {\n  VictoriaLogsStreamQueryRangeResponse,\n  VictoriaLogsStatsQueryRangeResponse,\n  VictoriaLogsFieldNamesResponse,\n  VictoriaLogsFieldValuesResponse,\n  VictoriaLogsIndexStatsResponse,\n  VictoriaLogsRequestHeaders,\n} from './types';\n\nexport interface VictoriaLogsBaseParams {\n  start: string;\n  end: string;\n}\n\nexport interface VictoriaLogsStreamQueryRangeParams extends VictoriaLogsBaseParams {\n  query: string;\n  limit?: number;\n  offset?: number;\n}\n\nexport interface VictoriaLogsStatsQueryRangeParams extends VictoriaLogsBaseParams {\n  query: string;\n  step?: string;\n}\n\nexport interface VictoriaLogsFieldNamesParams extends VictoriaLogsBaseParams {\n  query: string;\n}\n\nexport interface VictoriaLogsFieldValuesParams extends VictoriaLogsBaseParams {\n  query: string;\n  field: string;\n}\n\nexport interface VictoriaLogsApiOptions {\n  datasourceUrl: string;\n  headers?: VictoriaLogsRequestHeaders;\n}\n\nexport interface VictoriaLogsClient {\n  options: {\n    datasourceUrl: string;\n  };\n  streamQueryRange: (params: VictoriaLogsStreamQueryRangeParams, headers?: VictoriaLogsRequestHeaders) => Promise<VictoriaLogsStreamQueryRangeResponse>;\n  statsQueryRange: (params: VictoriaLogsStatsQueryRangeParams, headers?: VictoriaLogsRequestHeaders) => Promise<VictoriaLogsStatsQueryRangeResponse>;\n  fieldNames: (params: VictoriaLogsFieldNamesParams, headers?: VictoriaLogsRequestHeaders) => Promise<VictoriaLogsFieldNamesResponse>;\n  fieldValues: (params: VictoriaLogsFieldValuesParams, headers?: VictoriaLogsRequestHeaders) => Promise<VictoriaLogsFieldValuesResponse>;\n}\n\nfunction buildUrl(path: string, datasourceUrl: string): URL {\n  if (datasourceUrl.startsWith('http://') || datasourceUrl.startsWith('https://')) {\n    return new URL(path, datasourceUrl);\n  }\n\n  let fullPath = datasourceUrl;\n  // Assume relative path, ensure no double slashes\n  if (datasourceUrl.endsWith('/') && path.startsWith('/')) {\n    fullPath = datasourceUrl + path.slice(1);\n  } else if (!datasourceUrl.endsWith('/') && !path.startsWith('/')) {\n    fullPath = datasourceUrl + '/' + path;\n  } else {\n    fullPath = datasourceUrl + path;\n  }\n\n  return new URL(fullPath, window.location.origin);\n}\n\nexport async function streamQueryRange(\n  params: VictoriaLogsStreamQueryRangeParams,\n  options: VictoriaLogsApiOptions\n): Promise<VictoriaLogsStreamQueryRangeResponse> {\n  const url = buildUrl('/select/logsql/query', options.datasourceUrl);\n  const postData: Record<string, string> = {\n    query: params.query,\n    start: params.start,\n    end: params.end\n  };\n  if (params?.limit) postData['limit'] = params.limit.toString();\n  if (params?.offset) postData['offset'] = params.offset.toString();\n\n  const data = new URLSearchParams(postData).toString();\n  const response = await fetch(url.toString(), {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded',\n      'Accept': 'application/stream+json',\n      ...options.headers,\n    },\n    body: data,\n  });\n  if (response.status !== 200) {\n    throw new Error(await response.text());\n  }\n  const output: VictoriaLogsStreamQueryRangeResponse = [];\n\n  if (!response?.body) return output;\n  const reader = response.body.getReader();\n  const decoder = new TextDecoder(\"utf-8\");\n  let buffer = '';\n\n  while (true) {\n    const { value, done } = await reader.read();\n    if (done) break;\n\n    buffer += decoder.decode(value, { stream: true });\n    let boundary = buffer.indexOf('\\n');\n    while (boundary !== -1) {\n      const line = buffer.slice(0, boundary);\n      buffer = buffer.slice(boundary + 1);\n      output.push(JSON.parse(line));\n      boundary = buffer.indexOf('\\n');\n    }\n  }\n  if (buffer.trim().length > 0) {\n    output.push(JSON.parse(buffer));\n  }\n  return output;\n}\n\nexport async function statsQueryRange(\n  params: VictoriaLogsStatsQueryRangeParams,\n  options: VictoriaLogsApiOptions\n): Promise<VictoriaLogsStatsQueryRangeResponse> {\n  const url = buildUrl('/select/logsql/stats_query_range', options.datasourceUrl);\n  const postData: Record<string, string> = {\n    query: params.query,\n    start: params.start,\n    end: params.end,\n  };\n  if (params?.step) postData['step'] = params.step.toString();\n\n  const data = new URLSearchParams(postData).toString();\n  const response = await fetch(url.toString(), {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded',\n      'Accept': 'application/json',\n      ...options.headers,\n    },\n    body: data,\n  });\n  return await response.json();\n}\n\nexport async function fieldNames(\n  params: VictoriaLogsFieldNamesParams,\n  options: VictoriaLogsApiOptions\n): Promise<VictoriaLogsFieldNamesResponse> {\n  const url = buildUrl('/select/logsql/field_names', options.datasourceUrl);\n  const postData: Record<string, string> = {\n    query: params.query,\n  };\n  if (params.start) postData['start'] = params.start;\n  if (params.end) postData['end'] = params.end;\n\n  const data = new URLSearchParams(postData).toString();\n  const response = await fetch(url.toString(), {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded',\n      'Accept': 'application/json',\n      ...options.headers,\n    },\n    body: data,\n  });\n  return await response.json();\n}\n\nexport async function fieldValues(\n  params: VictoriaLogsFieldValuesParams,\n  options: VictoriaLogsApiOptions\n): Promise<VictoriaLogsFieldValuesResponse> {\n  const url = buildUrl(`/select/logsql/field_values`, options.datasourceUrl);\n  const postData: Record<string, string> = {\n    query: params.query,\n    field: params.field,\n  };\n  if (params.start) postData['start'] = params.start;\n  if (params.end) postData['end'] = params.end;\n\n  const data = new URLSearchParams(postData).toString();\n  const response = await fetch(url.toString(), {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded',\n      'Accept': 'application/json',\n      ...options.headers,\n    },\n    body: data,\n  });\n  return await response.json();\n}\n"],"names":["buildUrl","path","datasourceUrl","startsWith","URL","fullPath","endsWith","slice","window","location","origin","streamQueryRange","params","options","url","postData","query","start","end","limit","toString","offset","data","URLSearchParams","response","fetch","method","headers","body","status","Error","text","output","reader","getReader","decoder","TextDecoder","buffer","value","done","read","decode","stream","boundary","indexOf","line","push","JSON","parse","trim","length","statsQueryRange","step","json","fieldNames","fieldValues","field"],"mappings":"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"}
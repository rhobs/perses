{"version":3,"sources":["../../../../src/variables/victorialogs-field-values/VictoriaLogsFieldValuesVariable.tsx"],"sourcesContent":["import {\n  VariablePlugin,\n  GetVariableOptionsContext,\n  replaceVariables,\n  parseVariables,\n  datasourceSelectValueToSelector,\n  isVariableDatasource,\n} from '@perses-dev/plugin-system';\nimport { VictoriaLogsClient, DEFAULT_VICTORIALOGS, VICTORIALOGS_DATASOURCE_KIND } from '../../model';\nimport { VictoriaLogsFieldValuesVariableEditor } from './VictoriaLogsFieldValuesVariableEditor';\nimport { VictoriaLogsFieldValuesVariableOptions } from '../types';\nimport { fieldItemsToVariableOptions, getVictoriaLogsTimeRange } from '../utils';\n\nexport const VictoriaLogsFieldValuesVariable: VariablePlugin<VictoriaLogsFieldValuesVariableOptions> = {\n  getVariableOptions: async (spec: VictoriaLogsFieldValuesVariableOptions, ctx: GetVariableOptionsContext) => {\n    const datasourceSelector =\n      datasourceSelectValueToSelector(\n        spec.datasource ?? DEFAULT_VICTORIALOGS,\n        ctx.variables,\n        await ctx.datasourceStore.listDatasourceSelectItems(VICTORIALOGS_DATASOURCE_KIND)\n      ) ?? DEFAULT_VICTORIALOGS;\n    const client: VictoriaLogsClient = await ctx.datasourceStore.getDatasourceClient(datasourceSelector);\n    const query = replaceVariables(spec.query, ctx.variables);\n\n    const timeRange = getVictoriaLogsTimeRange(ctx.timeRange);\n\n    const { values } = query ? await client.fieldValues({\n      field: replaceVariables(spec.field, ctx.variables),\n      query: query,\n      ...timeRange,\n    }) : { values: [] };\n    return {\n      data: fieldItemsToVariableOptions(values),\n    };\n  },\n  dependsOn: (spec: VictoriaLogsFieldValuesVariableOptions) => {\n    const queryVariables = parseVariables(spec.query);\n    const labelVariables = parseVariables(spec.field);\n    const datasourceVariables =\n      spec.datasource && isVariableDatasource(spec.datasource) ? parseVariables(spec.datasource) : [];\n    return {\n      variables: [...queryVariables, ...labelVariables, ...datasourceVariables],\n    };\n  },\n  OptionsEditorComponent: VictoriaLogsFieldValuesVariableEditor,\n  createInitialOptions: () => ({ field: '', query: '' }),\n};\n"],"names":["replaceVariables","parseVariables","datasourceSelectValueToSelector","isVariableDatasource","DEFAULT_VICTORIALOGS","VICTORIALOGS_DATASOURCE_KIND","VictoriaLogsFieldValuesVariableEditor","fieldItemsToVariableOptions","getVictoriaLogsTimeRange","VictoriaLogsFieldValuesVariable","getVariableOptions","spec","ctx","datasourceSelector","datasource","variables","datasourceStore","listDatasourceSelectItems","client","getDatasourceClient","query","timeRange","values","fieldValues","field","data","dependsOn","queryVariables","labelVariables","datasourceVariables","OptionsEditorComponent","createInitialOptions"],"mappings":"AAAA,SAGEA,gBAAgB,EAChBC,cAAc,EACdC,+BAA+B,EAC/BC,oBAAoB,QACf,4BAA4B;AACnC,SAA6BC,oBAAoB,EAAEC,4BAA4B,QAAQ,cAAc;AACrG,SAASC,qCAAqC,QAAQ,0CAA0C;AAEhG,SAASC,2BAA2B,EAAEC,wBAAwB,QAAQ,WAAW;AAEjF,OAAO,MAAMC,kCAA0F;IACrGC,oBAAoB,OAAOC,MAA8CC;QACvE,MAAMC,qBACJX,gCACES,KAAKG,UAAU,IAAIV,sBACnBQ,IAAIG,SAAS,EACb,MAAMH,IAAII,eAAe,CAACC,yBAAyB,CAACZ,kCACjDD;QACP,MAAMc,SAA6B,MAAMN,IAAII,eAAe,CAACG,mBAAmB,CAACN;QACjF,MAAMO,QAAQpB,iBAAiBW,KAAKS,KAAK,EAAER,IAAIG,SAAS;QAExD,MAAMM,YAAYb,yBAAyBI,IAAIS,SAAS;QAExD,MAAM,EAAEC,MAAM,EAAE,GAAGF,QAAQ,MAAMF,OAAOK,WAAW,CAAC;YAClDC,OAAOxB,iBAAiBW,KAAKa,KAAK,EAAEZ,IAAIG,SAAS;YACjDK,OAAOA;YACP,GAAGC,SAAS;QACd,KAAK;YAAEC,QAAQ,EAAE;QAAC;QAClB,OAAO;YACLG,MAAMlB,4BAA4Be;QACpC;IACF;IACAI,WAAW,CAACf;QACV,MAAMgB,iBAAiB1B,eAAeU,KAAKS,KAAK;QAChD,MAAMQ,iBAAiB3B,eAAeU,KAAKa,KAAK;QAChD,MAAMK,sBACJlB,KAAKG,UAAU,IAAIX,qBAAqBQ,KAAKG,UAAU,IAAIb,eAAeU,KAAKG,UAAU,IAAI,EAAE;QACjG,OAAO;YACLC,WAAW;mBAAIY;mBAAmBC;mBAAmBC;aAAoB;QAC3E;IACF;IACAC,wBAAwBxB;IACxByB,sBAAsB,IAAO,CAAA;YAAEP,OAAO;YAAIJ,OAAO;QAAG,CAAA;AACtD,EAAE"}
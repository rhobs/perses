{"version":3,"sources":["../../../../src/variables/victorialogs-field-values/VictoriaLogsFieldValuesVariableEditor.tsx"],"sourcesContent":["// Copyright 2025 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\nimport { FormControl, Stack, TextField, Autocomplete } from '@mui/material';\nimport {\n  DatasourceSelect,\n  DatasourceSelectProps,\n  OptionsEditorProps,\n  isVariableDatasource,\n  useDatasourceSelectValueToSelector,\n} from '@perses-dev/plugin-system';\nimport { produce } from 'immer';\nimport { ReactElement, useCallback, useMemo, SyntheticEvent } from 'react';\nimport {\n  DEFAULT_VICTORIALOGS,\n  isDefaultVictoriaLogsSelector,\n  isVictoriaLogsDatasourceSelector,\n  VICTORIALOGS_DATASOURCE_KIND,\n  VictoriaLogsDatasourceSelector,\n} from '../../model';\nimport { VictoriaLogsFieldValuesVariableOptions } from '../types';\nimport { useFieldNames } from '../utils';\n\nexport function VictoriaLogsFieldValuesVariableEditor(\n  props: OptionsEditorProps<VictoriaLogsFieldValuesVariableOptions>\n): ReactElement {\n  const {\n    onChange,\n    value,\n    value: { datasource, query, field },\n  } = props;\n  const datasourceSelectValue = datasource ?? DEFAULT_VICTORIALOGS;\n  const selectedDatasource = useDatasourceSelectValueToSelector(\n    datasourceSelectValue,\n    VICTORIALOGS_DATASOURCE_KIND\n  ) as VictoriaLogsDatasourceSelector;\n  const { data: fieldNames, isLoading: isFieldNamesOptionsLoading } = useFieldNames(query, selectedDatasource);\n  const handleDatasourceChange: DatasourceSelectProps['onChange'] = useCallback(\n    (next) => {\n      if (isVariableDatasource(next) || isVictoriaLogsDatasourceSelector(next)) {\n        onChange(\n          produce(value, (draft) => {\n            // If they're using the default, just omit the datasource prop (i.e. set to undefined)\n            draft.datasource = !isVariableDatasource(next) && isDefaultVictoriaLogsSelector(next) ? undefined : next;\n          })\n        );\n        return;\n      }\n\n      throw new Error('Got unexpected non-VictoriaLogs datasource selector');\n    },\n    [onChange, value]\n  );\n\n  const handleQueryChange = useCallback(\n    (event: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {\n      onChange(\n        produce(value, (draft) => {\n          draft.query = event.target.value;\n        })\n      );\n    },\n    [onChange, value]\n  );\n\n  const handleFieldChange = useCallback(\n    (_: SyntheticEvent, newValue: string | null) => {\n      onChange(\n        produce(value, (draft) => {\n          draft.field = newValue || '';\n        })\n      );\n    },\n    [onChange, value]\n  );\n\n  const fieldNamesOptions = useMemo(() => {\n    return fieldNames?.values.map((o) => o.value) || [];\n  }, [fieldNames]);\n\n  return (\n    <Stack spacing={2}>\n      <FormControl margin=\"dense\">\n        <DatasourceSelect\n          datasourcePluginKind=\"VictoriaLogsDatasource\"\n          value={datasourceSelectValue}\n          onChange={handleDatasourceChange}\n          readOnly={props.isReadonly}\n          labelId=\"victorialogs-datasource-field\"\n          label=\"VictoriaLogs Datasource\"\n        />\n      </FormControl>\n\n      <Autocomplete\n        freeSolo\n        disableClearable\n        value={field}\n        loading={isFieldNamesOptionsLoading}\n        options={fieldNamesOptions}\n        renderInput={(params) => {\n          return <TextField {...params} required label=\"Field Name\" variant=\"outlined\" />;\n        }}\n        onChange={handleFieldChange}\n      />\n      <TextField\n        required\n        label=\"Query\"\n        InputLabelProps={{ shrink: props.isReadonly ? true : undefined }}\n        InputProps={{\n          readOnly: props.isReadonly,\n        }}\n        value={query}\n        onChange={handleQueryChange}\n      />\n    </Stack>\n  );\n}\n"],"names":["FormControl","Stack","TextField","Autocomplete","DatasourceSelect","isVariableDatasource","useDatasourceSelectValueToSelector","produce","useCallback","useMemo","DEFAULT_VICTORIALOGS","isDefaultVictoriaLogsSelector","isVictoriaLogsDatasourceSelector","VICTORIALOGS_DATASOURCE_KIND","useFieldNames","VictoriaLogsFieldValuesVariableEditor","props","onChange","value","datasource","query","field","datasourceSelectValue","selectedDatasource","data","fieldNames","isLoading","isFieldNamesOptionsLoading","handleDatasourceChange","next","draft","undefined","Error","handleQueryChange","event","target","handleFieldChange","_","newValue","fieldNamesOptions","values","map","o","spacing","margin","datasourcePluginKind","readOnly","isReadonly","labelId","label","freeSolo","disableClearable","loading","options","renderInput","params","required","variant","InputLabelProps","shrink","InputProps"],"mappings":";AAAA,oCAAoC;AACpC,kEAAkE;AAClE,mEAAmE;AACnE,0CAA0C;AAC1C,EAAE;AACF,6CAA6C;AAC7C,EAAE;AACF,sEAAsE;AACtE,oEAAoE;AACpE,2EAA2E;AAC3E,sEAAsE;AACtE,iCAAiC;AACjC,SAASA,WAAW,EAAEC,KAAK,EAAEC,SAAS,EAAEC,YAAY,QAAQ,gBAAgB;AAC5E,SACEC,gBAAgB,EAGhBC,oBAAoB,EACpBC,kCAAkC,QAC7B,4BAA4B;AACnC,SAASC,OAAO,QAAQ,QAAQ;AAChC,SAAuBC,WAAW,EAAEC,OAAO,QAAwB,QAAQ;AAC3E,SACEC,oBAAoB,EACpBC,6BAA6B,EAC7BC,gCAAgC,EAChCC,4BAA4B,QAEvB,cAAc;AAErB,SAASC,aAAa,QAAQ,WAAW;AAEzC,OAAO,SAASC,sCACdC,KAAiE;IAEjE,MAAM,EACJC,QAAQ,EACRC,KAAK,EACLA,OAAO,EAAEC,UAAU,EAAEC,KAAK,EAAEC,KAAK,EAAE,EACpC,GAAGL;IACJ,MAAMM,wBAAwBH,cAAcT;IAC5C,MAAMa,qBAAqBjB,mCACzBgB,uBACAT;IAEF,MAAM,EAAEW,MAAMC,UAAU,EAAEC,WAAWC,0BAA0B,EAAE,GAAGb,cAAcM,OAAOG;IACzF,MAAMK,yBAA4DpB,YAChE,CAACqB;QACC,IAAIxB,qBAAqBwB,SAASjB,iCAAiCiB,OAAO;YACxEZ,SACEV,QAAQW,OAAO,CAACY;gBACd,sFAAsF;gBACtFA,MAAMX,UAAU,GAAG,CAACd,qBAAqBwB,SAASlB,8BAA8BkB,QAAQE,YAAYF;YACtG;YAEF;QACF;QAEA,MAAM,IAAIG,MAAM;IAClB,GACA;QAACf;QAAUC;KAAM;IAGnB,MAAMe,oBAAoBzB,YACxB,CAAC0B;QACCjB,SACEV,QAAQW,OAAO,CAACY;YACdA,MAAMV,KAAK,GAAGc,MAAMC,MAAM,CAACjB,KAAK;QAClC;IAEJ,GACA;QAACD;QAAUC;KAAM;IAGnB,MAAMkB,oBAAoB5B,YACxB,CAAC6B,GAAmBC;QAClBrB,SACEV,QAAQW,OAAO,CAACY;YACdA,MAAMT,KAAK,GAAGiB,YAAY;QAC5B;IAEJ,GACA;QAACrB;QAAUC;KAAM;IAGnB,MAAMqB,oBAAoB9B,QAAQ;QAChC,OAAOgB,YAAYe,OAAOC,IAAI,CAACC,IAAMA,EAAExB,KAAK,KAAK,EAAE;IACrD,GAAG;QAACO;KAAW;IAEf,qBACE,MAACxB;QAAM0C,SAAS;;0BACd,KAAC3C;gBAAY4C,QAAO;0BAClB,cAAA,KAACxC;oBACCyC,sBAAqB;oBACrB3B,OAAOI;oBACPL,UAAUW;oBACVkB,UAAU9B,MAAM+B,UAAU;oBAC1BC,SAAQ;oBACRC,OAAM;;;0BAIV,KAAC9C;gBACC+C,QAAQ;gBACRC,gBAAgB;gBAChBjC,OAAOG;gBACP+B,SAASzB;gBACT0B,SAASd;gBACTe,aAAa,CAACC;oBACZ,qBAAO,KAACrD;wBAAW,GAAGqD,MAAM;wBAAEC,QAAQ;wBAACP,OAAM;wBAAaQ,SAAQ;;gBACpE;gBACAxC,UAAUmB;;0BAEZ,KAAClC;gBACCsD,QAAQ;gBACRP,OAAM;gBACNS,iBAAiB;oBAAEC,QAAQ3C,MAAM+B,UAAU,GAAG,OAAOhB;gBAAU;gBAC/D6B,YAAY;oBACVd,UAAU9B,MAAM+B,UAAU;gBAC5B;gBACA7B,OAAOE;gBACPH,UAAUgB;;;;AAIlB"}
{"version":3,"sources":["../../../../src/queries/victorialogs-time-series-query/query.ts"],"sourcesContent":["// Copyright 2025 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { TimeSeries, DurationString, parseDurationString } from '@perses-dev/core';\nimport { TimeSeriesQueryPlugin, replaceVariables } from '@perses-dev/plugin-system';\nimport { milliseconds } from 'date-fns';\nimport { VictoriaLogsClient } from '../../model/client';\nimport { VictoriaLogsStatsQueryRangeResponse } from '../../model/types';\nimport { DEFAULT_DATASOURCE } from '../constants';\nimport { VictoriaLogsTimeSeriesQuerySpec } from './types';\n\nexport type VictoriaLogsMatrixResult = {\n  metric: Record<string, string>;\n  values: Array<[number, string]>;\n};\n\nexport type VictoriaLogsMatrixResponse = {\n  resultType: 'matrix';\n  result: VictoriaLogsMatrixResult[];\n};\n\n// Constants for VictoriaLogs step calculation\nconst MAX_VICTORIALOGS_DATA_POINTS = 10000; // Similar to Prometheus\nconst DEFAULT_MIN_STEP_SECONDS = 15; // 15 seconds default minimum\n\n/**\n * Converts a duration string (like \"15s\", \"1m\") to seconds\n */\nfunction getDurationStringSeconds(durationString?: DurationString): number | undefined {\n  if (!durationString) return undefined;\n\n  const duration = parseDurationString(durationString);\n  const ms = milliseconds(duration);\n  return Math.floor(ms / 1000);\n}\n\n/**\n * Calculates appropriate step for VictoriaLogs range queries\n */\nfunction getVictoriaLogsRangeStep(\n  startMs: number,\n  endMs: number,\n  minStepSeconds = DEFAULT_MIN_STEP_SECONDS,\n  suggestedStepMs = 0\n): number {\n  const suggestedStepSeconds = suggestedStepMs / 1000;\n  const querySeconds = (endMs - startMs) / 1000;\n\n  let safeStep = querySeconds / MAX_VICTORIALOGS_DATA_POINTS;\n  if (safeStep > 1) {\n    safeStep = Math.ceil(safeStep);\n  }\n\n  return Math.max(suggestedStepSeconds, minStepSeconds, safeStep);\n}\n\n/**\n * Formats step in seconds as a duration string for VictoriaLogs API\n */\nfunction formatStepForVictoriaLogs(stepSeconds: number): string {\n  if (stepSeconds < 60) {\n    return `${Math.round(stepSeconds)}s`;\n  } else if (stepSeconds < 3600) {\n    return `${Math.round(stepSeconds / 60)}m`;\n  } else {\n    return `${Math.round(stepSeconds / 3600)}h`;\n  }\n}\n\nfunction convertMatrixToTimeSeries(matrix: VictoriaLogsMatrixResult[]): TimeSeries[] {\n  return matrix.map((series) => {\n    const { _stream, ...labels } = series.metric;\n    if (_stream) {\n      const match = _stream.match(/{([^}]+)}/);\n      if (match && match[1]) {\n        const labelsStr = match[1].split(',').forEach(labelPair => {\n          const [key, val] = labelPair.split('=').map(s => s.trim().replace(/^\"|\"$/g, ''));\n          if (key && val) labels[key] = val;\n        });\n      }\n    }\n    const name = Object.entries(labels)\n      .map(([k, v]) => `${k}=${v}`)\n      .join(', ');\n    return {\n      name: name,\n      values: series.values.map(([timestamp, value]) => [\n        Number(timestamp) * 1000, // Convert seconds to milliseconds\n        Number(value),\n      ]),\n      labels,\n    };\n  });\n}\n\nexport const getVictoriaLogsTimeSeriesData: TimeSeriesQueryPlugin<VictoriaLogsTimeSeriesQuerySpec>['getTimeSeriesData'] = async (\n  spec,\n  context\n) => {\n  if (!spec.query) {\n    return {\n      series: [],\n      timeRange: { start: context.timeRange.start, end: context.timeRange.end },\n      stepMs: DEFAULT_MIN_STEP_SECONDS * 1000,\n    };\n  }\n\n  const query = replaceVariables(spec.query, context.variableState);\n  const client = (await context.datasourceStore.getDatasourceClient<VictoriaLogsClient>(\n    spec.datasource ?? DEFAULT_DATASOURCE\n  )) as VictoriaLogsClient;\n\n  const { start, end } = context.timeRange;\n\n  const minStepSeconds = spec.step\n    ? (getDurationStringSeconds(spec.step as DurationString) ?? DEFAULT_MIN_STEP_SECONDS)\n    : DEFAULT_MIN_STEP_SECONDS;\n  const stepSeconds = getVictoriaLogsRangeStep(start.getTime(), end.getTime(), minStepSeconds, context.suggestedStepMs);\n  const stepString = formatStepForVictoriaLogs(stepSeconds);\n  const stepMs = stepSeconds * 1000;\n\n  const response: VictoriaLogsStatsQueryRangeResponse = await client.statsQueryRange({\n    query,\n    step: stepString,\n    start: start.toISOString(),\n    end: end.toISOString(),\n  });\n\n  if (response.status === 'error') {\n    throw new Error(response.error)\n  }\n\n  const series = convertMatrixToTimeSeries(response.data.result as VictoriaLogsMatrixResult[]);\n\n  return {\n    series: series,\n    timeRange: { start, end },\n    stepMs,\n    metadata: {\n      executedQueryString: query,\n    },\n  };\n};\n"],"names":["parseDurationString","replaceVariables","milliseconds","DEFAULT_DATASOURCE","MAX_VICTORIALOGS_DATA_POINTS","DEFAULT_MIN_STEP_SECONDS","getDurationStringSeconds","durationString","undefined","duration","ms","Math","floor","getVictoriaLogsRangeStep","startMs","endMs","minStepSeconds","suggestedStepMs","suggestedStepSeconds","querySeconds","safeStep","ceil","max","formatStepForVictoriaLogs","stepSeconds","round","convertMatrixToTimeSeries","matrix","map","series","_stream","labels","metric","match","labelsStr","split","forEach","labelPair","key","val","s","trim","replace","name","Object","entries","k","v","join","values","timestamp","value","Number","getVictoriaLogsTimeSeriesData","spec","context","query","timeRange","start","end","stepMs","variableState","client","datasourceStore","getDatasourceClient","datasource","step","getTime","stepString","response","statsQueryRange","toISOString","status","Error","error","data","result","metadata","executedQueryString"],"mappings":"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"}
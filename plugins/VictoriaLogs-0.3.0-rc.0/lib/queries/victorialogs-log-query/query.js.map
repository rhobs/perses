{"version":3,"sources":["../../../../src/queries/victorialogs-log-query/query.ts"],"sourcesContent":["import { replaceVariables } from '@perses-dev/plugin-system';\nimport { VictoriaLogsStreamQueryRangeResponse } from '../../model/types';\nimport { VictoriaLogsClient } from '../../model/client';\nimport { LogEntry, LogData } from '@perses-dev/core';\nimport { DEFAULT_DATASOURCE } from '../constants';\nimport { VictoriaLogsLogQuerySpec } from './types';\nimport { LogQueryPlugin, LogQueryContext } from './interface';\n\nfunction convertStreamToLogs(data: VictoriaLogsStreamQueryRangeResponse, defaultTime: string): LogData {\n  const entries: LogEntry[] = [];\n\n  data.forEach((entry) => {\n    const { _msg, _time, ...labels } = entry;\n    const time = (!_time && !_msg) ? defaultTime : Date.parse(_time);\n    entries.push({\n      timestamp: Number(time) / 1000,\n      line: _msg || \"\",\n      labels: labels,\n    });\n  });\n\n  return {\n    entries,\n    totalCount: entries.length,\n  };\n}\n\nexport const getVictoriaLogsLogData: LogQueryPlugin<VictoriaLogsLogQuerySpec>['getLogData'] = async (\n  spec: VictoriaLogsLogQuerySpec,\n  context: LogQueryContext\n) => {\n  if (!spec.query) {\n    return {\n      logs: { entries: [], totalCount: 0 },\n      timeRange: { start: context.timeRange.start, end: context.timeRange.end },\n    };\n  }\n\n  const query = replaceVariables(spec.query, context.variableState);\n  const client = (await context.datasourceStore.getDatasourceClient<VictoriaLogsClient>(\n    spec.datasource ?? DEFAULT_DATASOURCE\n  )) as VictoriaLogsClient;\n\n  const { start, end } = context.timeRange;\n\n  const response: VictoriaLogsStreamQueryRangeResponse = await client.streamQueryRange({\n    query,\n    start: start.toISOString(),\n    end: end.toISOString(),\n  });\n\n  const logs = convertStreamToLogs(response, end.getTime().toString());\n\n  return {\n    logs,\n    timeRange: { start, end },\n    metadata: {\n      executedQueryString: query,\n    },\n  };\n};\n"],"names":["replaceVariables","DEFAULT_DATASOURCE","convertStreamToLogs","data","defaultTime","entries","forEach","entry","_msg","_time","labels","time","Date","parse","push","timestamp","Number","line","totalCount","length","getVictoriaLogsLogData","spec","context","query","logs","timeRange","start","end","variableState","client","datasourceStore","getDatasourceClient","datasource","response","streamQueryRange","toISOString","getTime","toString","metadata","executedQueryString"],"mappings":"AAAA,SAASA,gBAAgB,QAAQ,4BAA4B;AAI7D,SAASC,kBAAkB,QAAQ,eAAe;AAIlD,SAASC,oBAAoBC,IAA0C,EAAEC,WAAmB;IAC1F,MAAMC,UAAsB,EAAE;IAE9BF,KAAKG,OAAO,CAAC,CAACC;QACZ,MAAM,EAAEC,IAAI,EAAEC,KAAK,EAAE,GAAGC,QAAQ,GAAGH;QACnC,MAAMI,OAAO,AAAC,CAACF,SAAS,CAACD,OAAQJ,cAAcQ,KAAKC,KAAK,CAACJ;QAC1DJ,QAAQS,IAAI,CAAC;YACXC,WAAWC,OAAOL,QAAQ;YAC1BM,MAAMT,QAAQ;YACdE,QAAQA;QACV;IACF;IAEA,OAAO;QACLL;QACAa,YAAYb,QAAQc,MAAM;IAC5B;AACF;AAEA,OAAO,MAAMC,yBAAiF,OAC5FC,MACAC;IAEA,IAAI,CAACD,KAAKE,KAAK,EAAE;QACf,OAAO;YACLC,MAAM;gBAAEnB,SAAS,EAAE;gBAAEa,YAAY;YAAE;YACnCO,WAAW;gBAAEC,OAAOJ,QAAQG,SAAS,CAACC,KAAK;gBAAEC,KAAKL,QAAQG,SAAS,CAACE,GAAG;YAAC;QAC1E;IACF;IAEA,MAAMJ,QAAQvB,iBAAiBqB,KAAKE,KAAK,EAAED,QAAQM,aAAa;IAChE,MAAMC,SAAU,MAAMP,QAAQQ,eAAe,CAACC,mBAAmB,CAC/DV,KAAKW,UAAU,IAAI/B;IAGrB,MAAM,EAAEyB,KAAK,EAAEC,GAAG,EAAE,GAAGL,QAAQG,SAAS;IAExC,MAAMQ,WAAiD,MAAMJ,OAAOK,gBAAgB,CAAC;QACnFX;QACAG,OAAOA,MAAMS,WAAW;QACxBR,KAAKA,IAAIQ,WAAW;IACtB;IAEA,MAAMX,OAAOtB,oBAAoB+B,UAAUN,IAAIS,OAAO,GAAGC,QAAQ;IAEjE,OAAO;QACLb;QACAC,WAAW;YAAEC;YAAOC;QAAI;QACxBW,UAAU;YACRC,qBAAqBhB;QACvB;IACF;AACF,EAAE"}
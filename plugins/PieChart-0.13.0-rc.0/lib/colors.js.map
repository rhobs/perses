{"version":3,"sources":["../../src/colors.ts"],"sourcesContent":["// Copyright 2025 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport ColorHash from 'color-hash';\n\n// Valid hue values are 0 to 360 and can be adjusted to control the generated colors.\n// More info: https://github.com/zenozeng/color-hash#custom-hue\n// Picked min of 20 and max of 360 to exclude common threshold colors (red).\n// Items with \"error\" in them will always be generated as red.\nconst ERROR_HUE_CUTOFF = 20;\nconst colorGenerator = new ColorHash({ hue: { min: ERROR_HUE_CUTOFF, max: 360 } });\nconst redColorGenerator = new ColorHash({ hue: { min: 0, max: ERROR_HUE_CUTOFF } });\n\nexport interface SeriesColorProps {\n  categoricalPalette: string[];\n  muiPrimaryColor: string;\n  seriesName: string;\n}\n\n// Color utility functions\n/**\n * Converts a number to a 2-digit hex string\n */\nfunction toHex(n: number): string {\n  const hex = n.toString(16);\n  return hex.length === 1 ? '0' + hex : hex;\n}\n\n/**\n * Converts a hex color string to RGB values\n */\nfunction hexToRgb(hex: string): { r: number; g: number; b: number } {\n  const cleanHex = hex.replace('#', '');\n  return {\n    r: parseInt(cleanHex.substring(0, 2), 16),\n    g: parseInt(cleanHex.substring(2, 4), 16),\n    b: parseInt(cleanHex.substring(4, 6), 16),\n  };\n}\n\n/**\n * Returns a deterministic number between 0 and 1 for a given string\n */\nfunction stringToSeed(str: string): number {\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = (hash << 5) - hash + char;\n    hash = hash & hash; // Convert to 32-bit integer\n  }\n  // Convert to positive number and normalize to 0-1 range\n  return Math.abs(hash) / 2147483647;\n}\n\n/**\n * Helper function to generate gradient colors for series within a query\n */\nexport function generateGradientColor(baseColor: string, factor: number): string {\n  // Convert hex color to RGB\n  const { r, g, b } = hexToRgb(baseColor);\n\n  const newR = Math.round(r * factor);\n  const newG = Math.round(g * factor);\n  const newB = Math.round(b * factor);\n\n  return `#${toHex(newR)}${toHex(newG)}${toHex(newB)}`;\n}\n\n/**\n * Generates a list of color strings for a given number of series using a categorical palette.\n * When the number of series exceeds the palette size, it cycles through the palette\n * and applies gradients to create visual distinction.\n * @param totalSeries - The total number of series that need colors\n * @param colorPalette - Array of color strings to use as the base palette\n * @returns Array of color strings, one for each series\n */\nexport function getSeriesColor(seriesNames: string[], colorPalette?: string[]): string[] {\n  const totalSeries = seriesNames.length;\n\n  if (totalSeries <= 0) {\n    return [];\n  }\n\n  const colors: string[] = [];\n\n  // undefined palette - default\n  if (colorPalette === undefined) {\n    for (let nameIndex = 0; nameIndex < seriesNames.length; nameIndex++) {\n      const seriesColor = getDefaultSeriesColor({\n        categoricalPalette: ['#ff0000'],\n        muiPrimaryColor: '#ff0000',\n        seriesName: seriesNames[nameIndex] || '',\n      });\n      colors.push(seriesColor);\n    }\n    return colors;\n  }\n\n  // single color palette - generate gradients from that color\n  if (colorPalette.length === 1) {\n    const baseColor = colorPalette[0] ?? '#ff0000';\n    for (let i = 0; i < totalSeries; i++) {\n      if (i === 0) {\n        colors.push(baseColor);\n      } else {\n        const gradientFactor = 1 * ((totalSeries - i) / totalSeries);\n        colors.push(generateGradientColor(baseColor, gradientFactor));\n      }\n    }\n    return colors.sort((a, b) => {\n      const seedA = stringToSeed(seriesNames[colors.indexOf(a)] || 'fallback');\n      const seedB = stringToSeed(seriesNames[colors.indexOf(b)] || 'fallback');\n      return seedA - seedB;\n    });\n  }\n\n  // multi color palette - loops through colors and adds gradient when palette is exhausted\n  for (let i = 0; i < totalSeries; i++) {\n    const color = getColor(colorPalette, i);\n    colors.push(color);\n  }\n\n  if (totalSeries > colorPalette.length) {\n    return colors.sort((a, b) => {\n      const seedA = stringToSeed(seriesNames[colors.indexOf(a)] || 'fallback');\n      const seedB = stringToSeed(seriesNames[colors.indexOf(b)] || 'fallback');\n      return seedA - seedB;\n    });\n  }\n  return colors;\n}\n\n/**\n * Default classical qualitative palette that cycles through the colors array by index.\n * When colors start repeating (after exhausting the palette), applies gradients for distinction.\n */\nexport function getColor(palette: string[], seriesIndex: number): string {\n  // Handle undefined or empty palette\n  if (!palette || palette.length === 0) {\n    return '#ff0000';\n  }\n\n  const paletteTotalColors = palette.length;\n  const paletteIndex = seriesIndex % paletteTotalColors;\n  const baseColor = palette[paletteIndex] ?? '#ff0000';\n\n  // If we haven't exhausted the palette yet, use the original color\n  if (seriesIndex < paletteTotalColors) {\n    return baseColor;\n  }\n\n  // Calculate which \"cycle\" we're in (0 = first repeat, 1 = second repeat, etc.)\n  const cycleNumber = Math.floor(seriesIndex / paletteTotalColors);\n\n  // Apply gradient based on cycle number to create visual distinction\n  const gradientFactor = Math.min(1 - cycleNumber * 0.2, 1);\n  return generateGradientColor(baseColor, gradientFactor);\n}\n\nfunction computeConsistentColor(name: string, error: boolean): string {\n  const [hue, saturation, lightness] = error ? redColorGenerator.hsl(name) : colorGenerator.hsl(name);\n  const saturationPercent = `${(saturation * 100).toFixed(0)}%`;\n  const lightnessPercent = `${(lightness * 100).toFixed(0)}%`;\n  return `hsla(${hue.toFixed(2)},${saturationPercent},${lightnessPercent},0.9)`;\n}\n\n// To check whether a color has already been generated for a given string.\n// TODO: Predefined color aliases will be defined here\nconst colorLookup: Record<string, string> = {};\n\n/**\n * Return a consistent color for (name, error) tuple\n */\nexport function getConsistentColor(name: string, error: boolean): string {\n  const key = `${name}_____${error}`;\n  let value = colorLookup[key];\n  if (!value) {\n    value = computeConsistentColor(name, error);\n    colorLookup[key] = value;\n  }\n  return value;\n}\n\n/*\n * Generate a consistent series name color (if series name includes 'error', it will have a red hue).\n */\nexport function getConsistentSeriesNameColor(inputString: string): string {\n  return getConsistentColor(inputString, inputString.toLowerCase().includes('error'));\n}\n\n/**\n * Get line color as well as color for tooltip and legend, account for whether palette is 'categorical' or 'auto' aka generative\n */\nexport function getDefaultSeriesColor(props: SeriesColorProps): string {\n  const { categoricalPalette, muiPrimaryColor, seriesName } = props;\n\n  // Fallback is unlikely to set unless echarts theme palette in charts theme provider is undefined.\n  const fallbackColor =\n    Array.isArray(categoricalPalette) && categoricalPalette[0]\n      ? (categoricalPalette[0] as string) // Needed since echarts color property isn't always an array.\n      : muiPrimaryColor;\n\n  return getAutoPaletteColor(seriesName, fallbackColor);\n}\n\n/**\n * Get color from generative color palette, this approaches uses series name as the seed and\n * allows for consistent colors across panels (when all panels use this approach).\n */\nexport function getAutoPaletteColor(name: string, fallbackColor: string): string {\n  // corresponds to 'Auto' in palette.kind for generative color palette\n  const generatedColor = getConsistentSeriesNameColor(name);\n  return generatedColor ?? fallbackColor;\n}\n"],"names":["ColorHash","ERROR_HUE_CUTOFF","colorGenerator","hue","min","max","redColorGenerator","toHex","n","hex","toString","length","hexToRgb","cleanHex","replace","r","parseInt","substring","g","b","stringToSeed","str","hash","i","char","charCodeAt","Math","abs","generateGradientColor","baseColor","factor","newR","round","newG","newB","getSeriesColor","seriesNames","colorPalette","totalSeries","colors","undefined","nameIndex","seriesColor","getDefaultSeriesColor","categoricalPalette","muiPrimaryColor","seriesName","push","gradientFactor","sort","a","seedA","indexOf","seedB","color","getColor","palette","seriesIndex","paletteTotalColors","paletteIndex","cycleNumber","floor","computeConsistentColor","name","error","saturation","lightness","hsl","saturationPercent","toFixed","lightnessPercent","colorLookup","getConsistentColor","key","value","getConsistentSeriesNameColor","inputString","toLowerCase","includes","props","fallbackColor","Array","isArray","getAutoPaletteColor","generatedColor"],"mappings":"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"}
{"version":3,"sources":["../../../src/components/DataTable.tsx"],"sourcesContent":["// Copyright 2024 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { ReactElement, ReactNode, useMemo } from 'react';\nimport { Alert, Box, Stack, Table, TableBody, TableCell, TableHead, TableRow, Typography } from '@mui/material';\nimport { TimeSeries, TimeSeriesData, BucketTuple, TimeSeriesHistogramTuple, HistogramValue } from '@perses-dev/core';\nimport { PanelData } from '@perses-dev/plugin-system';\nimport { SeriesName } from './SeriesName';\nimport { EmbeddedPanel } from './EmbeddedPanel';\n\nconst MAX_FORMATTABLE_SERIES = 1000;\n\nexport interface DataTableProps {\n  queryResults: Array<PanelData<TimeSeriesData>>;\n}\n\n/**\n * Designed to display timeseries data in a prometheus like table format.\n * The first column will contain the metric name and label combination, and the second column will contain the values.\n * This is inspired by prometheus DataTable.\n * https://github.com/prometheus/prometheus/blob/2524a915915d7eb1b1207152d2e0ce5771193404/web/ui/react-app/src/pages/graph/DataTable.tsx\n * @param result timeseries query result\n * @constructor\n */\nexport const DataTable = ({ queryResults }: DataTableProps): ReactElement | null => {\n  const series = useMemo(() => queryResults.flatMap((d) => d.data).flatMap((d) => d?.series || []), [queryResults]);\n  const rows = useMemo(() => buildRows(series, queryResults), [series, queryResults]);\n\n  if (!queryResults || !rows?.length) {\n    return (\n      <Box\n        sx={{\n          display: 'flex',\n          justifyContent: 'center',\n          alignItems: 'center',\n          height: '100%',\n        }}\n      >\n        <Typography>No data</Typography>\n      </Box>\n    );\n  }\n\n  return (\n    <>\n      {series.length >= MAX_FORMATTABLE_SERIES && (\n        <Alert severity=\"warning\">\n          Showing more than {MAX_FORMATTABLE_SERIES} series, turning off label formatting for performance reasons.\n        </Alert>\n      )}\n      <Table className=\"data-table\">\n        <TableBody>{rows}</TableBody>\n      </Table>\n    </>\n  );\n};\n\nfunction buildRows(series: TimeSeries[], queryResults: Array<PanelData<TimeSeriesData>>): ReactNode[] {\n  const isFormatted = series.length < MAX_FORMATTABLE_SERIES; // only format series names if we have less than 1000 series for performance reasons\n  return series.map((s, seriesIdx) => {\n    const displayTimeStamps = (s.values?.length ?? 0) > 1;\n    const valuesAndTimes = s.values\n      ? s.values.map((v, valIdx) => {\n          return (\n            <Typography key={valIdx}>\n              {v[1]} {displayTimeStamps && <span>@{v[0]}</span>}\n            </Typography>\n          );\n        })\n      : [];\n\n    let histogramsAndTimes = null;\n    if (s.histograms && s.histograms.length > 0) {\n      // Query results contains multiple series, create a new query result with only the current series\n      const seriesQueryResult: PanelData<TimeSeriesData> = {\n        ...queryResults[0]!,\n        data: {\n          ...queryResults[0]!.data,\n          series: [queryResults[0]!.data.series[seriesIdx]!],\n        },\n      };\n\n      histogramsAndTimes = s.histograms.map((h: TimeSeriesHistogramTuple, hisIdx: number) => {\n        return (\n          <Stack alignItems=\"center\" key={-hisIdx}>\n            <Box width={400} height={200}>\n              <EmbeddedPanel\n                kind=\"HistogramChart\"\n                spec={{ unit: 'decimal', width: 400, height: 200 }}\n                queryResults={[seriesQueryResult]}\n              />\n            </Box>\n            <Stack flexDirection=\"row\" justifyContent=\"space-between\" width=\"100%\">\n              <Typography>Total count: {h[1].count}</Typography>\n              <Typography>Sum: {h[1].sum}</Typography>\n            </Stack>\n            {histogramTable(h[1])}\n          </Stack>\n        );\n      });\n    }\n    return (\n      <TableRow style={{ whiteSpace: 'pre' }} key={seriesIdx}>\n        <TableCell>\n          <SeriesName name={s.name} formattedName={s.formattedName} labels={s.labels} isFormatted={isFormatted} />\n        </TableCell>\n        <TableCell>{s.histograms ? histogramsAndTimes : valuesAndTimes}</TableCell>\n      </TableRow>\n    );\n  });\n}\n\nconst leftDelim = (br: number): string => (br === 3 || br === 1 ? '[' : '(');\nconst rightDelim = (br: number): string => (br === 3 || br === 0 ? ']' : ')');\n\nexport const bucketRangeString = ([boundaryRule, leftBoundary, rightBoundary]: [\n  number,\n  string,\n  string,\n  string,\n]): string => {\n  return `${leftDelim(boundaryRule)}${leftBoundary} -> ${rightBoundary}${rightDelim(boundaryRule)}`;\n};\n\nexport const histogramTable = (h: HistogramValue): ReactNode => (\n  <Table>\n    <TableHead>\n      <TableRow>\n        <TableCell style={{ textAlign: 'center' }} colSpan={2}>\n          Histogram Sample\n        </TableCell>\n      </TableRow>\n    </TableHead>\n    <TableBody>\n      <TableRow>\n        <TableCell>Range</TableCell>\n        <TableCell>Count</TableCell>\n      </TableRow>\n      {h.buckets?.map((b: BucketTuple, i: number) => (\n        <TableRow key={i}>\n          <TableCell>{bucketRangeString(b)}</TableCell>\n          <TableCell>{b[3]}</TableCell>\n        </TableRow>\n      ))}\n    </TableBody>\n  </Table>\n);\n"],"names":["useMemo","Alert","Box","Stack","Table","TableBody","TableCell","TableHead","TableRow","Typography","SeriesName","EmbeddedPanel","MAX_FORMATTABLE_SERIES","DataTable","queryResults","series","flatMap","d","data","rows","buildRows","length","sx","display","justifyContent","alignItems","height","severity","className","isFormatted","map","s","seriesIdx","displayTimeStamps","values","valuesAndTimes","v","valIdx","span","histogramsAndTimes","histograms","seriesQueryResult","h","hisIdx","width","kind","spec","unit","flexDirection","count","sum","histogramTable","style","whiteSpace","name","formattedName","labels","leftDelim","br","rightDelim","bucketRangeString","boundaryRule","leftBoundary","rightBoundary","textAlign","colSpan","buckets","b","i"],"mappings":"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"}
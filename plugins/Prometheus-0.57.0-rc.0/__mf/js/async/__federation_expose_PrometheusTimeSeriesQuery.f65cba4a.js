"use strict";(self.chunk_Prometheus=self.chunk_Prometheus||[]).push([["945"],{70401:function(e,t,a){a.r(t),a.d(t,{PrometheusTimeSeriesQuery:()=>y});var r=a(57744),s=a(69791),l=a(94461),n=a(3412);function u(e,t){let a=[];return Object.keys(e).sort().forEach(r=>{let s=e[r];void 0!==s&&(t?a.push(`"${r}":"${s}"`):a.push(`${r}="${s}"`))}),`{${a.join(",")}}`}function i(e,t,a){let r=function(e){let{removeExprWrap:t}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a="__name__";if(Object.prototype.hasOwnProperty.call(e,a)){let r=u({...e,[a]:void 0},t);return t?`${r}`:`${e[a]}${r}`}return u(e,t)}(t),s=a?a.replace(/\{\{\s*(.+?)\s*\}\}/g,(e,a)=>t[a]??""):r;return{name:r,formattedName:s}}var o=a(68616);let d=async(e,t,a)=>{let u;if(void 0===e.query||null===e.query||""===e.query)return{series:[]};let d=await t.datasourceStore.listDatasourceSelectItems(n.eU),c=(0,r.datasourceSelectValueToSelector)(e.datasource??n.hu,t.variableState,d)??n.hu,p=await t.datasourceStore.getDatasource(c),m=Math.trunc((0,l.milliseconds)((0,s.pW)(p.plugin.spec.scrapeInterval??"1m"))/1e3),h=(0,n.z)((0,r.replaceVariables)(e.minStep,t.variableState))??m,v=(0,n.LY)(t.timeRange),g=(0,n.kG)(v,h,void 0,t.suggestedStepMs),{start:S,end:b}=v,f=60*new Date().getTimezoneOffset(),y=Math.floor((b+f)/g)*g-f;S=Math.floor((S+f)/g)*g-f,(b=y)===S&&(b=S+g,console.warn(`Step (${g}) was larger than the time range! end of time range was set accordingly.`));let w=(0,o.J)(e.query,1e3*h,1e3*g);w=(0,r.replaceVariables)(w,t.variableState);let x=e.seriesNameFormat;x&&(x=(0,r.replaceVariables)(x,t.variableState));let M=await t.datasourceStore.getDatasourceClient(c),j=(u="instant"===t.mode?await M.instantQuery({query:w,time:b},void 0,a):await M.rangeQuery({query:w,start:S,end:b,step:g},void 0,a)).data,C=[];if("success"===u.status){let e=(u.warnings??[])[0]??"";""!==e&&C.push({type:"warning",message:e})}return{timeRange:{start:(0,l.fromUnixTime)(S),end:(0,l.fromUnixTime)(b)},stepMs:1e3*g,series:function(e,t,a){if(!t)return[];let r=t.resultType;switch(r){case"vector":return t.result.map(t=>{let{metric:r,value:s,histogram:l}=t,{name:u,formattedName:o}=i(e,r,a);return l?{name:u,formattedName:o,labels:r,values:[(0,n.lS)([l[0],l[1].sum])],histograms:[l]}:{name:u,formattedName:o,labels:r,values:[(0,n.lS)(s)]}});case"matrix":return t.result.map(t=>{let{metric:r,values:s,histograms:l}=t,{name:u,formattedName:o}=i(e,r,a);return l?{name:u,formattedName:o,labels:r,values:l.map(e=>(0,n.lS)([e[0],e[1].sum])),histograms:l.map(e=>e)}:{name:u,formattedName:o,labels:r,values:s.map(n.lS)}});case"scalar":return function(e,t,a){let{name:r,formattedName:s}=i(e,{},a);return[{name:r,values:[(0,n.lS)(t.result)],formattedName:s}]}(e,t,a);default:return console.warn("Unknown result type",r,t),[]}}(w,j,x),metadata:{notices:C,executedQueryString:w}}};var c=a(62540),p=a(38662),m=a(37266),h=a(315),v=a(67987),g=a(93648),S=a(70451),b=a(75712),f=a(24340);let y={getTimeSeriesData:d,OptionsEditorComponent:function(e){let{onChange:t,value:a,value:{query:s,datasource:l},isReadonly:u}=e,i=l??n.hu,o=(0,m.useId)("prom-datasource-label"),d=(0,r.useDatasourceSelectValueToSelector)(i,n.eU),{data:y}=(0,r.useDatasourceClient)(d),w=null==y?void 0:y.options.datasourceUrl,{data:x}=(0,r.useDatasource)(d),{handleQueryChange:M,handleQueryBlur:j}=function(e){let{onChange:t,value:a}=e,[r,s]=(0,S.useState)(a.query),[l,n]=(0,S.useState)(a.query);return a.query!==l&&(s(a.query),n(a.query)),{query:r,handleQueryChange:e=>{s(e)},handleQueryBlur:()=>{n(r),t((0,p.jM)(a,e=>{e.query=r}))}}}(e),{format:C,handleFormatChange:T,handleFormatBlur:V}=function(e){let{onChange:t,value:a}=e,[r,s]=(0,S.useState)(a.seriesNameFormat),[l,n]=(0,S.useState)(a.seriesNameFormat);return a.seriesNameFormat!==l&&(s(a.seriesNameFormat),n(a.seriesNameFormat)),{format:r,handleFormatChange:e=>{s(e)},handleFormatBlur:()=>{n(r),t((0,p.jM)(a,e=>{e.seriesNameFormat=r}))}}}(e),{minStep:q,handleMinStepChange:O,handleMinStepBlur:D}=function(e){let{onChange:t,value:a}=e,[r,s]=(0,S.useState)(a.minStep),[l,n]=(0,S.useState)(a.minStep);return a.minStep!==l&&(s(a.minStep),n(a.minStep)),{minStep:r,handleMinStepChange:e=>{s(e)},handleMinStepBlur:()=>{n(r),t((0,p.jM)(a,e=>{e.minStep=r}))}}}(e),P=q??(x&&(null==x?void 0:x.plugin.spec).scrapeInterval)??"1m",F=(0,r.useAllVariableValues)(),{absoluteTimeRange:k}=(0,r.useTimeRange)(),$=(0,S.useContext)(b.PanelEditorContext),N=(0,r.useSuggestedStepMs)(null==$?void 0:$.preview.previewPanelWidth),U=(0,S.useMemo)(()=>{try{let e=(0,n.z)((0,r.replaceVariables)(P,F));return void 0!==e?1e3*e:void 0}catch{return}},[F,P]),I=(0,S.useMemo)(()=>{let e=(U??0)/1e3;return 1e3*(0,n.kG)((0,n.LY)(k),e,void 0,N)},[k,U,N]),_=(0,S.useMemo)(()=>U&&I?{minStepMs:U,intervalMs:I}:void 0,[U,I]);return(0,c.jsxs)(h.A,{spacing:2,children:[(0,c.jsx)(v.A,{margin:"dense",fullWidth:!1,children:(0,c.jsx)(r.DatasourceSelect,{datasourcePluginKind:n.eU,value:i,onChange:e=>{if((0,n.ZO)(e))return void t((0,p.jM)(a,t=>{t.datasource=(0,n.do)(e)?void 0:e}));throw Error("Got unexpected non-Prometheus datasource selector")},labelId:o,label:"Prometheus Datasource",notched:!0,readOnly:u})}),(0,c.jsx)(f.T,{completeConfig:{remote:{url:w}},value:s,datasource:d,onChange:M,onBlur:j,isReadOnly:u,treeViewMetadata:_}),(0,c.jsxs)(h.A,{direction:"row",spacing:2,children:[(0,c.jsx)(g.A,{fullWidth:!0,label:"Legend",placeholder:"Example: '{{instance}}' will generate series names like 'webserver-123', 'webserver-456'...",helperText:"Text to be displayed in the legend and the tooltip. Use {{label_name}} to interpolate label values.",value:C??"",onChange:e=>T(e.target.value),onBlur:V,slotProps:{inputLabel:{shrink:!!u||void 0},input:{readOnly:u}}}),(0,c.jsx)(g.A,{label:"Min Step",placeholder:P,helperText:"Lower bound for the step. If not provided, the scrape interval of the datasource is used.",value:q??"",onChange:e=>O(e.target.value?e.target.value:void 0),onBlur:D,sx:{width:"250px"},slotProps:{inputLabel:{shrink:!!u||void 0},input:{readOnly:u}}})]})]})},createInitialOptions:()=>({query:"",datasource:void 0}),dependsOn:e=>({variables:[...new Set([...(0,r.parseVariables)(e.query),...(0,r.parseVariables)(e.seriesNameFormat||""),...(0,r.isVariableDatasource)(e.datasource)?(0,r.parseVariables)(e.datasource??""):[]])]})}}}]);
{"version":3,"sources":["../../../src/components/PromQLEditor.tsx"],"sourcesContent":["// Copyright 2025 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport CodeMirror, { ReactCodeMirrorProps } from '@uiw/react-codemirror';\nimport { PromQLExtension, CompleteConfiguration } from '@prometheus-io/codemirror-promql';\nimport { EditorView } from '@codemirror/view';\nimport { useTheme, CircularProgress, InputLabel, Stack, IconButton, Tooltip } from '@mui/material';\nimport FileTreeIcon from 'mdi-material-ui/FileTree';\nimport { ReactElement, useMemo, useState } from 'react';\nimport { ErrorAlert } from '@perses-dev/components';\nimport CloseIcon from 'mdi-material-ui/Close';\nimport { useReplaceVariablesInString } from '@perses-dev/plugin-system';\nimport { PrometheusDatasourceSelector } from '../model';\nimport { replacePromBuiltinVariables } from '../plugins/prometheus-time-series-query/replace-prom-builtin-variables';\nimport { useParseQuery } from './query';\nimport TreeNode from './TreeNode';\n\nconst treeViewStr = 'Tree View';\nconst treeViewOpenStr = 'Open ' + treeViewStr;\nconst treeViewCloseStr = 'Close ' + treeViewStr;\n\nexport type PromQLEditorProps = {\n  completeConfig: CompleteConfiguration;\n  datasource: PrometheusDatasourceSelector;\n  isReadOnly?: boolean;\n  treeViewMetadata?: {\n    minStepMs: number;\n    intervalMs: number;\n  };\n} & Omit<ReactCodeMirrorProps, 'theme' | 'extensions'>;\n\nexport function PromQLEditor({\n  completeConfig,\n  datasource,\n  isReadOnly,\n  treeViewMetadata,\n  ...rest\n}: PromQLEditorProps): ReactElement {\n  const theme = useTheme();\n\n  const isDarkMode = theme.palette.mode === 'dark';\n  const [isTreeViewVisible, setTreeViewVisible] = useState(false);\n  const readOnly = isReadOnly ?? false;\n\n  const promQLExtension = useMemo(() => {\n    return new PromQLExtension().activateLinter(false).setComplete(completeConfig).asExtension();\n  }, [completeConfig]);\n\n  let queryExpr = useReplaceVariablesInString(rest.value);\n  if (queryExpr && treeViewMetadata) {\n    const { minStepMs, intervalMs } = treeViewMetadata;\n    queryExpr = replacePromBuiltinVariables(queryExpr, minStepMs, intervalMs);\n  }\n\n  const { data: parseQueryResponse, isLoading, error } = useParseQuery(queryExpr ?? '', datasource, isTreeViewVisible);\n\n  const handleShowTreeView = (): void => {\n    setTreeViewVisible(!isTreeViewVisible);\n  };\n\n  return (\n    <Stack position=\"relative\">\n      <InputLabel // reproduce the same kind of input label that regular MUI TextFields have\n        shrink\n        sx={{\n          position: 'absolute',\n          top: '-12px',\n          left: '10px',\n          padding: '0 4px',\n          color: theme.palette.text.primary,\n          zIndex: 1,\n        }}\n      >\n        PromQL Expression\n      </InputLabel>\n      {/* TODO: We need to wait for this to be merged, then we need to add proper e2e for some scenarios */}\n      <CodeMirror\n        data-testid=\"promql_expression_editor\"\n        {...rest}\n        style={{ border: `1px solid ${theme.palette.divider}` }}\n        theme={isDarkMode ? 'dark' : 'light'}\n        readOnly={readOnly}\n        basicSetup={{\n          highlightActiveLine: false,\n          highlightActiveLineGutter: false,\n          foldGutter: false,\n        }}\n        extensions={[\n          EditorView.lineWrapping,\n          promQLExtension,\n          EditorView.theme({\n            '.cm-content': {\n              paddingTop: '8px',\n              paddingBottom: '8px',\n              paddingRight: '40px', // offset for the tree view button\n            },\n          }),\n        ]}\n        placeholder=\"Example: sum(rate(http_requests_total[5m]))\"\n      />\n      {queryExpr && (\n        <>\n          <Tooltip title={isTreeViewVisible ? treeViewCloseStr : treeViewOpenStr}>\n            <IconButton\n              aria-label={isTreeViewVisible ? treeViewCloseStr : treeViewOpenStr}\n              onClick={handleShowTreeView}\n              sx={{ position: 'absolute', right: '5px', top: '5px' }}\n              size=\"small\"\n              key=\"tree-view-button\"\n            >\n              <FileTreeIcon sx={{ fontSize: '18px' }} />\n            </IconButton>\n          </Tooltip>\n          {isTreeViewVisible && (\n            <div style={{ border: `1px solid ${theme.palette.divider}`, position: 'relative' }}>\n              <Tooltip title={treeViewCloseStr}>\n                <IconButton\n                  aria-label={treeViewCloseStr}\n                  onClick={() => setTreeViewVisible(false)}\n                  sx={{ position: 'absolute', top: '5px', right: '5px' }}\n                  size=\"small\"\n                  key=\"tree-view-close-button\"\n                >\n                  <CloseIcon sx={{ fontSize: '18px' }} />\n                </IconButton>\n              </Tooltip>\n              {error ? (\n                // Here the user is able to hide the error alert\n                <ErrorAlert\n                  error={{\n                    name: `${treeViewStr} not available`,\n                    message: error.message,\n                  }}\n                />\n              ) : (\n                <div\n                  style={{\n                    padding: `${theme.spacing(1.5)} ${theme.spacing(1.5)} 0 ${theme.spacing(1.5)}`, // let paddingBottom at 0 because nodes have margin-bottom\n                    overflowX: 'auto',\n                    backgroundColor: theme.palette.background.default,\n                  }}\n                >\n                  {isLoading ? (\n                    <CircularProgress />\n                  ) : parseQueryResponse?.data ? (\n                    <TreeNode node={parseQueryResponse.data} reverse={false} childIdx={0} datasource={datasource} />\n                  ) : null}\n                </div>\n              )}\n            </div>\n          )}\n        </>\n      )}\n    </Stack>\n  );\n}\n"],"names":["CodeMirror","PromQLExtension","EditorView","useTheme","CircularProgress","InputLabel","Stack","IconButton","Tooltip","FileTreeIcon","useMemo","useState","ErrorAlert","CloseIcon","useReplaceVariablesInString","replacePromBuiltinVariables","useParseQuery","TreeNode","treeViewStr","treeViewOpenStr","treeViewCloseStr","PromQLEditor","completeConfig","datasource","isReadOnly","treeViewMetadata","rest","theme","isDarkMode","palette","mode","isTreeViewVisible","setTreeViewVisible","readOnly","promQLExtension","activateLinter","setComplete","asExtension","queryExpr","value","minStepMs","intervalMs","data","parseQueryResponse","isLoading","error","handleShowTreeView","position","shrink","sx","top","left","padding","color","text","primary","zIndex","data-testid","style","border","divider","basicSetup","highlightActiveLine","highlightActiveLineGutter","foldGutter","extensions","lineWrapping","paddingTop","paddingBottom","paddingRight","placeholder","title","aria-label","onClick","right","size","fontSize","div","name","message","spacing","overflowX","backgroundColor","background","default","node","reverse","childIdx"],"mappings":"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"}
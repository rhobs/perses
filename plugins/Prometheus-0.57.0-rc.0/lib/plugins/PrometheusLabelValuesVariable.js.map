{"version":3,"sources":["../../../src/plugins/PrometheusLabelValuesVariable.tsx"],"sourcesContent":["import {\n  VariablePlugin,\n  GetVariableOptionsContext,\n  replaceVariables,\n  parseVariables,\n  datasourceSelectValueToSelector,\n  isVariableDatasource,\n} from '@perses-dev/plugin-system';\nimport { PrometheusClient, DEFAULT_PROM, getPrometheusTimeRange, PROM_DATASOURCE_KIND } from '../model';\nimport { stringArrayToVariableOptions, PrometheusLabelValuesVariableEditor } from './prometheus-variables';\nimport { PrometheusLabelValuesVariableOptions } from './types';\n\nexport const PrometheusLabelValuesVariable: VariablePlugin<PrometheusLabelValuesVariableOptions> = {\n  getVariableOptions: async (spec: PrometheusLabelValuesVariableOptions, ctx: GetVariableOptionsContext) => {\n    const pluginDef = spec;\n    const datasourceSelector =\n      datasourceSelectValueToSelector(\n        spec.datasource ?? DEFAULT_PROM,\n        ctx.variables,\n        await ctx.datasourceStore.listDatasourceSelectItems(PROM_DATASOURCE_KIND)\n      ) ?? DEFAULT_PROM;\n    const client: PrometheusClient = await ctx.datasourceStore.getDatasourceClient(datasourceSelector);\n    const match = pluginDef.matchers ? pluginDef.matchers.map((m) => replaceVariables(m, ctx.variables)) : undefined;\n\n    const timeRange = getPrometheusTimeRange(ctx.timeRange);\n\n    const { data: options } = await client.labelValues({\n      labelName: replaceVariables(pluginDef.labelName, ctx.variables),\n      'match[]': match,\n      ...timeRange,\n    });\n    return {\n      data: stringArrayToVariableOptions(options),\n    };\n  },\n  dependsOn: (spec: PrometheusLabelValuesVariableOptions) => {\n    const matcherVariables = spec.matchers?.map((m) => parseVariables(m)).flat() || [];\n    const labelVariables = parseVariables(spec.labelName);\n    const datasourceVariables =\n      spec.datasource && isVariableDatasource(spec.datasource) ? parseVariables(spec.datasource) : [];\n    return {\n      variables: [...matcherVariables, ...labelVariables, ...datasourceVariables],\n    };\n  },\n  OptionsEditorComponent: PrometheusLabelValuesVariableEditor,\n  createInitialOptions: () => ({ labelName: '' }),\n};\n"],"names":["replaceVariables","parseVariables","datasourceSelectValueToSelector","isVariableDatasource","DEFAULT_PROM","getPrometheusTimeRange","PROM_DATASOURCE_KIND","stringArrayToVariableOptions","PrometheusLabelValuesVariableEditor","PrometheusLabelValuesVariable","getVariableOptions","spec","ctx","pluginDef","datasourceSelector","datasource","variables","datasourceStore","listDatasourceSelectItems","client","getDatasourceClient","match","matchers","map","m","undefined","timeRange","data","options","labelValues","labelName","dependsOn","matcherVariables","flat","labelVariables","datasourceVariables","OptionsEditorComponent","createInitialOptions"],"mappings":"AAAA,SAGEA,gBAAgB,EAChBC,cAAc,EACdC,+BAA+B,EAC/BC,oBAAoB,QACf,4BAA4B;AACnC,SAA2BC,YAAY,EAAEC,sBAAsB,EAAEC,oBAAoB,QAAQ,WAAW;AACxG,SAASC,4BAA4B,EAAEC,mCAAmC,QAAQ,yBAAyB;AAG3G,OAAO,MAAMC,gCAAsF;IACjGC,oBAAoB,OAAOC,MAA4CC;QACrE,MAAMC,YAAYF;QAClB,MAAMG,qBACJZ,gCACES,KAAKI,UAAU,IAAIX,cACnBQ,IAAII,SAAS,EACb,MAAMJ,IAAIK,eAAe,CAACC,yBAAyB,CAACZ,0BACjDF;QACP,MAAMe,SAA2B,MAAMP,IAAIK,eAAe,CAACG,mBAAmB,CAACN;QAC/E,MAAMO,QAAQR,UAAUS,QAAQ,GAAGT,UAAUS,QAAQ,CAACC,GAAG,CAAC,CAACC,IAAMxB,iBAAiBwB,GAAGZ,IAAII,SAAS,KAAKS;QAEvG,MAAMC,YAAYrB,uBAAuBO,IAAIc,SAAS;QAEtD,MAAM,EAAEC,MAAMC,OAAO,EAAE,GAAG,MAAMT,OAAOU,WAAW,CAAC;YACjDC,WAAW9B,iBAAiBa,UAAUiB,SAAS,EAAElB,IAAII,SAAS;YAC9D,WAAWK;YACX,GAAGK,SAAS;QACd;QACA,OAAO;YACLC,MAAMpB,6BAA6BqB;QACrC;IACF;IACAG,WAAW,CAACpB;QACV,MAAMqB,mBAAmBrB,KAAKW,QAAQ,EAAEC,IAAI,CAACC,IAAMvB,eAAeuB,IAAIS,UAAU,EAAE;QAClF,MAAMC,iBAAiBjC,eAAeU,KAAKmB,SAAS;QACpD,MAAMK,sBACJxB,KAAKI,UAAU,IAAIZ,qBAAqBQ,KAAKI,UAAU,IAAId,eAAeU,KAAKI,UAAU,IAAI,EAAE;QACjG,OAAO;YACLC,WAAW;mBAAIgB;mBAAqBE;mBAAmBC;aAAoB;QAC7E;IACF;IACAC,wBAAwB5B;IACxB6B,sBAAsB,IAAO,CAAA;YAAEP,WAAW;QAAG,CAAA;AAC/C,EAAE"}
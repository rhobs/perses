{"version":3,"sources":["../../../src/plugins/PrometheusPromQLVariable.tsx"],"sourcesContent":["import {\n  VariablePlugin,\n  GetVariableOptionsContext,\n  replaceVariables,\n  parseVariables,\n  datasourceSelectValueToSelector,\n  isVariableDatasource,\n} from '@perses-dev/plugin-system';\nimport { PrometheusClient, DEFAULT_PROM, PROM_DATASOURCE_KIND } from '../model';\nimport {\n  capturingMatrix,\n  capturingVector,\n  stringArrayToVariableOptions,\n  PrometheusPromQLVariableEditor,\n} from './prometheus-variables';\nimport { PrometheusPromQLVariableOptions } from './types';\n\nexport const PrometheusPromQLVariable: VariablePlugin<PrometheusPromQLVariableOptions> = {\n  getVariableOptions: async (spec: PrometheusPromQLVariableOptions, ctx: GetVariableOptionsContext) => {\n    const datasourceSelector =\n      datasourceSelectValueToSelector(\n        spec.datasource ?? DEFAULT_PROM,\n        ctx.variables,\n        await ctx.datasourceStore.listDatasourceSelectItems(PROM_DATASOURCE_KIND)\n      ) ?? DEFAULT_PROM;\n    const client: PrometheusClient = await ctx.datasourceStore.getDatasourceClient(datasourceSelector);\n    // TODO we may want to manage a range query as well.\n    const { data: options } = await client.instantQuery({\n      query: replaceVariables(spec.expr, ctx.variables),\n    });\n    const labelName = replaceVariables(spec.labelName, ctx.variables);\n    let values: string[] = [];\n    if (options?.resultType === 'matrix') {\n      values = capturingMatrix(options, labelName);\n    } else if (options?.resultType === 'vector') {\n      values = capturingVector(options, labelName);\n    }\n\n    return {\n      data: stringArrayToVariableOptions(values),\n    };\n  },\n  dependsOn: (spec: PrometheusPromQLVariableOptions) => {\n    const exprVariables = parseVariables(spec.expr);\n    const labelVariables = parseVariables(spec.labelName);\n    const datasourceVariables =\n      spec.datasource && isVariableDatasource(spec.datasource) ? parseVariables(spec.datasource) : [];\n    return { variables: [...exprVariables, ...labelVariables, ...datasourceVariables] };\n  },\n  OptionsEditorComponent: PrometheusPromQLVariableEditor,\n  createInitialOptions: () => ({ expr: '', labelName: '' }),\n};\n"],"names":["replaceVariables","parseVariables","datasourceSelectValueToSelector","isVariableDatasource","DEFAULT_PROM","PROM_DATASOURCE_KIND","capturingMatrix","capturingVector","stringArrayToVariableOptions","PrometheusPromQLVariableEditor","PrometheusPromQLVariable","getVariableOptions","spec","ctx","datasourceSelector","datasource","variables","datasourceStore","listDatasourceSelectItems","client","getDatasourceClient","data","options","instantQuery","query","expr","labelName","values","resultType","dependsOn","exprVariables","labelVariables","datasourceVariables","OptionsEditorComponent","createInitialOptions"],"mappings":"AAAA,SAGEA,gBAAgB,EAChBC,cAAc,EACdC,+BAA+B,EAC/BC,oBAAoB,QACf,4BAA4B;AACnC,SAA2BC,YAAY,EAAEC,oBAAoB,QAAQ,WAAW;AAChF,SACEC,eAAe,EACfC,eAAe,EACfC,4BAA4B,EAC5BC,8BAA8B,QACzB,yBAAyB;AAGhC,OAAO,MAAMC,2BAA4E;IACvFC,oBAAoB,OAAOC,MAAuCC;QAChE,MAAMC,qBACJZ,gCACEU,KAAKG,UAAU,IAAIX,cACnBS,IAAIG,SAAS,EACb,MAAMH,IAAII,eAAe,CAACC,yBAAyB,CAACb,0BACjDD;QACP,MAAMe,SAA2B,MAAMN,IAAII,eAAe,CAACG,mBAAmB,CAACN;QAC/E,oDAAoD;QACpD,MAAM,EAAEO,MAAMC,OAAO,EAAE,GAAG,MAAMH,OAAOI,YAAY,CAAC;YAClDC,OAAOxB,iBAAiBY,KAAKa,IAAI,EAAEZ,IAAIG,SAAS;QAClD;QACA,MAAMU,YAAY1B,iBAAiBY,KAAKc,SAAS,EAAEb,IAAIG,SAAS;QAChE,IAAIW,SAAmB,EAAE;QACzB,IAAIL,SAASM,eAAe,UAAU;YACpCD,SAASrB,gBAAgBgB,SAASI;QACpC,OAAO,IAAIJ,SAASM,eAAe,UAAU;YAC3CD,SAASpB,gBAAgBe,SAASI;QACpC;QAEA,OAAO;YACLL,MAAMb,6BAA6BmB;QACrC;IACF;IACAE,WAAW,CAACjB;QACV,MAAMkB,gBAAgB7B,eAAeW,KAAKa,IAAI;QAC9C,MAAMM,iBAAiB9B,eAAeW,KAAKc,SAAS;QACpD,MAAMM,sBACJpB,KAAKG,UAAU,IAAIZ,qBAAqBS,KAAKG,UAAU,IAAId,eAAeW,KAAKG,UAAU,IAAI,EAAE;QACjG,OAAO;YAAEC,WAAW;mBAAIc;mBAAkBC;mBAAmBC;aAAoB;QAAC;IACpF;IACAC,wBAAwBxB;IACxByB,sBAAsB,IAAO,CAAA;YAAET,MAAM;YAAIC,WAAW;QAAG,CAAA;AACzD,EAAE"}
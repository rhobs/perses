{"version":3,"sources":["../../../src/plugins/prometheus-variables.tsx"],"sourcesContent":["// Copyright 2024 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\nimport { FormControl, Stack, TextField } from '@mui/material';\nimport {\n  DatasourceSelect,\n  DatasourceSelectProps,\n  isVariableDatasource,\n  OptionsEditorProps,\n  useDatasourceClient,\n  useDatasourceSelectValueToSelector,\n  VariableOption,\n} from '@perses-dev/plugin-system';\nimport { produce } from 'immer';\nimport { ReactElement, useCallback, ChangeEvent, FocusEvent } from 'react';\nimport { PromQLEditor } from '../components';\nimport {\n  DEFAULT_PROM,\n  isDefaultPromSelector,\n  isPrometheusDatasourceSelector,\n  MatrixData,\n  PROM_DATASOURCE_KIND,\n  PrometheusClient,\n  PrometheusDatasourceSelector,\n  VectorData,\n} from '../model';\nimport { MatcherEditor } from './MatcherEditor';\nimport {\n  PrometheusLabelNamesVariableOptions,\n  PrometheusLabelValuesVariableOptions,\n  PrometheusPromQLVariableOptions,\n} from './types';\n\nexport function PrometheusLabelValuesVariableEditor(\n  props: OptionsEditorProps<PrometheusLabelValuesVariableOptions>\n): ReactElement {\n  const {\n    onChange,\n    value,\n    value: { datasource },\n  } = props;\n  const selectedDatasource = datasource ?? DEFAULT_PROM;\n\n  const handleDatasourceChange: DatasourceSelectProps['onChange'] = useCallback(\n    (next) => {\n      if (isVariableDatasource(next) || isPrometheusDatasourceSelector(next)) {\n        onChange(\n          produce(value, (draft) => {\n            // If they're using the default, just omit the datasource prop (i.e. set to undefined)\n            draft.datasource = !isVariableDatasource(next) && isDefaultPromSelector(next) ? undefined : next;\n          })\n        );\n        return;\n      }\n\n      throw new Error('Got unexpected non-Prometheus datasource selector');\n    },\n    [onChange, value]\n  );\n\n  const handleLabelChange = useCallback(\n    (e: ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {\n      onChange(\n        produce(value, (draft) => {\n          draft.labelName = e.target.value;\n        })\n      );\n    },\n    [onChange, value]\n  );\n\n  const handleMatchEditorsChange = useCallback(\n    (matchers: string[]) => {\n      onChange(\n        produce(value, (draft) => {\n          draft.matchers = matchers;\n        })\n      );\n    },\n    [onChange, value]\n  );\n\n  return (\n    <Stack spacing={2}>\n      <FormControl margin=\"dense\">\n        <DatasourceSelect\n          datasourcePluginKind=\"PrometheusDatasource\"\n          value={selectedDatasource}\n          onChange={handleDatasourceChange}\n          readOnly={props.isReadonly}\n          labelId=\"prom-datasource-label\"\n          label=\"Prometheus Datasource\"\n        />\n      </FormControl>\n      <TextField\n        label=\"Label Name\"\n        required\n        value={props.value.labelName}\n        onChange={handleLabelChange}\n        slotProps={{\n          input: {\n            readOnly: props.isReadonly,\n          },\n        }}\n      />\n      <MatcherEditor\n        matchers={props.value.matchers ?? []}\n        onChange={handleMatchEditorsChange}\n        isReadonly={props.isReadonly}\n      />\n    </Stack>\n  );\n}\n\nexport function PrometheusLabelNamesVariableEditor(\n  props: OptionsEditorProps<PrometheusLabelNamesVariableOptions>\n): ReactElement {\n  const {\n    onChange,\n    value,\n    value: { datasource },\n  } = props;\n\n  const selectedDatasource = datasource ?? DEFAULT_PROM;\n  const handleDatasourceChange: DatasourceSelectProps['onChange'] = useCallback(\n    (next) => {\n      if (isVariableDatasource(next) || isPrometheusDatasourceSelector(next)) {\n        onChange(\n          produce(value, (draft) => {\n            // If they're using the default, just omit the datasource prop (i.e. set to undefined)\n            draft.datasource = !isVariableDatasource(next) && isDefaultPromSelector(next) ? undefined : next;\n          })\n        );\n        return;\n      }\n\n      throw new Error('Got unexpected non-Prometheus datasource selector');\n    },\n    [onChange, value]\n  );\n\n  const handleMatchEditorChange = useCallback(\n    (matchers: string[]) => {\n      onChange(\n        produce(value, (draft) => {\n          draft.matchers = matchers;\n        })\n      );\n    },\n    [onChange, value]\n  );\n\n  return (\n    <Stack spacing={2}>\n      <FormControl margin=\"dense\">\n        <DatasourceSelect\n          datasourcePluginKind=\"PrometheusDatasource\"\n          value={selectedDatasource}\n          onChange={handleDatasourceChange}\n          disabled={props.isReadonly}\n          labelId=\"prom-datasource-label\"\n          label=\"Prometheus Datasource\"\n        />\n      </FormControl>\n      <MatcherEditor\n        matchers={props.value.matchers ?? []}\n        isReadonly={props.isReadonly}\n        onChange={handleMatchEditorChange}\n      />\n    </Stack>\n  );\n}\n\nexport function PrometheusPromQLVariableEditor(\n  props: OptionsEditorProps<PrometheusPromQLVariableOptions>\n): ReactElement {\n  const {\n    onChange,\n    value,\n    value: { datasource },\n  } = props;\n  const datasourceSelectValue = datasource ?? DEFAULT_PROM;\n  const selectedDatasource = useDatasourceSelectValueToSelector(\n    datasourceSelectValue,\n    PROM_DATASOURCE_KIND\n  ) as PrometheusDatasourceSelector;\n\n  const { data: client } = useDatasourceClient<PrometheusClient>(selectedDatasource);\n  const promURL = client?.options.datasourceUrl;\n  const handleDatasourceChange: DatasourceSelectProps['onChange'] = useCallback(\n    (next) => {\n      if (isVariableDatasource(next) || isPrometheusDatasourceSelector(next)) {\n        onChange(\n          produce(value, (draft) => {\n            // If they're using the default, just omit the datasource prop (i.e. set to undefined)\n            draft.datasource = !isVariableDatasource(next) && isDefaultPromSelector(next) ? undefined : next;\n          })\n        );\n        return;\n      }\n\n      throw new Error('Got unexpected non-Prometheus datasource selector');\n    },\n    [value, onChange]\n  );\n\n  const handleOnBlurPromQlChange = useCallback(\n    (e: FocusEvent<HTMLDivElement>) => {\n      onChange(\n        produce(value, (draft) => {\n          draft.expr = e.target.textContent ?? '';\n        })\n      );\n    },\n    [onChange, value]\n  );\n\n  const handleLabelNameChange = useCallback(\n    (e: ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {\n      onChange(\n        produce(value, (draft) => {\n          draft.labelName = e.target.value;\n        })\n      );\n    },\n    [onChange, value]\n  );\n\n  return (\n    <Stack spacing={2}>\n      <FormControl margin=\"dense\">\n        <DatasourceSelect\n          datasourcePluginKind={PROM_DATASOURCE_KIND}\n          value={datasourceSelectValue}\n          onChange={handleDatasourceChange}\n          labelId=\"prom-datasource-label\"\n          label=\"Prometheus Datasource\"\n          disabled={props.isReadonly}\n        />\n      </FormControl>\n      <PromQLEditor\n        completeConfig={{ remote: { url: promURL } }}\n        value={value.expr}\n        datasource={selectedDatasource}\n        onBlur={handleOnBlurPromQlChange}\n        readOnly={props.isReadonly}\n        width=\"100%\"\n      />\n      <TextField\n        label=\"Label Name\"\n        required\n        value={props.value.labelName}\n        slotProps={{\n          input: {\n            readOnly: props.isReadonly,\n          },\n        }}\n        onChange={handleLabelNameChange}\n      />\n    </Stack>\n  );\n}\n\nexport function capturingMatrix(matrix: MatrixData, labelName: string): string[] {\n  const captured = new Set<string>();\n  for (const sample of matrix.result) {\n    const value = sample.metric[labelName];\n    if (value !== undefined) {\n      captured.add(value);\n    }\n  }\n  return Array.from(captured.values());\n}\n\nexport function capturingVector(vector: VectorData, labelName: string): string[] {\n  const captured = new Set<string>();\n  for (const sample of vector.result) {\n    const value = sample.metric[labelName];\n    if (value !== undefined) {\n      captured.add(value);\n    }\n  }\n  return Array.from(captured.values());\n}\n\n/**\n * Takes a list of strings and returns a list of VariableOptions\n */\nexport const stringArrayToVariableOptions = (values?: string[]): VariableOption[] => {\n  if (!values) return [];\n  return values.map((value) => ({\n    value,\n    label: value,\n  }));\n};\n"],"names":["FormControl","Stack","TextField","DatasourceSelect","isVariableDatasource","useDatasourceClient","useDatasourceSelectValueToSelector","produce","useCallback","PromQLEditor","DEFAULT_PROM","isDefaultPromSelector","isPrometheusDatasourceSelector","PROM_DATASOURCE_KIND","MatcherEditor","PrometheusLabelValuesVariableEditor","props","onChange","value","datasource","selectedDatasource","handleDatasourceChange","next","draft","undefined","Error","handleLabelChange","e","labelName","target","handleMatchEditorsChange","matchers","spacing","margin","datasourcePluginKind","readOnly","isReadonly","labelId","label","required","slotProps","input","PrometheusLabelNamesVariableEditor","handleMatchEditorChange","disabled","PrometheusPromQLVariableEditor","datasourceSelectValue","data","client","promURL","options","datasourceUrl","handleOnBlurPromQlChange","expr","textContent","handleLabelNameChange","completeConfig","remote","url","onBlur","width","capturingMatrix","matrix","captured","Set","sample","result","metric","add","Array","from","values","capturingVector","vector","stringArrayToVariableOptions","map"],"mappings":"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"}
{"version":3,"sources":["../../../src/plugins/PrometheusLabelNamesVariable.tsx"],"sourcesContent":["import {\n  VariablePlugin,\n  GetVariableOptionsContext,\n  replaceVariables,\n  parseVariables,\n  datasourceSelectValueToSelector,\n  isVariableDatasource,\n} from '@perses-dev/plugin-system';\nimport { PrometheusClient, DEFAULT_PROM, getPrometheusTimeRange, PROM_DATASOURCE_KIND } from '../model';\nimport { stringArrayToVariableOptions, PrometheusLabelNamesVariableEditor } from './prometheus-variables';\nimport { PrometheusLabelNamesVariableOptions } from './types';\n\nexport const PrometheusLabelNamesVariable: VariablePlugin<PrometheusLabelNamesVariableOptions> = {\n  getVariableOptions: async (spec: PrometheusLabelNamesVariableOptions, ctx: GetVariableOptionsContext) => {\n    const datasourceSelector =\n      datasourceSelectValueToSelector(\n        spec.datasource ?? DEFAULT_PROM,\n        ctx.variables,\n        await ctx.datasourceStore.listDatasourceSelectItems(PROM_DATASOURCE_KIND)\n      ) ?? DEFAULT_PROM;\n    const client: PrometheusClient = await ctx.datasourceStore.getDatasourceClient(datasourceSelector);\n    const match = spec.matchers ? spec.matchers.map((m) => replaceVariables(m, ctx.variables)) : undefined;\n    const timeRange = getPrometheusTimeRange(ctx.timeRange);\n\n    const { data: options } = await client.labelNames({ 'match[]': match, ...timeRange });\n    return {\n      data: stringArrayToVariableOptions(options),\n    };\n  },\n  dependsOn: (spec: PrometheusLabelNamesVariableOptions) => {\n    const matcherVariables = spec.matchers?.map((m) => parseVariables(m)).flat() || [];\n    const datasourceVariables =\n      spec.datasource && isVariableDatasource(spec.datasource) ? parseVariables(spec.datasource) : [];\n    return { variables: [...matcherVariables, ...datasourceVariables] };\n  },\n  OptionsEditorComponent: PrometheusLabelNamesVariableEditor,\n  createInitialOptions: () => ({}),\n};\n"],"names":["replaceVariables","parseVariables","datasourceSelectValueToSelector","isVariableDatasource","DEFAULT_PROM","getPrometheusTimeRange","PROM_DATASOURCE_KIND","stringArrayToVariableOptions","PrometheusLabelNamesVariableEditor","PrometheusLabelNamesVariable","getVariableOptions","spec","ctx","datasourceSelector","datasource","variables","datasourceStore","listDatasourceSelectItems","client","getDatasourceClient","match","matchers","map","m","undefined","timeRange","data","options","labelNames","dependsOn","matcherVariables","flat","datasourceVariables","OptionsEditorComponent","createInitialOptions"],"mappings":"AAAA,SAGEA,gBAAgB,EAChBC,cAAc,EACdC,+BAA+B,EAC/BC,oBAAoB,QACf,4BAA4B;AACnC,SAA2BC,YAAY,EAAEC,sBAAsB,EAAEC,oBAAoB,QAAQ,WAAW;AACxG,SAASC,4BAA4B,EAAEC,kCAAkC,QAAQ,yBAAyB;AAG1G,OAAO,MAAMC,+BAAoF;IAC/FC,oBAAoB,OAAOC,MAA2CC;QACpE,MAAMC,qBACJX,gCACES,KAAKG,UAAU,IAAIV,cACnBQ,IAAIG,SAAS,EACb,MAAMH,IAAII,eAAe,CAACC,yBAAyB,CAACX,0BACjDF;QACP,MAAMc,SAA2B,MAAMN,IAAII,eAAe,CAACG,mBAAmB,CAACN;QAC/E,MAAMO,QAAQT,KAAKU,QAAQ,GAAGV,KAAKU,QAAQ,CAACC,GAAG,CAAC,CAACC,IAAMvB,iBAAiBuB,GAAGX,IAAIG,SAAS,KAAKS;QAC7F,MAAMC,YAAYpB,uBAAuBO,IAAIa,SAAS;QAEtD,MAAM,EAAEC,MAAMC,OAAO,EAAE,GAAG,MAAMT,OAAOU,UAAU,CAAC;YAAE,WAAWR;YAAO,GAAGK,SAAS;QAAC;QACnF,OAAO;YACLC,MAAMnB,6BAA6BoB;QACrC;IACF;IACAE,WAAW,CAAClB;QACV,MAAMmB,mBAAmBnB,KAAKU,QAAQ,EAAEC,IAAI,CAACC,IAAMtB,eAAesB,IAAIQ,UAAU,EAAE;QAClF,MAAMC,sBACJrB,KAAKG,UAAU,IAAIX,qBAAqBQ,KAAKG,UAAU,IAAIb,eAAeU,KAAKG,UAAU,IAAI,EAAE;QACjG,OAAO;YAAEC,WAAW;mBAAIe;mBAAqBE;aAAoB;QAAC;IACpE;IACAC,wBAAwBzB;IACxB0B,sBAAsB,IAAO,CAAA,CAAC,CAAA;AAChC,EAAE"}
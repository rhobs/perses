{"version":3,"sources":["../../../src/plugins/PrometheusDatasourceEditor.tsx"],"sourcesContent":["// Copyright 2023 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { DurationString } from '@perses-dev/core';\nimport { HTTPSettingsEditor } from '@perses-dev/plugin-system';\nimport { Box, TextField, Typography, IconButton } from '@mui/material';\nimport PlusIcon from 'mdi-material-ui/Plus';\nimport MinusIcon from 'mdi-material-ui/Minus';\nimport React, { ReactElement, useState, useRef } from 'react';\nimport { DEFAULT_SCRAPE_INTERVAL, PrometheusDatasourceSpec } from './types';\n\ninterface QueryParamEntry {\n  // Unique identifier for the entry, added to avoid using array index as key\n  id: string;\n  key: string;\n  value: string;\n}\n\nexport interface PrometheusDatasourceEditorProps {\n  value: PrometheusDatasourceSpec;\n  onChange: (next: PrometheusDatasourceSpec) => void;\n  isReadonly?: boolean;\n}\n\nexport function PrometheusDatasourceEditor(props: PrometheusDatasourceEditorProps): ReactElement {\n  const { value, onChange, isReadonly } = props;\n\n  // Counter for generating unique IDs\n  const nextIdRef = useRef(0);\n\n  // Use local state to maintain an array of entries during editing, instead of\n  // manipulating a map directly which causes weird UX.\n  const [entries, setEntries] = useState<QueryParamEntry[]>(() => {\n    const queryParams = value.queryParams ?? {};\n    return Object.entries(queryParams).map(([key, value]) => ({\n      id: String(nextIdRef.current++),\n      key,\n      value,\n    }));\n  });\n\n  // Check for duplicate keys\n  const keyMap = new Map<string, number>();\n  const duplicateKeys = new Set<string>();\n  entries.forEach(({ key }) => {\n    if (key !== '') {\n      const count = (keyMap.get(key) || 0) + 1;\n      keyMap.set(key, count);\n      if (count > 1) {\n        duplicateKeys.add(key);\n      }\n    }\n  });\n  const hasDuplicates = duplicateKeys.size > 0;\n\n  // Convert entries array to object and trigger onChange\n  const syncToParent = (newEntries: QueryParamEntry[]) => {\n    const newParams: Record<string, string> = {};\n    newEntries.forEach(({ key, value }) => {\n      if (key !== '') {\n        newParams[key] = value;\n      }\n    });\n\n    onChange({\n      ...value,\n      queryParams: Object.keys(newParams).length > 0 ? newParams : undefined,\n    });\n  };\n\n  const handleQueryParamChange = (id: string, field: 'key' | 'value', newValue: string) => {\n    const newEntries = entries.map((entry) => {\n      if (entry.id !== id) return entry;\n      return field === 'key' ? { ...entry, key: newValue } : { ...entry, value: newValue };\n    });\n    setEntries(newEntries);\n    syncToParent(newEntries);\n  };\n\n  const addQueryParam = () => {\n    const newEntries = [...entries, { id: String(nextIdRef.current++), key: '', value: '' }];\n    setEntries(newEntries);\n    syncToParent(newEntries);\n  };\n\n  const removeQueryParam = (id: string) => {\n    const newEntries = entries.filter((entry) => entry.id !== id);\n    setEntries(newEntries);\n    syncToParent(newEntries);\n  };\n\n  const initialSpecDirect: PrometheusDatasourceSpec = {\n    directUrl: '',\n  };\n\n  const initialSpecProxy: PrometheusDatasourceSpec = {\n    proxy: {\n      kind: 'HTTPProxy',\n      spec: {\n        allowedEndpoints: [\n          // list of standard endpoints suggested by default\n          {\n            endpointPattern: '/api/v1/labels',\n            method: 'POST',\n          },\n          {\n            endpointPattern: '/api/v1/series',\n            method: 'POST',\n          },\n          {\n            endpointPattern: '/api/v1/metadata',\n            method: 'GET',\n          },\n          {\n            endpointPattern: '/api/v1/query',\n            method: 'POST',\n          },\n          {\n            endpointPattern: '/api/v1/query_range',\n            method: 'POST',\n          },\n          {\n            endpointPattern: '/api/v1/label/([a-zA-Z0-9_-]+)/values',\n            method: 'GET',\n          },\n          {\n            endpointPattern: '/api/v1/parse_query',\n            method: 'POST',\n          },\n        ],\n        url: '',\n      },\n    },\n  };\n\n  return (\n    <>\n      <Typography variant=\"h4\" mb={2}>\n        General Settings\n      </Typography>\n      <TextField\n        size=\"small\"\n        fullWidth\n        label=\"Scrape Interval\"\n        value={value.scrapeInterval || ''}\n        placeholder={`Default: ${DEFAULT_SCRAPE_INTERVAL}`}\n        InputProps={{\n          readOnly: isReadonly,\n        }}\n        InputLabelProps={{ shrink: isReadonly ? true : undefined }}\n        onChange={(e) => onChange({ ...value, scrapeInterval: e.target.value as DurationString })}\n        helperText=\"Set it to match the typical scrape interval used in your Prometheus instance.\"\n      />\n      <HTTPSettingsEditor\n        value={value}\n        onChange={onChange}\n        isReadonly={isReadonly}\n        initialSpecDirect={initialSpecDirect}\n        initialSpecProxy={initialSpecProxy}\n      />\n      <Typography variant=\"h5\" mt={2} mb={1}>\n        Query Parameters\n      </Typography>\n      {entries.length > 0 && (\n        <>\n          {entries.map((entry) => (\n            <Box key={entry.id} display=\"flex\" alignItems=\"center\" gap={2} mb={1}>\n              <TextField\n                size=\"small\"\n                label=\"Key\"\n                value={entry.key}\n                placeholder=\"Parameter name\"\n                disabled={isReadonly}\n                onChange={(e) => handleQueryParamChange(entry.id, 'key', e.target.value)}\n                error={duplicateKeys.has(entry.key)}\n                sx={{ minWidth: 150 }}\n              />\n              <TextField\n                size=\"small\"\n                label=\"Value\"\n                value={entry.value}\n                placeholder=\"Parameter value\"\n                disabled={isReadonly}\n                onChange={(e) => handleQueryParamChange(entry.id, 'value', e.target.value)}\n                sx={{ minWidth: 150, flexGrow: 1 }}\n              />\n              {!isReadonly && (\n                <IconButton onClick={() => removeQueryParam(entry.id)}>\n                  <MinusIcon />\n                </IconButton>\n              )}\n            </Box>\n          ))}\n        </>\n      )}\n      {hasDuplicates && (\n        <Typography variant=\"body2\" color=\"error\" mb={1}>\n          Duplicate parameter keys detected. Each key must be unique.\n        </Typography>\n      )}\n      {entries.length === 0 && (\n        <Typography variant=\"body2\" color=\"textSecondary\">\n          No query parameters configured. Use query parameters to pass additional options to Prometheus (e.g.,\n          dedup=false for Thanos).\n        </Typography>\n      )}\n      {!isReadonly && (\n        <IconButton onClick={addQueryParam}>\n          <PlusIcon />\n        </IconButton>\n      )}\n    </>\n  );\n}\n"],"names":["HTTPSettingsEditor","Box","TextField","Typography","IconButton","PlusIcon","MinusIcon","React","useState","useRef","DEFAULT_SCRAPE_INTERVAL","PrometheusDatasourceEditor","props","value","onChange","isReadonly","nextIdRef","entries","setEntries","queryParams","Object","map","key","id","String","current","keyMap","Map","duplicateKeys","Set","forEach","count","get","set","add","hasDuplicates","size","syncToParent","newEntries","newParams","keys","length","undefined","handleQueryParamChange","field","newValue","entry","addQueryParam","removeQueryParam","filter","initialSpecDirect","directUrl","initialSpecProxy","proxy","kind","spec","allowedEndpoints","endpointPattern","method","url","variant","mb","fullWidth","label","scrapeInterval","placeholder","InputProps","readOnly","InputLabelProps","shrink","e","target","helperText","mt","display","alignItems","gap","disabled","error","has","sx","minWidth","flexGrow","onClick","color"],"mappings":"AAAA,oCAAoC;AACpC,kEAAkE;AAClE,mEAAmE;AACnE,0CAA0C;AAC1C,EAAE;AACF,6CAA6C;AAC7C,EAAE;AACF,sEAAsE;AACtE,oEAAoE;AACpE,2EAA2E;AAC3E,sEAAsE;AACtE,iCAAiC;;AAGjC,SAASA,kBAAkB,QAAQ,4BAA4B;AAC/D,SAASC,GAAG,EAAEC,SAAS,EAAEC,UAAU,EAAEC,UAAU,QAAQ,gBAAgB;AACvE,OAAOC,cAAc,uBAAuB;AAC5C,OAAOC,eAAe,wBAAwB;AAC9C,OAAOC,SAAuBC,QAAQ,EAAEC,MAAM,QAAQ,QAAQ;AAC9D,SAASC,uBAAuB,QAAkC,UAAU;AAe5E,OAAO,SAASC,2BAA2BC,KAAsC;IAC/E,MAAM,EAAEC,KAAK,EAAEC,QAAQ,EAAEC,UAAU,EAAE,GAAGH;IAExC,oCAAoC;IACpC,MAAMI,YAAYP,OAAO;IAEzB,6EAA6E;IAC7E,qDAAqD;IACrD,MAAM,CAACQ,SAASC,WAAW,GAAGV,SAA4B;QACxD,MAAMW,cAAcN,MAAMM,WAAW,IAAI,CAAC;QAC1C,OAAOC,OAAOH,OAAO,CAACE,aAAaE,GAAG,CAAC,CAAC,CAACC,KAAKT,MAAM,GAAM,CAAA;gBACxDU,IAAIC,OAAOR,UAAUS,OAAO;gBAC5BH;gBACAT;YACF,CAAA;IACF;IAEA,2BAA2B;IAC3B,MAAMa,SAAS,IAAIC;IACnB,MAAMC,gBAAgB,IAAIC;IAC1BZ,QAAQa,OAAO,CAAC,CAAC,EAAER,GAAG,EAAE;QACtB,IAAIA,QAAQ,IAAI;YACd,MAAMS,QAAQ,AAACL,CAAAA,OAAOM,GAAG,CAACV,QAAQ,CAAA,IAAK;YACvCI,OAAOO,GAAG,CAACX,KAAKS;YAChB,IAAIA,QAAQ,GAAG;gBACbH,cAAcM,GAAG,CAACZ;YACpB;QACF;IACF;IACA,MAAMa,gBAAgBP,cAAcQ,IAAI,GAAG;IAE3C,uDAAuD;IACvD,MAAMC,eAAe,CAACC;QACpB,MAAMC,YAAoC,CAAC;QAC3CD,WAAWR,OAAO,CAAC,CAAC,EAAER,GAAG,EAAET,KAAK,EAAE;YAChC,IAAIS,QAAQ,IAAI;gBACdiB,SAAS,CAACjB,IAAI,GAAGT;YACnB;QACF;QAEAC,SAAS;YACP,GAAGD,KAAK;YACRM,aAAaC,OAAOoB,IAAI,CAACD,WAAWE,MAAM,GAAG,IAAIF,YAAYG;QAC/D;IACF;IAEA,MAAMC,yBAAyB,CAACpB,IAAYqB,OAAwBC;QAClE,MAAMP,aAAarB,QAAQI,GAAG,CAAC,CAACyB;YAC9B,IAAIA,MAAMvB,EAAE,KAAKA,IAAI,OAAOuB;YAC5B,OAAOF,UAAU,QAAQ;gBAAE,GAAGE,KAAK;gBAAExB,KAAKuB;YAAS,IAAI;gBAAE,GAAGC,KAAK;gBAAEjC,OAAOgC;YAAS;QACrF;QACA3B,WAAWoB;QACXD,aAAaC;IACf;IAEA,MAAMS,gBAAgB;QACpB,MAAMT,aAAa;eAAIrB;YAAS;gBAAEM,IAAIC,OAAOR,UAAUS,OAAO;gBAAKH,KAAK;gBAAIT,OAAO;YAAG;SAAE;QACxFK,WAAWoB;QACXD,aAAaC;IACf;IAEA,MAAMU,mBAAmB,CAACzB;QACxB,MAAMe,aAAarB,QAAQgC,MAAM,CAAC,CAACH,QAAUA,MAAMvB,EAAE,KAAKA;QAC1DL,WAAWoB;QACXD,aAAaC;IACf;IAEA,MAAMY,oBAA8C;QAClDC,WAAW;IACb;IAEA,MAAMC,mBAA6C;QACjDC,OAAO;YACLC,MAAM;YACNC,MAAM;gBACJC,kBAAkB;oBAChB,kDAAkD;oBAClD;wBACEC,iBAAiB;wBACjBC,QAAQ;oBACV;oBACA;wBACED,iBAAiB;wBACjBC,QAAQ;oBACV;oBACA;wBACED,iBAAiB;wBACjBC,QAAQ;oBACV;oBACA;wBACED,iBAAiB;wBACjBC,QAAQ;oBACV;oBACA;wBACED,iBAAiB;wBACjBC,QAAQ;oBACV;oBACA;wBACED,iBAAiB;wBACjBC,QAAQ;oBACV;oBACA;wBACED,iBAAiB;wBACjBC,QAAQ;oBACV;iBACD;gBACDC,KAAK;YACP;QACF;IACF;IAEA,qBACE;;0BACE,KAACxD;gBAAWyD,SAAQ;gBAAKC,IAAI;0BAAG;;0BAGhC,KAAC3D;gBACCkC,MAAK;gBACL0B,SAAS;gBACTC,OAAM;gBACNlD,OAAOA,MAAMmD,cAAc,IAAI;gBAC/BC,aAAa,CAAC,SAAS,EAAEvD,yBAAyB;gBAClDwD,YAAY;oBACVC,UAAUpD;gBACZ;gBACAqD,iBAAiB;oBAAEC,QAAQtD,aAAa,OAAO2B;gBAAU;gBACzD5B,UAAU,CAACwD,IAAMxD,SAAS;wBAAE,GAAGD,KAAK;wBAAEmD,gBAAgBM,EAAEC,MAAM,CAAC1D,KAAK;oBAAmB;gBACvF2D,YAAW;;0BAEb,KAACxE;gBACCa,OAAOA;gBACPC,UAAUA;gBACVC,YAAYA;gBACZmC,mBAAmBA;gBACnBE,kBAAkBA;;0BAEpB,KAACjD;gBAAWyD,SAAQ;gBAAKa,IAAI;gBAAGZ,IAAI;0BAAG;;YAGtC5C,QAAQwB,MAAM,GAAG,mBAChB;0BACGxB,QAAQI,GAAG,CAAC,CAACyB,sBACZ,MAAC7C;wBAAmByE,SAAQ;wBAAOC,YAAW;wBAASC,KAAK;wBAAGf,IAAI;;0CACjE,KAAC3D;gCACCkC,MAAK;gCACL2B,OAAM;gCACNlD,OAAOiC,MAAMxB,GAAG;gCAChB2C,aAAY;gCACZY,UAAU9D;gCACVD,UAAU,CAACwD,IAAM3B,uBAAuBG,MAAMvB,EAAE,EAAE,OAAO+C,EAAEC,MAAM,CAAC1D,KAAK;gCACvEiE,OAAOlD,cAAcmD,GAAG,CAACjC,MAAMxB,GAAG;gCAClC0D,IAAI;oCAAEC,UAAU;gCAAI;;0CAEtB,KAAC/E;gCACCkC,MAAK;gCACL2B,OAAM;gCACNlD,OAAOiC,MAAMjC,KAAK;gCAClBoD,aAAY;gCACZY,UAAU9D;gCACVD,UAAU,CAACwD,IAAM3B,uBAAuBG,MAAMvB,EAAE,EAAE,SAAS+C,EAAEC,MAAM,CAAC1D,KAAK;gCACzEmE,IAAI;oCAAEC,UAAU;oCAAKC,UAAU;gCAAE;;4BAElC,CAACnE,4BACA,KAACX;gCAAW+E,SAAS,IAAMnC,iBAAiBF,MAAMvB,EAAE;0CAClD,cAAA,KAACjB;;;uBAtBGwC,MAAMvB,EAAE;;YA6BvBY,+BACC,KAAChC;gBAAWyD,SAAQ;gBAAQwB,OAAM;gBAAQvB,IAAI;0BAAG;;YAIlD5C,QAAQwB,MAAM,KAAK,mBAClB,KAACtC;gBAAWyD,SAAQ;gBAAQwB,OAAM;0BAAgB;;YAKnD,CAACrE,4BACA,KAACX;gBAAW+E,SAASpC;0BACnB,cAAA,KAAC1C;;;;AAKX"}
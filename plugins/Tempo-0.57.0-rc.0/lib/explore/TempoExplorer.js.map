{"version":3,"sources":["../../../src/explore/TempoExplorer.tsx"],"sourcesContent":["// Copyright 2024 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { Alert, Box, Stack } from '@mui/material';\nimport { ErrorAlert, ErrorBoundary, LoadingOverlay, NoDataOverlay } from '@perses-dev/components';\nimport { QueryDefinition, isValidTraceId } from '@perses-dev/core';\nimport { Panel } from '@perses-dev/dashboards';\nimport { useExplorerManagerContext } from '@perses-dev/explore';\nimport { DataQueriesProvider, MultiQueryEditor, useDataQueries } from '@perses-dev/plugin-system';\nimport { ReactElement, useState } from 'react';\nimport { TempoTraceQuerySpec } from '../model';\nimport { linkToSpan, linkToTrace } from './links';\n\ninterface TracesExplorerQueryParams {\n  queries?: QueryDefinition[];\n  spanId?: string;\n}\n\ninterface SearchResultsPanelProps {\n  queries: QueryDefinition[];\n}\n\nfunction SearchResultsPanel({ queries }: SearchResultsPanelProps): ReactElement {\n  const { isFetching, isLoading, queryResults } = useDataQueries('TraceQuery');\n\n  // no query executed, show empty panel\n  if (queryResults.length === 0) {\n    return <></>;\n  }\n\n  if (isLoading || isFetching) {\n    return <LoadingOverlay />;\n  }\n\n  const queryError = queryResults.find((d) => d.error);\n  if (queryError) {\n    throw queryError.error;\n  }\n\n  const tracesFound = queryResults.some((traceData) => (traceData.data?.searchResult ?? []).length > 0);\n  if (!tracesFound) {\n    return <NoDataOverlay resource=\"traces\" />;\n  }\n\n  const hasMoreResults = queryResults.some((traceData) => traceData.data?.metadata?.hasMoreResults);\n\n  return (\n    <Stack sx={{ height: '100%' }} gap={2}>\n      <Box sx={{ height: '35%', flexShrink: 0 }}>\n        <Panel\n          panelOptions={{\n            hideHeader: true,\n          }}\n          definition={{\n            kind: 'Panel',\n            spec: {\n              queries,\n              display: { name: '' },\n              plugin: {\n                kind: 'ScatterChart',\n                spec: {\n                  link: linkToTrace,\n                },\n              },\n            },\n          }}\n        />\n      </Box>\n      <Panel\n        sx={{ flexGrow: 1 }}\n        panelOptions={{\n          hideHeader: true,\n        }}\n        definition={{\n          kind: 'Panel',\n          spec: {\n            queries,\n            display: { name: '' },\n            plugin: {\n              kind: 'TraceTable',\n              spec: {\n                links: {\n                  trace: linkToTrace,\n                },\n              },\n            },\n          },\n        }}\n      />\n      {hasMoreResults && (\n        <Alert severity=\"info\">\n          Not all matching traces are currently displayed. Increase the result limit to view additional traces.\n        </Alert>\n      )}\n    </Stack>\n  );\n}\n\ninterface TracingGanttChartPanelProps {\n  queries: QueryDefinition[];\n  selectedSpanId?: string;\n}\n\nfunction TracingGanttChartPanel(props: TracingGanttChartPanelProps): ReactElement {\n  const { queries, selectedSpanId } = props;\n  const firstQuery = (queries[0]?.spec.plugin.spec as TempoTraceQuerySpec | undefined)?.query;\n\n  return (\n    <Panel\n      panelOptions={{ showIcons: 'always' }}\n      definition={{\n        kind: 'Panel',\n        spec: {\n          queries,\n          display: { name: `Trace ${firstQuery}` },\n          plugin: {\n            kind: 'TracingGanttChart',\n            spec: {\n              links: {\n                trace: linkToTrace,\n                span: linkToSpan,\n              },\n              selectedSpanId,\n            },\n          },\n        },\n      }}\n    />\n  );\n}\n\nexport function TempoExplorer(): ReactElement {\n  const {\n    data: { queries = [], spanId: selectedSpanId },\n    setData,\n  } = useExplorerManagerContext<TracesExplorerQueryParams>();\n\n  const [queryDefinitions, setQueryDefinitions] = useState<QueryDefinition[]>(queries);\n\n  // map TraceQueryDefinition to Definition<UnknownSpec>\n  const definitions = queries.length\n    ? queries.map((query: QueryDefinition) => {\n        return {\n          kind: query.spec.plugin.kind,\n          spec: query.spec.plugin.spec,\n        };\n      })\n    : [];\n\n  const firstQuery = (queries[0]?.spec.plugin.spec as TempoTraceQuerySpec | undefined)?.query;\n  const isSingleTrace = isValidTraceId(firstQuery ?? '');\n\n  return (\n    <Stack gap={2} sx={{ width: '100%' }}>\n      <MultiQueryEditor\n        queryTypes={['TraceQuery']}\n        onChange={(state) => setQueryDefinitions(state)}\n        queries={queryDefinitions}\n        onQueryRun={() => setData({ queries: queryDefinitions })}\n      />\n\n      <ErrorBoundary FallbackComponent={ErrorAlert} resetKeys={[queries]}>\n        <DataQueriesProvider definitions={definitions}>\n          <Box height={700}>\n            {isSingleTrace ? (\n              <TracingGanttChartPanel queries={queries} selectedSpanId={selectedSpanId} />\n            ) : (\n              <SearchResultsPanel queries={queries} />\n            )}\n          </Box>\n        </DataQueriesProvider>\n      </ErrorBoundary>\n    </Stack>\n  );\n}\n"],"names":["Alert","Box","Stack","ErrorAlert","ErrorBoundary","LoadingOverlay","NoDataOverlay","isValidTraceId","Panel","useExplorerManagerContext","DataQueriesProvider","MultiQueryEditor","useDataQueries","useState","linkToSpan","linkToTrace","SearchResultsPanel","queries","isFetching","isLoading","queryResults","length","queryError","find","d","error","tracesFound","some","traceData","data","searchResult","resource","hasMoreResults","metadata","sx","height","gap","flexShrink","panelOptions","hideHeader","definition","kind","spec","display","name","plugin","link","flexGrow","links","trace","severity","TracingGanttChartPanel","props","selectedSpanId","firstQuery","query","showIcons","span","TempoExplorer","spanId","setData","queryDefinitions","setQueryDefinitions","definitions","map","isSingleTrace","width","queryTypes","onChange","state","onQueryRun","FallbackComponent","resetKeys"],"mappings":"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"}
{"version":3,"sources":["../../../../src/plugins/tempo-trace-query/TempoTraceQueryEditor.tsx"],"sourcesContent":["// Copyright 2025 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { Box, Button, FormControl, InputLabel, MenuItem, Select, Stack } from '@mui/material';\nimport { useId } from '@perses-dev/components';\nimport {\n  DatasourceSelect,\n  DatasourceSelectProps,\n  useDatasourceClient,\n  useDatasourceSelectValueToSelector,\n} from '@perses-dev/plugin-system';\nimport { produce } from 'immer';\nimport { ReactElement, useCallback, useState } from 'react';\nimport {\n  TempoClient,\n  DEFAULT_TEMPO,\n  isDefaultTempoSelector,\n  isTempoDatasourceSelector,\n  TEMPO_DATASOURCE_KIND,\n} from '../../model';\nimport { AttributeFilters } from '../../components/AttributeFilters';\nimport { TraceQLEditor, filterToTraceQL, traceQLToFilter } from '../../components';\nimport { TraceQueryEditorProps, useQueryState } from './query-editor-model';\n\nexport function TempoTraceQueryEditor(props: TraceQueryEditorProps): ReactElement {\n  const {\n    onChange,\n    value,\n    value: { datasource, limit },\n  } = props;\n\n  const datasourceSelectValue = datasource ?? DEFAULT_TEMPO;\n  const selectedDatasource = useDatasourceSelectValueToSelector(datasourceSelectValue, TEMPO_DATASOURCE_KIND);\n  const datasourceSelectLabelID = useId('tempo-datasource-label'); // for panels with multiple queries, this component is rendered multiple times on the same page\n\n  const { data: client } = useDatasourceClient<TempoClient>(selectedDatasource);\n  const { query, handleQueryChange, handleQueryBlur } = useQueryState(props);\n  const [showAttributeFilters, setShowAttributeFilters] = useState(() => isSimpleTraceQLQuery(query));\n\n  const handleDatasourceChange: DatasourceSelectProps['onChange'] = (next) => {\n    if (isTempoDatasourceSelector(next)) {\n      onChange(\n        produce(value, (draft) => {\n          // If they're using the default, just omit the datasource prop (i.e. set to undefined)\n          const nextDatasource = isDefaultTempoSelector(next) ? undefined : next;\n          draft.datasource = nextDatasource;\n        })\n      );\n      return;\n    }\n\n    throw new Error('Got unexpected non-Tempo datasource selector');\n  };\n\n  const runQuery = (newQuery: string) => {\n    onChange(\n      produce(value, (draft) => {\n        draft.query = newQuery;\n      })\n    );\n  };\n\n  const handleTraceQueryChange = useCallback(\n    (e: string) => {\n      handleQueryChange(e);\n    },\n    [handleQueryChange]\n  );\n\n  return (\n    <Stack spacing={2}>\n      <FormControl margin=\"dense\" fullWidth={false}>\n        <DatasourceSelect\n          datasourcePluginKind={TEMPO_DATASOURCE_KIND}\n          value={datasourceSelectValue}\n          onChange={handleDatasourceChange}\n          labelId={datasourceSelectLabelID}\n          label=\"Tempo Datasource\"\n          notched\n        />\n      </FormControl>\n      <Stack direction=\"row\" spacing={2} sx={{ alignItems: 'flex-start' }}>\n        {showAttributeFilters ? (\n          <AttributeFilters client={client} query={query} setQuery={runQuery} />\n        ) : (\n          <TraceQLEditor client={client} value={query} onChange={handleTraceQueryChange} onBlur={handleQueryBlur} />\n        )}\n        <Button onClick={() => setShowAttributeFilters(!showAttributeFilters)}>\n          {showAttributeFilters ? 'Show query' : 'Hide query'}\n        </Button>\n        <LimitSelect\n          value={limit ?? 20}\n          setValue={(newLimit: number) =>\n            onChange(\n              produce(value, (draft) => {\n                draft.limit = newLimit;\n              })\n            )\n          }\n        />\n      </Stack>\n    </Stack>\n  );\n}\n\nfunction isSimpleTraceQLQuery(query: string) {\n  // if a query can be transformed to a filter and back to the original query, we can show the attribute filter toolbar\n  return query == '' || filterToTraceQL(traceQLToFilter(query)) === query;\n}\n\nconst limitOptions = [20, 50, 100, 500, 1000, 5000];\n\ninterface LimitSelectProps {\n  value: number;\n  setValue: (x: number) => void;\n}\n\nexport function LimitSelect(props: LimitSelectProps) {\n  const { value, setValue } = props;\n\n  // the outer <Box> is required, because <FormControl> has display: inline-flex, which doesn't work with the parent <Stack> of the query editor\n  return (\n    <Box>\n      <FormControl size=\"small\">\n        <InputLabel id=\"max-traces-label\">Max Traces</InputLabel>\n        <Select\n          labelId=\"max-traces-label\"\n          id=\"max-traces-select\"\n          value={value}\n          label=\"Max Traces\"\n          onChange={(e) => setValue(typeof e.target.value === 'number' ? e.target.value : parseInt(e.target.value))}\n          sx={{ width: 110 }}\n        >\n          {limitOptions.map((option) => (\n            <MenuItem key={option} value={option}>\n              {option}\n            </MenuItem>\n          ))}\n        </Select>\n      </FormControl>\n    </Box>\n  );\n}\n"],"names":["Box","Button","FormControl","InputLabel","MenuItem","Select","Stack","useId","DatasourceSelect","useDatasourceClient","useDatasourceSelectValueToSelector","produce","useCallback","useState","DEFAULT_TEMPO","isDefaultTempoSelector","isTempoDatasourceSelector","TEMPO_DATASOURCE_KIND","AttributeFilters","TraceQLEditor","filterToTraceQL","traceQLToFilter","useQueryState","TempoTraceQueryEditor","props","onChange","value","datasource","limit","datasourceSelectValue","selectedDatasource","datasourceSelectLabelID","data","client","query","handleQueryChange","handleQueryBlur","showAttributeFilters","setShowAttributeFilters","isSimpleTraceQLQuery","handleDatasourceChange","next","draft","nextDatasource","undefined","Error","runQuery","newQuery","handleTraceQueryChange","e","spacing","margin","fullWidth","datasourcePluginKind","labelId","label","notched","direction","sx","alignItems","setQuery","onBlur","onClick","LimitSelect","setValue","newLimit","limitOptions","size","id","target","parseInt","width","map","option"],"mappings":"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"}
{"version":3,"sources":["../../../../src/components/filter/filter_to_traceql.ts"],"sourcesContent":["import { DurationField, Filter } from './filter';\n\n/**\n * Construct a TraceQL query from a filter.\n * 1. Creates the matchers, for example 'resource.service.name = \"some_value\"' or 'resource.service.name =~ \"some_value|other_value\"'\n * 2. Join all matchers with '&&'\n * 3. Return the full TraceQL query, for example '{ resource.service.name = \"some_value\" && name = \"span_name\" }'\n */\nexport function filterToTraceQL(filter: Filter) {\n  const matchers: string[] = [\n    ...stringMatcher('resource.service.name', filter.serviceName),\n    ...stringMatcher('name', filter.spanName),\n    ...stringMatcher('resource.k8s.namespace.name', filter.namespace),\n    ...intrinsicMatcher('status', filter.status),\n    ...durationMatcher('duration', filter.spanDuration),\n    ...durationMatcher('traceDuration', filter.traceDuration),\n    ...customMatcher(filter.customMatchers),\n  ];\n\n  if (matchers.length === 0) {\n    return '{}';\n  }\n  return `{ ${matchers.join(' && ')} }`;\n}\n\nfunction escape(q: string) {\n  return q.replaceAll('\\\\', '\\\\\\\\').replaceAll('\"', '\\\\\"');\n}\n\nfunction stringMatcher(attribute: string, values: string[]) {\n  const escapedValues = values.map(escape);\n  if (escapedValues.length > 1) {\n    return [`${attribute} =~ \"${escapedValues.join('|')}\"`];\n  } else if (escapedValues.length == 1) {\n    return [`${attribute} = \"${escapedValues[0]}\"`];\n  }\n  return [];\n}\n\nfunction intrinsicMatcher(attribute: string, values: string[]) {\n  const orConds = values.map((x) => `${attribute} = ${x}`);\n  if (orConds.length > 1) {\n    return ['(' + orConds.join(' || ') + ')'];\n  } else if (orConds.length === 1) {\n    return orConds;\n  } else {\n    return [];\n  }\n}\n\nfunction durationMatcher(attribute: string, value: DurationField) {\n  const matchers = [];\n  if (value.min) {\n    matchers.push(`${attribute} >= ${value.min}`);\n  }\n  if (value.max) {\n    matchers.push(`${attribute} <= ${value.max}`);\n  }\n  return matchers;\n}\n\nfunction customMatcher(customMatchers: string[]) {\n  return customMatchers;\n}\n"],"names":["filterToTraceQL","filter","matchers","stringMatcher","serviceName","spanName","namespace","intrinsicMatcher","status","durationMatcher","spanDuration","traceDuration","customMatcher","customMatchers","length","join","escape","q","replaceAll","attribute","values","escapedValues","map","orConds","x","value","min","push","max"],"mappings":"AAEA;;;;;CAKC,GACD,OAAO,SAASA,gBAAgBC,MAAc;IAC5C,MAAMC,WAAqB;WACtBC,cAAc,yBAAyBF,OAAOG,WAAW;WACzDD,cAAc,QAAQF,OAAOI,QAAQ;WACrCF,cAAc,+BAA+BF,OAAOK,SAAS;WAC7DC,iBAAiB,UAAUN,OAAOO,MAAM;WACxCC,gBAAgB,YAAYR,OAAOS,YAAY;WAC/CD,gBAAgB,iBAAiBR,OAAOU,aAAa;WACrDC,cAAcX,OAAOY,cAAc;KACvC;IAED,IAAIX,SAASY,MAAM,KAAK,GAAG;QACzB,OAAO;IACT;IACA,OAAO,CAAC,EAAE,EAAEZ,SAASa,IAAI,CAAC,QAAQ,EAAE,CAAC;AACvC;AAEA,SAASC,OAAOC,CAAS;IACvB,OAAOA,EAAEC,UAAU,CAAC,MAAM,QAAQA,UAAU,CAAC,KAAK;AACpD;AAEA,SAASf,cAAcgB,SAAiB,EAAEC,MAAgB;IACxD,MAAMC,gBAAgBD,OAAOE,GAAG,CAACN;IACjC,IAAIK,cAAcP,MAAM,GAAG,GAAG;QAC5B,OAAO;YAAC,GAAGK,UAAU,KAAK,EAAEE,cAAcN,IAAI,CAAC,KAAK,CAAC,CAAC;SAAC;IACzD,OAAO,IAAIM,cAAcP,MAAM,IAAI,GAAG;QACpC,OAAO;YAAC,GAAGK,UAAU,IAAI,EAAEE,aAAa,CAAC,EAAE,CAAC,CAAC,CAAC;SAAC;IACjD;IACA,OAAO,EAAE;AACX;AAEA,SAASd,iBAAiBY,SAAiB,EAAEC,MAAgB;IAC3D,MAAMG,UAAUH,OAAOE,GAAG,CAAC,CAACE,IAAM,GAAGL,UAAU,GAAG,EAAEK,GAAG;IACvD,IAAID,QAAQT,MAAM,GAAG,GAAG;QACtB,OAAO;YAAC,MAAMS,QAAQR,IAAI,CAAC,UAAU;SAAI;IAC3C,OAAO,IAAIQ,QAAQT,MAAM,KAAK,GAAG;QAC/B,OAAOS;IACT,OAAO;QACL,OAAO,EAAE;IACX;AACF;AAEA,SAASd,gBAAgBU,SAAiB,EAAEM,KAAoB;IAC9D,MAAMvB,WAAW,EAAE;IACnB,IAAIuB,MAAMC,GAAG,EAAE;QACbxB,SAASyB,IAAI,CAAC,GAAGR,UAAU,IAAI,EAAEM,MAAMC,GAAG,EAAE;IAC9C;IACA,IAAID,MAAMG,GAAG,EAAE;QACb1B,SAASyB,IAAI,CAAC,GAAGR,UAAU,IAAI,EAAEM,MAAMG,GAAG,EAAE;IAC9C;IACA,OAAO1B;AACT;AAEA,SAASU,cAAcC,cAAwB;IAC7C,OAAOA;AACT"}
{"version":3,"sources":["../../../src/components/AttributeFilters.tsx"],"sourcesContent":["// Copyright 2025 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { ReactElement, SyntheticEvent, useCallback, useEffect, useState } from 'react';\nimport { Autocomplete, Checkbox, Stack, TextField, TextFieldProps } from '@mui/material';\nimport { useTimeRange } from '@perses-dev/plugin-system';\nimport { useQuery } from '@tanstack/react-query';\nimport { TempoClient } from '../model';\nimport { getUnixTimeRange } from '../plugins/tempo-trace-query/get-trace-data';\nimport { filterToTraceQL } from './filter/filter_to_traceql';\nimport { traceQLToFilter } from './filter/traceql_to_filter';\nimport { DurationField, Filter, splitByUnquotedWhitespace } from './filter/filter';\n\nconst statusOptions = ['unset', 'ok', 'error'];\n\nexport interface AttributeFiltersProps {\n  client?: TempoClient;\n  query: string;\n  setQuery: (x: string) => void;\n}\n\nexport function AttributeFilters(props: AttributeFiltersProps): ReactElement {\n  const { client, query, setQuery } = props;\n\n  const filter = traceQLToFilter(query);\n  const setFilter = (filter: Filter) => {\n    setQuery(filterToTraceQL(filter));\n  };\n\n  const { absoluteTimeRange } = useTimeRange();\n  const { start, end } = getUnixTimeRange(absoluteTimeRange);\n\n  const { data: serviceNameOptions } = useTagValues(\n    client,\n    'resource.service.name',\n    filterToTraceQL({ ...filter, serviceName: [] }),\n    start,\n    end\n  );\n  const { data: spanNameOptions } = useTagValues(\n    client,\n    'name',\n    filterToTraceQL({ ...filter, spanName: [] }),\n    start,\n    end\n  );\n\n  return (\n    <>\n      <StringAttributeFilter\n        label=\"Service Name\"\n        options={serviceNameOptions ?? []}\n        value={filter.serviceName}\n        setValue={(x) => setFilter({ ...filter, serviceName: x })}\n      />\n      <StringAttributeFilter\n        label=\"Span Name\"\n        options={spanNameOptions ?? []}\n        value={filter.spanName}\n        setValue={(x) => setFilter({ ...filter, spanName: x })}\n      />\n      <StringAttributeFilter\n        label=\"Status\"\n        width={210}\n        options={statusOptions ?? []}\n        value={filter.status}\n        setValue={(x) => setFilter({ ...filter, status: x })}\n      />\n      <DurationAttributeFilter\n        label=\"Trace Duration\"\n        value={filter.traceDuration}\n        setValue={(value) => setFilter({ ...filter, traceDuration: value })}\n      />\n      <CustomAttributesFilter\n        label=\"Custom Attributes\"\n        value={filter.customMatchers}\n        setValue={(value) => setFilter({ ...filter, customMatchers: value })}\n      />\n    </>\n  );\n}\n\ninterface StringAttributeFilterProps {\n  label: string;\n  width?: number;\n  options: string[];\n  value: string[];\n  setValue: (value: string[]) => void;\n}\n\nfunction StringAttributeFilter(props: StringAttributeFilterProps) {\n  const { label, width, options, value, setValue } = props;\n\n  return (\n    <Autocomplete\n      multiple\n      size=\"small\"\n      limitTags={1}\n      disableCloseOnSelect\n      value={value}\n      onChange={(_event: SyntheticEvent, newValue: string[]) => setValue(newValue)}\n      options={options}\n      renderOption={(props, option, { selected }) => {\n        const { key, ...optionProps } = props;\n        return (\n          <li key={key} {...optionProps}>\n            <Checkbox style={{ marginRight: 8 }} checked={selected} />\n            {option}\n          </li>\n        );\n      }}\n      renderInput={(params) => <TextField {...params} label={label} />}\n      // Reduce the size of the chips to make space for the <input> element, the +X text and the X button to avoid a line break.\n      // See https://github.com/mui/material-ui/issues/38835 for more details.\n      slotProps={{ chip: { sx: { maxWidth: 'calc(100% - 45px) !important' } } }}\n      // Reduce the size of the <input> field\n      sx={{ width: width ?? 250, '& input': { minWidth: '5px !important' } }}\n    />\n  );\n}\n\ninterface DurationAttributeFilterProps {\n  label: string;\n  value: DurationField;\n  setValue: (value: DurationField) => void;\n}\n\nfunction DurationAttributeFilter(props: DurationAttributeFilterProps) {\n  const { label, value, setValue } = props;\n  const { min, max } = value;\n\n  return (\n    <Stack direction=\"row\" gap={0.5}>\n      <DurationTextInput label={`Min ${label}`} value={min ?? ''} setValue={(min) => setValue({ min, max })} />\n      <DurationTextInput label={`Max ${label}`} value={max ?? ''} setValue={(max) => setValue({ min, max })} />\n    </Stack>\n  );\n}\n\nconst durationFormatRegex = /^([0-9]+\\.)?[0-9]+(ns|ms|s|m|h)$/;\n\ninterface DurationTextInputProps {\n  label: string;\n  value: string;\n  setValue: (value: string) => void;\n}\n\nfunction DurationTextInput(props: DurationTextInputProps) {\n  const { label, value, setValue } = props;\n\n  return (\n    <LazyTextInput\n      label={label}\n      size=\"small\"\n      value={value}\n      setValue={setValue}\n      validationRegex={durationFormatRegex}\n      validationFailedMessage=\"Invalid format. Accepted format e.g. 100ms, accepted units: ns, ms, s, m, h\"\n      sx={{ width: 150 }}\n    />\n  );\n}\n\ninterface CustomAttributesFilterProps {\n  label: string;\n  value: string[];\n  setValue: (value: string[]) => void;\n}\n\nfunction CustomAttributesFilter(props: CustomAttributesFilterProps) {\n  const { label, value, setValue } = props;\n\n  return (\n    <LazyTextInput\n      label={label}\n      size=\"small\"\n      placeholder='span.http.status_code=200 span.http.method=\"GET\"'\n      value={value.join(' ')}\n      setValue={(x) => setValue(splitByUnquotedWhitespace(x))}\n      sx={{ flexGrow: 1 }}\n    />\n  );\n}\n\ninterface LazyTextInputProps extends Omit<TextFieldProps, 'variant'> {\n  validationRegex?: RegExp;\n  validationFailedMessage?: string;\n  value: string;\n  setValue: (value: string) => void;\n}\n\n/** A <TextField> which calls props.setValue when the input field is blurred and the validation passes. */\nfunction LazyTextInput(props: LazyTextInputProps) {\n  const { validationRegex, validationFailedMessage, value, setValue, ...otherProps } = props;\n  const [draftValue, setDraftValue] = useState(value);\n  const isValidInput = draftValue == '' || validationRegex == undefined || validationRegex.test(draftValue);\n\n  useEffect(() => {\n    setDraftValue(value);\n  }, [value, setDraftValue]);\n\n  const handleChange = useCallback((event: React.ChangeEvent<HTMLInputElement>) => {\n    setDraftValue(event.target.value);\n  }, []);\n\n  const handleBlur = useCallback(() => {\n    if (isValidInput) {\n      setValue(draftValue);\n    }\n  }, [isValidInput, setValue, draftValue]);\n\n  return (\n    <TextField\n      {...otherProps}\n      error={!isValidInput}\n      helperText={isValidInput ? undefined : validationFailedMessage}\n      value={draftValue}\n      onChange={handleChange}\n      onBlur={handleBlur}\n    />\n  );\n}\n\nfunction useTagValues(client: TempoClient | undefined, tag: string, query: string, start?: number, end?: number) {\n  return useQuery({\n    queryKey: ['useTagValues', client, tag, query, start, end],\n    enabled: !!client,\n    queryFn: async function () {\n      if (!client) return;\n      const values = await client.searchTagValues({ tag, q: query, start, end });\n      return values.tagValues.map((tagValue) => tagValue.value ?? '').sort();\n    },\n    staleTime: 60 * 1000, // cache tag value response for 1m\n  });\n}\n"],"names":["useCallback","useEffect","useState","Autocomplete","Checkbox","Stack","TextField","useTimeRange","useQuery","getUnixTimeRange","filterToTraceQL","traceQLToFilter","splitByUnquotedWhitespace","statusOptions","AttributeFilters","props","client","query","setQuery","filter","setFilter","absoluteTimeRange","start","end","data","serviceNameOptions","useTagValues","serviceName","spanNameOptions","spanName","StringAttributeFilter","label","options","value","setValue","x","width","status","DurationAttributeFilter","traceDuration","CustomAttributesFilter","customMatchers","multiple","size","limitTags","disableCloseOnSelect","onChange","_event","newValue","renderOption","option","selected","key","optionProps","li","style","marginRight","checked","renderInput","params","slotProps","chip","sx","maxWidth","minWidth","min","max","direction","gap","DurationTextInput","durationFormatRegex","LazyTextInput","validationRegex","validationFailedMessage","placeholder","join","flexGrow","otherProps","draftValue","setDraftValue","isValidInput","undefined","test","handleChange","event","target","handleBlur","error","helperText","onBlur","tag","queryKey","enabled","queryFn","values","searchTagValues","q","tagValues","map","tagValue","sort","staleTime"],"mappings":";AAAA,oCAAoC;AACpC,kEAAkE;AAClE,mEAAmE;AACnE,0CAA0C;AAC1C,EAAE;AACF,6CAA6C;AAC7C,EAAE;AACF,sEAAsE;AACtE,oEAAoE;AACpE,2EAA2E;AAC3E,sEAAsE;AACtE,iCAAiC;AAEjC,SAAuCA,WAAW,EAAEC,SAAS,EAAEC,QAAQ,QAAQ,QAAQ;AACvF,SAASC,YAAY,EAAEC,QAAQ,EAAEC,KAAK,EAAEC,SAAS,QAAwB,gBAAgB;AACzF,SAASC,YAAY,QAAQ,4BAA4B;AACzD,SAASC,QAAQ,QAAQ,wBAAwB;AAEjD,SAASC,gBAAgB,QAAQ,8CAA8C;AAC/E,SAASC,eAAe,QAAQ,6BAA6B;AAC7D,SAASC,eAAe,QAAQ,6BAA6B;AAC7D,SAAgCC,yBAAyB,QAAQ,kBAAkB;AAEnF,MAAMC,gBAAgB;IAAC;IAAS;IAAM;CAAQ;AAQ9C,OAAO,SAASC,iBAAiBC,KAA4B;IAC3D,MAAM,EAAEC,MAAM,EAAEC,KAAK,EAAEC,QAAQ,EAAE,GAAGH;IAEpC,MAAMI,SAASR,gBAAgBM;IAC/B,MAAMG,YAAY,CAACD;QACjBD,SAASR,gBAAgBS;IAC3B;IAEA,MAAM,EAAEE,iBAAiB,EAAE,GAAGd;IAC9B,MAAM,EAAEe,KAAK,EAAEC,GAAG,EAAE,GAAGd,iBAAiBY;IAExC,MAAM,EAAEG,MAAMC,kBAAkB,EAAE,GAAGC,aACnCV,QACA,yBACAN,gBAAgB;QAAE,GAAGS,MAAM;QAAEQ,aAAa,EAAE;IAAC,IAC7CL,OACAC;IAEF,MAAM,EAAEC,MAAMI,eAAe,EAAE,GAAGF,aAChCV,QACA,QACAN,gBAAgB;QAAE,GAAGS,MAAM;QAAEU,UAAU,EAAE;IAAC,IAC1CP,OACAC;IAGF,qBACE;;0BACE,KAACO;gBACCC,OAAM;gBACNC,SAASP,sBAAsB,EAAE;gBACjCQ,OAAOd,OAAOQ,WAAW;gBACzBO,UAAU,CAACC,IAAMf,UAAU;wBAAE,GAAGD,MAAM;wBAAEQ,aAAaQ;oBAAE;;0BAEzD,KAACL;gBACCC,OAAM;gBACNC,SAASJ,mBAAmB,EAAE;gBAC9BK,OAAOd,OAAOU,QAAQ;gBACtBK,UAAU,CAACC,IAAMf,UAAU;wBAAE,GAAGD,MAAM;wBAAEU,UAAUM;oBAAE;;0BAEtD,KAACL;gBACCC,OAAM;gBACNK,OAAO;gBACPJ,SAASnB,iBAAiB,EAAE;gBAC5BoB,OAAOd,OAAOkB,MAAM;gBACpBH,UAAU,CAACC,IAAMf,UAAU;wBAAE,GAAGD,MAAM;wBAAEkB,QAAQF;oBAAE;;0BAEpD,KAACG;gBACCP,OAAM;gBACNE,OAAOd,OAAOoB,aAAa;gBAC3BL,UAAU,CAACD,QAAUb,UAAU;wBAAE,GAAGD,MAAM;wBAAEoB,eAAeN;oBAAM;;0BAEnE,KAACO;gBACCT,OAAM;gBACNE,OAAOd,OAAOsB,cAAc;gBAC5BP,UAAU,CAACD,QAAUb,UAAU;wBAAE,GAAGD,MAAM;wBAAEsB,gBAAgBR;oBAAM;;;;AAI1E;AAUA,SAASH,sBAAsBf,KAAiC;IAC9D,MAAM,EAAEgB,KAAK,EAAEK,KAAK,EAAEJ,OAAO,EAAEC,KAAK,EAAEC,QAAQ,EAAE,GAAGnB;IAEnD,qBACE,KAACZ;QACCuC,QAAQ;QACRC,MAAK;QACLC,WAAW;QACXC,oBAAoB;QACpBZ,OAAOA;QACPa,UAAU,CAACC,QAAwBC,WAAuBd,SAASc;QACnEhB,SAASA;QACTiB,cAAc,CAAClC,OAAOmC,QAAQ,EAAEC,QAAQ,EAAE;YACxC,MAAM,EAAEC,GAAG,EAAE,GAAGC,aAAa,GAAGtC;YAChC,qBACE,MAACuC;gBAAc,GAAGD,WAAW;;kCAC3B,KAACjD;wBAASmD,OAAO;4BAAEC,aAAa;wBAAE;wBAAGC,SAASN;;oBAC7CD;;eAFME;QAKb;QACAM,aAAa,CAACC,uBAAW,KAACrD;gBAAW,GAAGqD,MAAM;gBAAE5B,OAAOA;;QACvD,0HAA0H;QAC1H,wEAAwE;QACxE6B,WAAW;YAAEC,MAAM;gBAAEC,IAAI;oBAAEC,UAAU;gBAA+B;YAAE;QAAE;QACxE,uCAAuC;QACvCD,IAAI;YAAE1B,OAAOA,SAAS;YAAK,WAAW;gBAAE4B,UAAU;YAAiB;QAAE;;AAG3E;AAQA,SAAS1B,wBAAwBvB,KAAmC;IAClE,MAAM,EAAEgB,KAAK,EAAEE,KAAK,EAAEC,QAAQ,EAAE,GAAGnB;IACnC,MAAM,EAAEkD,GAAG,EAAEC,GAAG,EAAE,GAAGjC;IAErB,qBACE,MAAC5B;QAAM8D,WAAU;QAAMC,KAAK;;0BAC1B,KAACC;gBAAkBtC,OAAO,CAAC,IAAI,EAAEA,OAAO;gBAAEE,OAAOgC,OAAO;gBAAI/B,UAAU,CAAC+B,MAAQ/B,SAAS;wBAAE+B;wBAAKC;oBAAI;;0BACnG,KAACG;gBAAkBtC,OAAO,CAAC,IAAI,EAAEA,OAAO;gBAAEE,OAAOiC,OAAO;gBAAIhC,UAAU,CAACgC,MAAQhC,SAAS;wBAAE+B;wBAAKC;oBAAI;;;;AAGzG;AAEA,MAAMI,sBAAsB;AAQ5B,SAASD,kBAAkBtD,KAA6B;IACtD,MAAM,EAAEgB,KAAK,EAAEE,KAAK,EAAEC,QAAQ,EAAE,GAAGnB;IAEnC,qBACE,KAACwD;QACCxC,OAAOA;QACPY,MAAK;QACLV,OAAOA;QACPC,UAAUA;QACVsC,iBAAiBF;QACjBG,yBAAwB;QACxBX,IAAI;YAAE1B,OAAO;QAAI;;AAGvB;AAQA,SAASI,uBAAuBzB,KAAkC;IAChE,MAAM,EAAEgB,KAAK,EAAEE,KAAK,EAAEC,QAAQ,EAAE,GAAGnB;IAEnC,qBACE,KAACwD;QACCxC,OAAOA;QACPY,MAAK;QACL+B,aAAY;QACZzC,OAAOA,MAAM0C,IAAI,CAAC;QAClBzC,UAAU,CAACC,IAAMD,SAAStB,0BAA0BuB;QACpD2B,IAAI;YAAEc,UAAU;QAAE;;AAGxB;AASA,wGAAwG,GACxG,SAASL,cAAcxD,KAAyB;IAC9C,MAAM,EAAEyD,eAAe,EAAEC,uBAAuB,EAAExC,KAAK,EAAEC,QAAQ,EAAE,GAAG2C,YAAY,GAAG9D;IACrF,MAAM,CAAC+D,YAAYC,cAAc,GAAG7E,SAAS+B;IAC7C,MAAM+C,eAAeF,cAAc,MAAMN,mBAAmBS,aAAaT,gBAAgBU,IAAI,CAACJ;IAE9F7E,UAAU;QACR8E,cAAc9C;IAChB,GAAG;QAACA;QAAO8C;KAAc;IAEzB,MAAMI,eAAenF,YAAY,CAACoF;QAChCL,cAAcK,MAAMC,MAAM,CAACpD,KAAK;IAClC,GAAG,EAAE;IAEL,MAAMqD,aAAatF,YAAY;QAC7B,IAAIgF,cAAc;YAChB9C,SAAS4C;QACX;IACF,GAAG;QAACE;QAAc9C;QAAU4C;KAAW;IAEvC,qBACE,KAACxE;QACE,GAAGuE,UAAU;QACdU,OAAO,CAACP;QACRQ,YAAYR,eAAeC,YAAYR;QACvCxC,OAAO6C;QACPhC,UAAUqC;QACVM,QAAQH;;AAGd;AAEA,SAAS5D,aAAaV,MAA+B,EAAE0E,GAAW,EAAEzE,KAAa,EAAEK,KAAc,EAAEC,GAAY;IAC7G,OAAOf,SAAS;QACdmF,UAAU;YAAC;YAAgB3E;YAAQ0E;YAAKzE;YAAOK;YAAOC;SAAI;QAC1DqE,SAAS,CAAC,CAAC5E;QACX6E,SAAS;YACP,IAAI,CAAC7E,QAAQ;YACb,MAAM8E,SAAS,MAAM9E,OAAO+E,eAAe,CAAC;gBAAEL;gBAAKM,GAAG/E;gBAAOK;gBAAOC;YAAI;YACxE,OAAOuE,OAAOG,SAAS,CAACC,GAAG,CAAC,CAACC,WAAaA,SAASlE,KAAK,IAAI,IAAImE,IAAI;QACtE;QACAC,WAAW,KAAK;IAClB;AACF"}
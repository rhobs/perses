"use strict";(self.chunk_Tempo=self.chunk_Tempo||[]).push([["4397"],{91093:function(e,t,a){a.r(t),a.d(t,{TempoTraceQuery:()=>en});var r=a(57744),n=a(33862),s=a(94461);let i="TempoDatasource",l={kind:i};function o(e){let{start:t,end:a}=e;return{start:Math.ceil((0,s.getUnixTime)(t)),end:Math.ceil((0,s.getUnixTime)(a))}}let c=async(e,t)=>{if(void 0===e.query||null===e.query||""===e.query)return console.error("TempoTraceQuery is undefined, null, or an empty string."),{searchResult:[]};let a=await t.datasourceStore.listDatasourceSelectItems(i),s=(0,r.datasourceSelectValueToSelector)(e.datasource,t.variableState,a)??{kind:i},l=await t.datasourceStore.getDatasourceClient(s);if((0,n.h)(e.query))return{trace:function(e){let t={resourceSpans:e.batches};for(let e of t.resourceSpans)for(let t of e.scopeSpans)for(let e of t.spans)for(let t of(32!=e.traceId.length&&(e.traceId=u(e.traceId)),16!=e.spanId.length&&(e.spanId=u(e.spanId)),e.parentSpanId&&16!=e.parentSpanId.length&&(e.parentSpanId=u(e.parentSpanId)),e.links??[]))32!=t.traceId.length&&(t.traceId=u(t.traceId)),16!=t.spanId.length&&(t.spanId=u(t.spanId));return t}(await l.query({traceId:e.query})),metadata:{executedQueryString:e.query}};{let a={q:e.query};if(t.absoluteTimeRange){let{start:e,end:r}=o(t.absoluteTimeRange);a.start=e,a.end=r}let r=e.limit??20;a.limit=r+1;let n=(await l.searchWithFallback(a)).traces.map(e=>({startTimeUnixMs:1e-6*parseInt(e.startTimeUnixNano),durationMs:e.durationMs??0,traceId:e.traceID,rootServiceName:e.rootServiceName,rootTraceName:e.rootTraceName,serviceStats:e.serviceStats||{}})),s=n.length>r,i=[];return s&&(i.push({type:"info",message:"Not all matching traces are currently displayed. Increase the result limit to view additional traces."}),n.splice(r)),{searchResult:n,metadata:{executedQueryString:e.query,hasMoreResults:s,notices:i}}}};function u(e){try{return atob(e).split("").map(e=>e.charCodeAt(0).toString(16).padStart(2,"0")).join("")}catch{return e}}var p=a(62540),d=a(315),m=a(67987),f=a(7013),h=a(74628),g=a(54227),v=a(76795),x=a(97653),b=a(37266),y=a(38662),k=a(70451),T=a(5611),A=a(42927),j=a(93648),S=a(91807);function I(e){let t,a=[...N("resource.service.name",e.serviceName),...N("name",e.spanName),...N("resource.k8s.namespace.name",e.namespace),...(t=e.status.map(e=>`status = ${e}`)).length>1?["("+t.join(" || ")+")"]:1===t.length?t:[],...C("duration",e.spanDuration),...C("traceDuration",e.traceDuration),...e.customMatchers];return 0===a.length?"{}":`{ ${a.join(" && ")} }`}function D(e){return e.replaceAll("\\","\\\\").replaceAll('"','\\"')}function N(e,t){let a=t.map(D);return a.length>1?[`${e} =~ "${a.join("|")}"`]:1==a.length?[`${e} = "${a[0]}"`]:[]}function C(e,t){let a=[];return t.min&&a.push(`${e} >= ${t.min}`),t.max&&a.push(`${e} <= ${t.max}`),a}var w=a(29612);function q(e){var t;let a,r,n,s,i=(t=e,a={},r="",n="",s="",w.K3.parse(t).iterate({enter(e){switch(e.type.id){case w.d4:case w.sd:return r=t.slice(e.from,e.to),!1;case w.Ib:return n=t.slice(e.from,e.to),!1;case w.jC:return s=t.slice(e.from,e.to),!1}},leave(e){if(e.type.id===w.v5&&e.node.getChild(w.Ib)){let e=a[r]??[];e.push({operator:n,value:s}),a[r]=e}}}),a);return{serviceName:V(i["resource.service.name"]),spanName:V(i.name),namespace:V(i["resource.k8s.namespace.name"]),status:function(e){let t=[];for(let{operator:a,value:r}of e??[])"="==a&&t.push(r);return t}(i.status),spanDuration:$(i.duration),traceDuration:$(i.traceDuration),customMatchers:function(e,t){let a=[];for(let[r,n]of Object.entries(e))if(!t.has(r))for(let{operator:e,value:t}of n)a.push(`${r}${e}${t}`);return a}(i,new Set(["resource.service.name","name","resource.k8s.namespace.name","status","duration","traceDuration"]))}}function V(e){let t=[];for(let{operator:a,value:r}of e??[]){let e=r.slice(1,-1).replaceAll('\\"','"').replaceAll("\\\\","\\");"="==a?t.push(e):"=~"==a&&t.push(...e.split("|"))}return t}function $(e){let t={};for(let{operator:a,value:r}of e??[])">="==a?t.min=r:"<="==a&&(t.max=r);return t}let M=["unset","ok","error"];function _(e){let{client:t,query:a,setQuery:n}=e,s=q(a),i=e=>{n(I(e))},{absoluteTimeRange:l}=(0,r.useTimeRange)(),{start:c,end:u}=o(l),{data:d}=F(t,"resource.service.name",I({...s,serviceName:[]}),c,u),{data:m}=F(t,"name",I({...s,spanName:[]}),c,u);return(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(R,{label:"Service Name",options:d??[],value:s.serviceName,setValue:e=>i({...s,serviceName:e})}),(0,p.jsx)(R,{label:"Span Name",options:m??[],value:s.spanName,setValue:e=>i({...s,spanName:e})}),(0,p.jsx)(R,{label:"Status",width:210,options:M??[],value:s.status,setValue:e=>i({...s,status:e})}),(0,p.jsx)(O,{label:"Trace Duration",value:s.traceDuration,setValue:e=>i({...s,traceDuration:e})}),(0,p.jsx)(E,{label:"Custom Attributes",value:s.customMatchers,setValue:e=>i({...s,customMatchers:e})})]})}function R(e){let{label:t,width:a,options:r,value:n,setValue:s}=e;return(0,p.jsx)(T.A,{multiple:!0,size:"small",limitTags:1,disableCloseOnSelect:!0,value:n,onChange:(e,t)=>s(t),options:r,renderOption:(e,t,a)=>{let{selected:r}=a,{key:n,...s}=e;return(0,p.jsxs)("li",{...s,children:[(0,p.jsx)(A.A,{style:{marginRight:8},checked:r}),t]},n)},renderInput:e=>(0,p.jsx)(j.A,{...e,label:t}),slotProps:{chip:{sx:{maxWidth:"calc(100% - 45px) !important"}}},sx:{width:a??250,"& input":{minWidth:"5px !important"}}})}function O(e){let{label:t,value:a,setValue:r}=e,{min:n,max:s}=a;return(0,p.jsxs)(d.A,{direction:"row",gap:.5,children:[(0,p.jsx)(Q,{label:`Min ${t}`,value:n??"",setValue:e=>r({min:e,max:s})}),(0,p.jsx)(Q,{label:`Max ${t}`,value:s??"",setValue:e=>r({min:n,max:e})})]})}let L=/^([0-9]+\.)?[0-9]+(ns|ms|s|m|h)$/;function Q(e){let{label:t,value:a,setValue:r}=e;return(0,p.jsx)(z,{label:t,size:"small",value:a,setValue:r,validationRegex:L,validationFailedMessage:"Invalid format. Accepted format e.g. 100ms, accepted units: ns, ms, s, m, h",sx:{width:150}})}function E(e){let{label:t,value:a,setValue:r}=e;return(0,p.jsx)(z,{label:t,size:"small",placeholder:'span.http.status_code=200 span.http.method="GET"',value:a.join(" "),setValue:e=>r(function(e){let t=!1,a=0,r=[];for(let n=0;n<e.length;n++)'"'==e[n]&&"\\"!=e[n-1]?t=!t:" "!=e[n]||t||(r.push(e.slice(a,n)),a=n+1);return r.push(e.slice(a,e.length)),r.filter(e=>e)}(e)),sx:{flexGrow:1}})}function z(e){let{validationRegex:t,validationFailedMessage:a,value:r,setValue:n,...s}=e,[i,l]=(0,k.useState)(r),o=""==i||void 0==t||t.test(i);(0,k.useEffect)(()=>{l(r)},[r,l]);let c=(0,k.useCallback)(e=>{l(e.target.value)},[]),u=(0,k.useCallback)(()=>{o&&n(i)},[o,n,i]);return(0,p.jsx)(j.A,{...s,error:!o,helperText:o?void 0:a,value:i,onChange:c,onBlur:u})}function F(e,t,a,r,n){return(0,S.useQuery)({queryKey:["useTagValues",e,t,a,r,n],enabled:!!e,queryFn:async function(){if(e)return(await e.searchTagValues({tag:t,q:a,start:r,end:n})).tagValues.map(e=>e.value??"").sort()},staleTime:6e4})}var G=a(56599),W=a(79058),P=a(63960),B=a(31650);let K=(0,B.pn)({LineComment:B._A.comment,"Parent Resource Span Identifier":B._A.labelName,IntrinsicField:B._A.labelName,String:B._A.string,"Integer Float Duration":B._A.number,Static:B._A.literal,"Aggregate AggregateExpression":B._A.function(B._A.keyword),"And Or":B._A.logicOperator,"Gt Lt Desc Anc tilde ExperimentalOp":B._A.bitwiseOperator,ComparisonOp:B._A.compareOperator,Pipe:B._A.operator,ScalarOp:B._A.arithmeticOperator,"( )":B._A.paren,"[ ]":B._A.squareBracket,"{ }":B._A.brace,"âš ":B._A.invalid});var U=a(9714);let H=['"',"`"];async function J(e,t){let{state:a,pos:r}=t,n=function(e,t,a){var r,n,s,i,l,o,c,u,p,d,m,f,h,g,v,x,b,y,k,T,A;let j=a.resolveInner(t,-1);switch(j.type.id){case w.NA:if((null===j.firstChild||(null==(r=j.firstChild)?void 0:r.type.id)===0)&&!e.sliceDoc(j.from,t).includes("}"))return{scopes:[{kind:"Scopes"},{kind:"TagName",scope:"intrinsic"}],from:t};break;case w.v5:return{scopes:[{kind:"Scopes"},{kind:"TagName",scope:"intrinsic"}],from:t};case w.d4:if((null==(n=j.firstChild)?void 0:n.type.id)===w.FW)return{scopes:[{kind:"TagName",scope:"resource"}],from:t};if((null==(s=j.firstChild)?void 0:s.type.id)===w.L9)return{scopes:[{kind:"TagName",scope:"span"}],from:t};if("."===e.sliceDoc(j.from,j.to))return{scopes:[{kind:"TagName",scope:"resource"},{kind:"TagName",scope:"span"}],from:t};break;case w.gw:if((null==(i=j.parent)?void 0:i.type.id)===w.d4){if(e.sliceDoc(j.parent.from,j.parent.to).includes(":"))return{scopes:[{kind:"TagName",scope:"intrinsic"}],from:j.parent.from};if((null==(o=j.parent)||null==(l=o.firstChild)?void 0:l.type.id)===w.FW)return{scopes:[{kind:"TagName",scope:"resource"}],from:j.from};if((null==(u=j.parent)||null==(c=u.firstChild)?void 0:c.type.id)===w.L9)return{scopes:[{kind:"TagName",scope:"span"}],from:j.from};if((null==(d=j.parent)||null==(p=d.firstChild)?void 0:p.type.id)===w.gw)return{scopes:[{kind:"TagName",scope:"resource"},{kind:"TagName",scope:"span"}],from:j.from}}break;case w.Ib:if((null==(f=j.parent)||null==(m=f.firstChild)?void 0:m.type.id)===w.v5){let a=j.parent.firstChild;return{scopes:[{kind:"TagValue",tag:e.sliceDoc(a.from,a.to)}],from:t}}break;case w.Qf:if((null==(x=j.parent)||null==(v=x.parent)||null==(g=v.parent)||null==(h=g.firstChild)?void 0:h.type.id)===w.v5&&!/^".*"$/.test(e.sliceDoc(j.from,t))){let t=j.parent.parent.parent.firstChild;return{scopes:[{kind:"TagValue",tag:e.sliceDoc(t.from,t.to)}],from:j.from+1}}break;case 0:if((null==(b=j.prevSibling)?void 0:b.type.id)===w.Ib&&(null==(k=j.parent)||null==(y=k.firstChild)?void 0:y.type.id)===w.v5){let t=j.parent.firstChild;return{scopes:[{kind:"TagValue",tag:e.sliceDoc(t.from,t.to)}],from:H.includes(e.sliceDoc(j.from,j.from+1))?j.from+1:j.from}}if((null==(T=j.parent)?void 0:T.type.id)===w.NA||(null==(A=j.parent)?void 0:A.type.id)===w.v5)return{scopes:[{kind:"Scopes"},{kind:"TagName",scope:"intrinsic"}],from:j.from}}}(a,r,(0,P.mv)(a));return n?{options:await X(e,n.scopes),from:n.from,to:n.to}:null}async function X(e,t){let a=[];for(let r of t)switch(r.kind){case"Scopes":a.push(Promise.resolve([{label:"span"},{label:"resource"}]));break;case"TagName":a.push(Y(e,r.scope));break;case"TagValue":a.push(ee(e,r.tag))}return(await Promise.all(a)).flat()}async function Y(e,t){if(!e.client)return[];let{start:a,end:r}=e.timeRange?o(e.timeRange):{},{limit:n,maxStaleValues:s}=e;return(await e.client.searchTags({scope:t,start:a,end:r,limit:n,maxStaleValues:s})).scopes.flatMap(e=>e.tags).map(e=>({label:e}))}function Z(e,t,a,r){let n='"';H.includes(e.state.sliceDoc(a-1,a))&&(n=e.state.sliceDoc(a-1,a),a--),H.includes(e.state.sliceDoc(r,r+1))&&(n=e.state.sliceDoc(r,r+1),r++),t.label.includes("`")&&(n='"');let s=`${n}${function(e,t){if("`"===t)return e;let a=e;return(a=a.replaceAll("\\","\\\\")).replaceAll('"','\\"')}(t.label,n)}${n}`;e.dispatch((0,U.zH)(e.state,s,a,r))}async function ee(e,t){if(!e.client)return[];let{start:a,end:r}=e.timeRange?o(e.timeRange):{},{limit:n,maxStaleValues:s}=e,i=await e.client.searchTagValues({tag:t,start:a,end:r,limit:n,maxStaleValues:s}),l=[];for(let{type:e,value:t}of i.tagValues)switch(e){case"string":l.push({label:t??"",displayLabel:t??"(empty string)",apply:Z});break;case"keyword":case"int":l.push({label:t??"",displayLabel:t??"(empty string)"})}return l}function et(e){let{client:t,...a}=e,s=(0,G.A)(),i="dark"===s.palette.mode,{absoluteTimeRange:l}=(0,r.useTimeRange)(),o=(0,k.useMemo)(()=>{var e;let a,r;return e={client:t,timeRange:l},r=(a=P.bj.define({parser:w.K3.configure({props:[K]}),languageData:{closeBrackets:{brackets:["(","[","{","'",'"',"`"]},commentTokens:{line:"//"}}})).data.of({autocomplete:t=>J(e,t).catch(e=>console.error("error during TraceQL auto-complete",e))}),[a,r]},[t,l]),c=(0,k.useMemo)(()=>{let e="light"===s.palette.mode?"rgba(0, 0, 0, 0.23)":"rgba(255, 255, 255, 0.23)";return W.Lz.theme({"&":{backgroundColor:"transparent !important",border:`1px solid ${e}`,borderRadius:`${s.shape.borderRadius}px`},"&.cm-focused.cm-editor":{outline:"none"},".cm-content":{padding:"8px"}})},[s]);return(0,p.jsxs)(d.A,{position:"relative",sx:{flexGrow:1},children:[(0,p.jsx)(g.A,{shrink:!0,sx:{position:"absolute",top:"-6px",left:"10px",padding:"0 4px",color:s.palette.text.primary,backgroundColor:s.palette.background.default,zIndex:1},children:"TraceQL Expression"}),(0,p.jsx)(W.Ay,{...a,theme:i?"dark":"light",basicSetup:{lineNumbers:!1,highlightActiveLine:!1,highlightActiveLineGutter:!1,foldGutter:!1,syntaxHighlighting:!(0,n.h)(a.value??"")},extensions:[W.Lz.lineWrapping,o,c],placeholder:'Example: {span.http.method = "GET"}'})]})}let ea=[20,50,100,500,1e3,5e3];function er(e){let{value:t,setValue:a}=e;return(0,p.jsx)(h.A,{children:(0,p.jsxs)(m.A,{size:"small",children:[(0,p.jsx)(g.A,{id:"max-traces-label",children:"Max Traces"}),(0,p.jsx)(v.A,{labelId:"max-traces-label",id:"max-traces-select",value:t,label:"Max Traces",onChange:e=>a("number"==typeof e.target.value?e.target.value:parseInt(e.target.value)),sx:{width:110},children:ea.map(e=>(0,p.jsx)(x.A,{value:e,children:e},e))})]})})}let en={getTraceData:c,OptionsEditorComponent:function(e){let{onChange:t,value:a,value:{datasource:n,limit:s}}=e,o=n??l,c=(0,r.useDatasourceSelectValueToSelector)(o,i),u=(0,b.useId)("tempo-datasource-label"),{data:h}=(0,r.useDatasourceClient)(c),{query:g,handleQueryChange:v,handleQueryBlur:x}=function(e){let{onChange:t,value:a}=e,[r,n]=(0,k.useState)(a.query),[s,i]=(0,k.useState)(a.query);return a.query!==s&&(n(a.query),i(a.query)),{query:r,handleQueryChange:e=>{n(e)},handleQueryBlur:()=>{i(r),t((0,y.jM)(a,e=>{e.query=r}))}}}(e),[T,A]=(0,k.useState)(()=>{var e;return""==(e=g)||I(q(e))===e}),j=(0,k.useCallback)(e=>{v(e)},[v]);return(0,p.jsxs)(d.A,{spacing:2,children:[(0,p.jsx)(m.A,{margin:"dense",fullWidth:!1,children:(0,p.jsx)(r.DatasourceSelect,{datasourcePluginKind:i,value:o,onChange:e=>{if((0,r.isVariableDatasource)(e)||e.kind===i)return void t((0,y.jM)(a,t=>{t.datasource=(0,r.isVariableDatasource)(e)||void 0!==e.name?e:void 0}));throw Error("Got unexpected non-Tempo datasource selector")},labelId:u,label:"Tempo Datasource",notched:!0})}),(0,p.jsxs)(d.A,{direction:"row",spacing:2,sx:{alignItems:"flex-start"},children:[T?(0,p.jsx)(_,{client:h,query:g,setQuery:e=>{t((0,y.jM)(a,t=>{t.query=e}))}}):(0,p.jsx)(et,{client:h,value:g,onChange:j,onBlur:x}),(0,p.jsx)(f.A,{onClick:()=>A(!T),children:T?"Show query":"Hide query"}),(0,p.jsx)(er,{value:s??20,setValue:e=>t((0,y.jM)(a,t=>{t.limit=e}))})]})]})},createInitialOptions:()=>({query:"",limit:20,datasource:void 0}),dependsOn:e=>({variables:[...(0,r.isVariableDatasource)(e.datasource)?(0,r.parseVariables)(e.datasource??""):[]]})}}}]);
{"version":3,"sources":["../../../src/components/FlameChartPanel.tsx"],"sourcesContent":["// Copyright 2023 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { TitleComponentOption } from 'echarts';\nimport { useChartsTheme } from '@perses-dev/components';\nimport { Stack, Typography, SxProps, useMediaQuery, useTheme } from '@mui/material';\nimport { FC, useState, useEffect, useMemo } from 'react';\nimport { ProfileData, StackTrace } from '@perses-dev/core';\nimport { PanelProps } from '@perses-dev/plugin-system';\nimport { FlameChartOptions } from '../flame-chart-model';\nimport { filterStackTraceById, getMaxDepth } from '../utils/data-transform';\nimport { FlameChart } from './FlameChart';\nimport { Settings } from './Settings';\nimport { TableChart } from './TableChart';\nimport { SeriesChart } from './SeriesChart';\n\nconst LARGE_PANEL_THRESHOLD = 600;\nconst DEFAULT_SERIES_CHART_HEIGHT = 200;\n\nexport type FlameChartPanelProps = PanelProps<FlameChartOptions, ProfileData>;\n\nexport const FlameChartPanel: FC<FlameChartPanelProps> = (props) => {\n  const { contentDimensions, queryResults, spec } = props;\n\n  const isMobileSize = useMediaQuery(useTheme().breakpoints.down('sm'));\n\n  // selectedId equals 0 => Flame Graph is not zoomed in\n  // selectedId different from 0 => Flame Graph is zoomed in\n  const [selectedId, setSelectedId] = useState(0);\n  const [searchValue, setSearchValue] = useState('');\n\n  // This spec is used to manage settings temporarily\n  const [liveSpec, setLiveSpec] = useState<FlameChartOptions>(spec);\n\n  // keep liveSpec up to date\n  useEffect(() => {\n    setLiveSpec(spec);\n    setSelectedId(0);\n    setSearchValue('');\n  }, [spec]);\n\n  const chartsTheme = useChartsTheme();\n  const flameChartData = useMemo(() => {\n    return queryResults[0];\n  }, [queryResults]);\n\n  const selectedStackTrace: StackTrace | undefined = useMemo(() => {\n    if (!flameChartData) return undefined;\n    if (!selectedId) return flameChartData.data.profile.stackTrace;\n\n    return filterStackTraceById(flameChartData.data.profile.stackTrace, selectedId);\n  }, [flameChartData, selectedId]);\n\n  const maxDepth: number = useMemo(\n    () => (selectedStackTrace ? getMaxDepth(selectedStackTrace) : 0),\n    [selectedStackTrace]\n  );\n\n  const noDataTextStyle = (chartsTheme.noDataOption.title as TitleComponentOption).textStyle as SxProps;\n\n  const onChangePalette = (newPalette: 'package-name' | 'value') => {\n    setLiveSpec((prev) => {\n      return { ...prev, palette: newPalette };\n    });\n  };\n\n  const onDisplayChange = (value: 'table' | 'flame-graph' | 'both' | 'none') => {\n    let showTable = true;\n    let showFlameGraph = true;\n    if (value === 'table') {\n      showFlameGraph = false;\n    } else if (value === 'flame-graph') {\n      showTable = false;\n    }\n    setLiveSpec((prev) => {\n      return { ...prev, showTable: showTable, showFlameGraph: showFlameGraph };\n    });\n  };\n\n  if (!contentDimensions) return null;\n\n  const PADDING =\n    liveSpec.showSeries && liveSpec.showSettings ? 32 : liveSpec.showSeries || liveSpec.showSettings ? 16 : 0;\n\n  const SETTINGS_HEIGHT = liveSpec.showSettings ? 30 : 0;\n\n  const SERIES_CHART_HEIGHT = liveSpec.showSeries\n    ? contentDimensions.height < DEFAULT_SERIES_CHART_HEIGHT\n      ? contentDimensions.height\n      : DEFAULT_SERIES_CHART_HEIGHT\n    : 0;\n\n  const TABLE_FLAME_CHART_HEIGHT = liveSpec.traceHeight\n    ? Math.max(\n        contentDimensions.height -\n          (contentDimensions.height > LARGE_PANEL_THRESHOLD ? SERIES_CHART_HEIGHT + SETTINGS_HEIGHT + PADDING : 0),\n        maxDepth * liveSpec.traceHeight\n      )\n    : contentDimensions.height -\n      (contentDimensions.height > LARGE_PANEL_THRESHOLD ? SERIES_CHART_HEIGHT + SETTINGS_HEIGHT + PADDING : 0);\n\n  const TABLE_CHART_WIDTH = isMobileSize\n    ? contentDimensions.width\n    : liveSpec.showFlameGraph\n      ? 0.4 * contentDimensions.width\n      : contentDimensions.width;\n\n  const FLAME_CHART_WIDTH = isMobileSize\n    ? contentDimensions.width\n    : liveSpec.showTable\n      ? 0.6 * contentDimensions.width\n      : contentDimensions.width;\n\n  // TODO (gladorme): allow users to override height (useful for explorer for stack traces with high depth)\n  return (\n    <Stack\n      height={contentDimensions.height}\n      width={contentDimensions.width}\n      justifyContent=\"center\"\n      alignItems=\"center\"\n    >\n      {queryResults.length > 1 ? (\n        // display a message if there is more than one query\n        <Typography sx={{ ...noDataTextStyle }}>\n          There is more than one query. Please make sure that you provided only one query.\n        </Typography>\n      ) : flameChartData ? (\n        <Stack\n          gap={2}\n          sx={{\n            overflowY: 'auto',\n            scrollbarGutter: 'stable both-edges',\n            paddingTop: liveSpec.showSettings || liveSpec.showSeries ? 1 : 0,\n          }}\n        >\n          {liveSpec.showSeries && (\n            <SeriesChart width={contentDimensions.width} height={SERIES_CHART_HEIGHT} data={flameChartData.data} />\n          )}\n          {liveSpec.showSettings && (\n            <Settings\n              onSelectedIdChange={setSelectedId}\n              onChangePalette={onChangePalette}\n              onDisplayChange={onDisplayChange}\n              value={liveSpec}\n              selectedId={selectedId}\n            />\n          )}\n          <Stack\n            direction={isMobileSize ? 'column' : 'row'}\n            justifyContent=\"center\"\n            alignItems={isMobileSize ? 'center' : 'top'}\n          >\n            {liveSpec.showTable && (\n              <TableChart\n                width={TABLE_CHART_WIDTH}\n                height={TABLE_FLAME_CHART_HEIGHT}\n                data={flameChartData.data}\n                searchValue={searchValue}\n                onSearchValueChange={setSearchValue}\n                onSelectedIdChange={setSelectedId}\n              />\n            )}\n            {liveSpec.showFlameGraph && (\n              <FlameChart\n                width={FLAME_CHART_WIDTH}\n                height={TABLE_FLAME_CHART_HEIGHT}\n                data={flameChartData.data}\n                palette={liveSpec.palette}\n                selectedId={selectedId}\n                searchValue={searchValue}\n                onSelectedIdChange={setSelectedId}\n              />\n            )}\n          </Stack>\n        </Stack>\n      ) : (\n        <Typography sx={{ ...noDataTextStyle }}>No data</Typography>\n      )}\n    </Stack>\n  );\n};\n"],"names":["useChartsTheme","Stack","Typography","useMediaQuery","useTheme","useState","useEffect","useMemo","filterStackTraceById","getMaxDepth","FlameChart","Settings","TableChart","SeriesChart","LARGE_PANEL_THRESHOLD","DEFAULT_SERIES_CHART_HEIGHT","FlameChartPanel","props","contentDimensions","queryResults","spec","isMobileSize","breakpoints","down","selectedId","setSelectedId","searchValue","setSearchValue","liveSpec","setLiveSpec","chartsTheme","flameChartData","selectedStackTrace","undefined","data","profile","stackTrace","maxDepth","noDataTextStyle","noDataOption","title","textStyle","onChangePalette","newPalette","prev","palette","onDisplayChange","value","showTable","showFlameGraph","PADDING","showSeries","showSettings","SETTINGS_HEIGHT","SERIES_CHART_HEIGHT","height","TABLE_FLAME_CHART_HEIGHT","traceHeight","Math","max","TABLE_CHART_WIDTH","width","FLAME_CHART_WIDTH","justifyContent","alignItems","length","sx","gap","overflowY","scrollbarGutter","paddingTop","onSelectedIdChange","direction","onSearchValueChange"],"mappings":"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"}
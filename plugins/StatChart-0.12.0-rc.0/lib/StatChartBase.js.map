{"version":3,"sources":["../../src/StatChartBase.tsx"],"sourcesContent":["// Copyright 2023 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { FC, ReactNode, useMemo } from 'react';\nimport { FormatOptions } from '@perses-dev/core';\nimport { Box, Typography, styled, useTheme } from '@mui/material';\nimport merge from 'lodash/merge';\nimport { use, EChartsCoreOption } from 'echarts/core';\nimport { LineChart as EChartsLineChart, LineSeriesOption } from 'echarts/charts';\nimport { GridComponent, DatasetComponent, TitleComponent, TooltipComponent } from 'echarts/components';\nimport { CanvasRenderer } from 'echarts/renderers';\nimport { EChart, FontSizeOption, GraphSeries, useChartsTheme } from '@perses-dev/components';\nimport chroma from 'chroma-js';\nimport { useOptimalFontSize } from './utils/calculate-font-size';\nimport { formatStatChartValue } from './utils/format-stat-chart-value';\nimport { ColorMode } from './stat-chart-model';\n\nuse([EChartsLineChart, GridComponent, DatasetComponent, TitleComponent, TooltipComponent, CanvasRenderer]);\n\nconst LINE_HEIGHT = 1.2;\nconst SERIES_NAME_MAX_FONT_SIZE = 30;\nconst SERIES_NAME_FONT_WEIGHT = 400;\nconst VALUE_FONT_WEIGHT = 700;\nconst WHITE_COLOR_CODE = '#FFFFFF';\nconst BLACK_COLOR_CODE = '#000000';\n\nexport interface StatChartData {\n  color: string;\n  calculatedValue?: string | number | null;\n  seriesData?: GraphSeries;\n}\n\nexport interface StatChartProps {\n  width: number;\n  height: number;\n  data: StatChartData;\n  format?: FormatOptions;\n  sparkline?: LineSeriesOption;\n  showSeriesName?: boolean;\n  valueFontSize?: FontSizeOption;\n  colorMode?: ColorMode;\n}\n\nexport const StatChartBase: FC<StatChartProps> = (props) => {\n  const {\n    width,\n    height,\n    data,\n    data: { color },\n    sparkline,\n    showSeriesName,\n    format,\n    valueFontSize,\n    colorMode,\n  } = props;\n\n  const {\n    palette: {\n      mode: paletteMode,\n      text: { secondary },\n    },\n  } = useTheme();\n  const chartsTheme = useChartsTheme();\n  const formattedValue = formatStatChartValue(data.calculatedValue, format);\n  const containerPadding = chartsTheme.container.padding.default;\n\n  // calculate series name font size and height\n  let seriesNameFontSize = useOptimalFontSize({\n    text: data?.seriesData?.name ?? '',\n    fontWeight: SERIES_NAME_FONT_WEIGHT,\n    width,\n    height: height * 0.125, // assume series name will take 12.5% of available height\n    lineHeight: LINE_HEIGHT,\n    maxSize: SERIES_NAME_MAX_FONT_SIZE,\n  });\n\n  const seriesNameHeight = showSeriesName ? seriesNameFontSize * LINE_HEIGHT + containerPadding : 0;\n\n  // calculate value font size and height\n  const availableWidth = width - containerPadding * 2;\n  const availableHeight = height - seriesNameHeight;\n  const optimalValueFontSize = useOptimalFontSize({\n    text: formattedValue,\n    // override the font size if user selects it in the settings\n    fontSizeOverride: valueFontSize,\n    fontWeight: VALUE_FONT_WEIGHT,\n    // without sparkline, use only 50% of the available width so it looks better for multiseries\n    width: sparkline ? availableWidth : availableWidth * 0.5,\n    // with sparkline, use only 25% of available height to leave room for chart\n    // without sparkline, value should take up 90% of available space\n    height: sparkline ? availableHeight * 0.25 : availableHeight * 0.9,\n    lineHeight: LINE_HEIGHT,\n  });\n  const valueFontHeight = optimalValueFontSize * LINE_HEIGHT;\n\n  // make sure the series name font size is slightly smaller than value font size\n  seriesNameFontSize = Math.min(optimalValueFontSize * 0.7, seriesNameFontSize);\n\n  const option: EChartsCoreOption = useMemo(() => {\n    if (!data.seriesData) return chartsTheme.noDataOption;\n\n    const series = data.seriesData;\n    const statSeries: LineSeriesOption[] = [];\n\n    if (sparkline) {\n      const lineSeries = {\n        type: 'line',\n        name: series.name,\n        data: series.values,\n        zlevel: 1,\n        symbol: 'none',\n        animation: false,\n        silent: true,\n      };\n\n      const clonedSparkLine = { ...sparkline };\n      if (colorMode === 'background_solid') {\n        clonedSparkLine.areaStyle = { color: WHITE_COLOR_CODE, opacity: 0.4 };\n        clonedSparkLine.lineStyle = { color: WHITE_COLOR_CODE, opacity: 1 };\n      }\n\n      const mergedSeries = merge(lineSeries, clonedSparkLine);\n      statSeries.push(mergedSeries);\n    }\n\n    const option: EChartsCoreOption = {\n      title: {\n        show: false,\n      },\n      grid: {\n        show: false,\n        top: '35%', // adds space above sparkline\n        right: 0,\n        bottom: 0,\n        left: 0,\n        containLabel: false,\n      },\n      xAxis: {\n        type: 'time',\n        show: false,\n        boundaryGap: false,\n      },\n      yAxis: {\n        type: 'value',\n        show: false,\n        min: (value: { min: number; max: number }): number => {\n          if (value.min >= 0 && value.min <= 1) {\n            // helps with percent-decimal units, or datasets that return 0 or 1 booleans\n            return 0;\n          }\n          return value.min;\n        },\n      },\n      tooltip: {\n        show: false,\n      },\n      series: statSeries,\n    };\n\n    return option;\n  }, [data, chartsTheme, sparkline, colorMode]);\n\n  const textAlignment = sparkline ? 'auto' : 'center';\n\n  const styledFormattedValue = useMemo(() => {\n    let valueColor = '';\n\n    switch (colorMode) {\n      case 'background_solid':\n        valueColor =\n          chroma.contrast(color, WHITE_COLOR_CODE) > chroma.contrast(color, BLACK_COLOR_CODE)\n            ? WHITE_COLOR_CODE\n            : BLACK_COLOR_CODE;\n        break;\n      case 'none':\n        valueColor = paletteMode === 'dark' ? WHITE_COLOR_CODE : BLACK_COLOR_CODE;\n        break;\n      case 'value':\n      default:\n        valueColor = color;\n        break;\n    }\n\n    return (\n      <Value variant=\"h3\" color={valueColor} fontSize={optimalValueFontSize} padding={containerPadding}>\n        {formattedValue}\n      </Value>\n    );\n  }, [colorMode, containerPadding, optimalValueFontSize, formattedValue, color, paletteMode]);\n\n  const seriesName = useMemo((): ReactNode | null => {\n    if (!showSeriesName) return null;\n\n    let textColor = '';\n\n    switch (colorMode) {\n      case 'background_solid':\n        textColor =\n          chroma.contrast(color, WHITE_COLOR_CODE) > chroma.contrast(color, BLACK_COLOR_CODE)\n            ? WHITE_COLOR_CODE\n            : BLACK_COLOR_CODE;\n        break;\n      case 'none':\n      case 'value':\n      default:\n        textColor = secondary;\n        break;\n    }\n\n    return (\n      <SeriesName padding={containerPadding} fontSize={seriesNameFontSize} color={textColor}>\n        {data.seriesData?.name}\n      </SeriesName>\n    );\n  }, [colorMode, showSeriesName, secondary, color, containerPadding, seriesNameFontSize, data?.seriesData?.name]);\n\n  return (\n    <Box\n      sx={{\n        height: '100%',\n        width: '100%',\n        backgroundColor: colorMode === 'background_solid' ? color : 'transparent',\n        display: 'flex',\n        flexDirection: 'column',\n        justifyContent: textAlignment,\n        alignItems: textAlignment,\n      }}\n    >\n      {seriesName}\n      {styledFormattedValue}\n      {sparkline && (\n        <EChart\n          sx={{\n            width: '100%',\n          }}\n          style={{\n            // ECharts rounds the height to the nearest integer by default.\n            // This can cause unneccessary scrollbars when the total height of this chart exceeds the 'height' prop.\n            height: Math.floor(height - seriesNameHeight - valueFontHeight),\n          }}\n          option={option}\n          theme={chartsTheme.echartsTheme}\n          renderer=\"svg\"\n        />\n      )}\n    </Box>\n  );\n};\n\nconst SeriesName = styled(Typography, {\n  shouldForwardProp: (prop) => prop !== 'padding' && prop !== 'fontSize',\n})<{ padding?: number; fontSize?: number; textAlignment?: string; color?: string }>(({ padding, fontSize, color }) => ({\n  color: color,\n  padding: `${padding}px`,\n  fontSize: `${fontSize}px`,\n  overflow: 'hidden',\n  textOverflow: 'ellipsis',\n  whiteSpace: 'nowrap',\n}));\n\nconst Value = styled(Typography, {\n  shouldForwardProp: (prop) => prop !== 'color' && prop !== 'padding' && prop !== 'fontSize' && prop !== 'sparkline',\n})<{ color?: string; padding?: number; fontSize?: number; sparkline?: boolean }>(\n  ({ theme, color, padding, fontSize, sparkline }) => ({\n    color: color ?? theme.palette.text.primary,\n    fontSize: `${fontSize}px`,\n    padding: sparkline ? `${padding}px ${padding}px 0 ${padding}px` : ` 0 ${padding}px`,\n    whiteSpace: 'nowrap',\n    lineHeight: LINE_HEIGHT,\n  })\n);\n"],"names":["useMemo","Box","Typography","styled","useTheme","merge","use","LineChart","EChartsLineChart","GridComponent","DatasetComponent","TitleComponent","TooltipComponent","CanvasRenderer","EChart","useChartsTheme","chroma","useOptimalFontSize","formatStatChartValue","LINE_HEIGHT","SERIES_NAME_MAX_FONT_SIZE","SERIES_NAME_FONT_WEIGHT","VALUE_FONT_WEIGHT","WHITE_COLOR_CODE","BLACK_COLOR_CODE","StatChartBase","props","width","height","data","color","sparkline","showSeriesName","format","valueFontSize","colorMode","palette","mode","paletteMode","text","secondary","chartsTheme","formattedValue","calculatedValue","containerPadding","container","padding","default","seriesNameFontSize","seriesData","name","fontWeight","lineHeight","maxSize","seriesNameHeight","availableWidth","availableHeight","optimalValueFontSize","fontSizeOverride","valueFontHeight","Math","min","option","noDataOption","series","statSeries","lineSeries","type","values","zlevel","symbol","animation","silent","clonedSparkLine","areaStyle","opacity","lineStyle","mergedSeries","push","title","show","grid","top","right","bottom","left","containLabel","xAxis","boundaryGap","yAxis","value","tooltip","textAlignment","styledFormattedValue","valueColor","contrast","Value","variant","fontSize","seriesName","textColor","SeriesName","sx","backgroundColor","display","flexDirection","justifyContent","alignItems","style","floor","theme","echartsTheme","renderer","shouldForwardProp","prop","overflow","textOverflow","whiteSpace","primary"],"mappings":"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"}
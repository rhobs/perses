{"version":3,"sources":["../../src/DatasourceVariable.tsx"],"sourcesContent":["// Copyright 2025 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { OptionsEditorProps, useListPluginMetadata, VariablePlugin } from '@perses-dev/plugin-system';\nimport { Autocomplete, TextField } from '@mui/material';\nimport { useEffect, useMemo } from 'react';\n\ntype StaticListVariableOptions = {\n  datasourcePluginKind: string;\n};\n\nconst EMPTY_SELECTED_KIND = { label: '', value: '' };\n\nexport const DatasourceVariableOptionEditor = (props: OptionsEditorProps<StaticListVariableOptions>) => {\n  const { onChange, value } = props;\n  const { datasourcePluginKind } = value;\n  const { data: datasourcePlugins } = useListPluginMetadata(['Datasource']);\n\n  const datasourcePluginKindSet = useMemo(\n    () => new Set(datasourcePlugins?.map((plugin) => plugin.spec.name)),\n    [datasourcePlugins]\n  );\n\n  const options = Array.from(datasourcePluginKindSet).map((kind) => ({\n    label: kind,\n    value: kind,\n  }));\n\n  const selectedKind = options.find((option) => option.label === datasourcePluginKind) ?? EMPTY_SELECTED_KIND;\n\n  // If there is no selected kind and there are available options, select the first one\n  useEffect(() => {\n    const datasourcePluginKindArray = Array.from(datasourcePluginKindSet);\n    if (\n      selectedKind.value === EMPTY_SELECTED_KIND.value &&\n      datasourcePluginKindArray.length > 0 &&\n      datasourcePluginKindArray[0]\n    ) {\n      onChange({ datasourcePluginKind: datasourcePluginKindArray[0] });\n    }\n  }, [selectedKind, datasourcePluginKind, onChange, datasourcePluginKindSet]);\n\n  return (\n    <Autocomplete\n      options={options}\n      disableClearable\n      renderInput={(params) => (\n        <TextField {...params} label=\"Datasource Plugin Kinds\" placeholder=\"Datasource Plugin Kinds\" />\n      )}\n      value={selectedKind}\n      onChange={(event, newValue) => {\n        if (newValue === null) {\n          return;\n        }\n\n        onChange({\n          datasourcePluginKind: newValue.label,\n        });\n      }}\n    />\n  );\n};\n\nexport const DatasourceVariable: VariablePlugin<StaticListVariableOptions> = {\n  getVariableOptions: async (spec, ctx) => {\n    if (spec.datasourcePluginKind === '') return { data: [] };\n    const datasourceSelectItemGroups = await ctx.datasourceStore.listDatasourceSelectItems(spec.datasourcePluginKind);\n    const flattenedSelectItems = datasourceSelectItemGroups.flatMap((group) => group.items);\n\n    const data = flattenedSelectItems.map((item) => ({\n      label: item.name,\n      value: item.name,\n    }));\n\n    return { data };\n  },\n  OptionsEditorComponent: DatasourceVariableOptionEditor,\n  createInitialOptions: () => ({ datasourcePluginKind: '' }),\n  dependsOn: () => ({ variables: [] }),\n};\n"],"names":["useListPluginMetadata","Autocomplete","TextField","useEffect","useMemo","EMPTY_SELECTED_KIND","label","value","DatasourceVariableOptionEditor","props","onChange","datasourcePluginKind","data","datasourcePlugins","datasourcePluginKindSet","Set","map","plugin","spec","name","options","Array","from","kind","selectedKind","find","option","datasourcePluginKindArray","length","disableClearable","renderInput","params","placeholder","event","newValue","DatasourceVariable","getVariableOptions","ctx","datasourceSelectItemGroups","datasourceStore","listDatasourceSelectItems","flattenedSelectItems","flatMap","group","items","item","OptionsEditorComponent","createInitialOptions","dependsOn","variables"],"mappings":";AAAA,oCAAoC;AACpC,kEAAkE;AAClE,mEAAmE;AACnE,0CAA0C;AAC1C,EAAE;AACF,6CAA6C;AAC7C,EAAE;AACF,sEAAsE;AACtE,oEAAoE;AACpE,2EAA2E;AAC3E,sEAAsE;AACtE,iCAAiC;AAEjC,SAA6BA,qBAAqB,QAAwB,4BAA4B;AACtG,SAASC,YAAY,EAAEC,SAAS,QAAQ,gBAAgB;AACxD,SAASC,SAAS,EAAEC,OAAO,QAAQ,QAAQ;AAM3C,MAAMC,sBAAsB;IAAEC,OAAO;IAAIC,OAAO;AAAG;AAEnD,OAAO,MAAMC,iCAAiC,CAACC;IAC7C,MAAM,EAAEC,QAAQ,EAAEH,KAAK,EAAE,GAAGE;IAC5B,MAAM,EAAEE,oBAAoB,EAAE,GAAGJ;IACjC,MAAM,EAAEK,MAAMC,iBAAiB,EAAE,GAAGb,sBAAsB;QAAC;KAAa;IAExE,MAAMc,0BAA0BV,QAC9B,IAAM,IAAIW,IAAIF,mBAAmBG,IAAI,CAACC,SAAWA,OAAOC,IAAI,CAACC,IAAI,IACjE;QAACN;KAAkB;IAGrB,MAAMO,UAAUC,MAAMC,IAAI,CAACR,yBAAyBE,GAAG,CAAC,CAACO,OAAU,CAAA;YACjEjB,OAAOiB;YACPhB,OAAOgB;QACT,CAAA;IAEA,MAAMC,eAAeJ,QAAQK,IAAI,CAAC,CAACC,SAAWA,OAAOpB,KAAK,KAAKK,yBAAyBN;IAExF,qFAAqF;IACrFF,UAAU;QACR,MAAMwB,4BAA4BN,MAAMC,IAAI,CAACR;QAC7C,IACEU,aAAajB,KAAK,KAAKF,oBAAoBE,KAAK,IAChDoB,0BAA0BC,MAAM,GAAG,KACnCD,yBAAyB,CAAC,EAAE,EAC5B;YACAjB,SAAS;gBAAEC,sBAAsBgB,yBAAyB,CAAC,EAAE;YAAC;QAChE;IACF,GAAG;QAACH;QAAcb;QAAsBD;QAAUI;KAAwB;IAE1E,qBACE,KAACb;QACCmB,SAASA;QACTS,gBAAgB;QAChBC,aAAa,CAACC,uBACZ,KAAC7B;gBAAW,GAAG6B,MAAM;gBAAEzB,OAAM;gBAA0B0B,aAAY;;QAErEzB,OAAOiB;QACPd,UAAU,CAACuB,OAAOC;YAChB,IAAIA,aAAa,MAAM;gBACrB;YACF;YAEAxB,SAAS;gBACPC,sBAAsBuB,SAAS5B,KAAK;YACtC;QACF;;AAGN,EAAE;AAEF,OAAO,MAAM6B,qBAAgE;IAC3EC,oBAAoB,OAAOlB,MAAMmB;QAC/B,IAAInB,KAAKP,oBAAoB,KAAK,IAAI,OAAO;YAAEC,MAAM,EAAE;QAAC;QACxD,MAAM0B,6BAA6B,MAAMD,IAAIE,eAAe,CAACC,yBAAyB,CAACtB,KAAKP,oBAAoB;QAChH,MAAM8B,uBAAuBH,2BAA2BI,OAAO,CAAC,CAACC,QAAUA,MAAMC,KAAK;QAEtF,MAAMhC,OAAO6B,qBAAqBzB,GAAG,CAAC,CAAC6B,OAAU,CAAA;gBAC/CvC,OAAOuC,KAAK1B,IAAI;gBAChBZ,OAAOsC,KAAK1B,IAAI;YAClB,CAAA;QAEA,OAAO;YAAEP;QAAK;IAChB;IACAkC,wBAAwBtC;IACxBuC,sBAAsB,IAAO,CAAA;YAAEpC,sBAAsB;QAAG,CAAA;IACxDqC,WAAW,IAAO,CAAA;YAAEC,WAAW,EAAE;QAAC,CAAA;AACpC,EAAE"}
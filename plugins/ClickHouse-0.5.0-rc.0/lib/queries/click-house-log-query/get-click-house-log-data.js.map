{"version":3,"sources":["../../../../src/queries/click-house-log-query/get-click-house-log-data.ts"],"sourcesContent":["// Copyright 2025 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { replaceVariables } from '@perses-dev/plugin-system';\nimport { LogEntry, LogData } from '@perses-dev/core';\nimport { ClickHouseClient, ClickHouseQueryResponse } from '../../model/click-house-client';\nimport { ClickHouseLogQuerySpec } from './click-house-log-query-types';\nimport { DEFAULT_DATASOURCE } from '../constants';\nimport { LogQueryPlugin } from './log-query-plugin-interface';\n\nfunction flattenObject(\n  obj: Record<string, any>,\n  parentKey = '',\n  result: Record<string, any> = {}\n): Record<string, any> {\n  for (const [key, value] of Object.entries(obj)) {\n    const newKey = parentKey ? `${parentKey}.${key}` : key;\n    if (value && typeof value === 'object' && !Array.isArray(value)) {\n      flattenObject(value, newKey, result);\n    } else {\n      result[newKey] = value;\n    }\n  }\n\n  return result;\n}\n\nfunction convertStreamsToLogs(streams: LogEntry[]): LogData {\n  const entries: LogEntry[] = streams.map((entry) => {\n    const flattened = flattenObject(entry);\n\n    if (!flattened.Timestamp && flattened.log_time) {\n      flattened.Timestamp = flattened.log_time;\n    }\n\n    const sortedEntry: Record<string, any> = {};\n    Object.keys(flattened)\n      .sort((a, b) => a.localeCompare(b))\n      .forEach((key) => {\n        sortedEntry[key] = flattened[key];\n      });\n\n    const line = Object.entries(sortedEntry)\n      .filter(([key]) => key !== 'Timestamp')\n      .map(([key, value]) => `<${key}> ${value === '' || value === null || value === undefined ? '--' : value}`)\n      .join(' ');\n\n    return {\n      timestamp: sortedEntry?.Timestamp,\n      labels: sortedEntry,\n      line,\n    } as LogEntry;\n  });\n\n  return {\n    entries,\n    totalCount: entries.length,\n  };\n}\n\nexport const getClickHouseLogData: LogQueryPlugin<ClickHouseLogQuerySpec>['getLogData'] = async (spec, context) => {\n  if (spec.query === undefined || spec.query === null || spec.query === '') {\n    return {\n      logs: { entries: [], totalCount: 0 },\n      timeRange: { start: context.timeRange.start, end: context.timeRange.end },\n    };\n  }\n\n  const query = replaceVariables(spec.query, context.variableState);\n\n  const client = (await context.datasourceStore.getDatasourceClient(\n    spec.datasource ?? DEFAULT_DATASOURCE\n  )) as ClickHouseClient;\n\n  const { start, end } = context.timeRange;\n\n  const response: ClickHouseQueryResponse = await client.query({\n    start: start.getTime().toString(),\n    end: end.getTime().toString(),\n    query,\n  });\n\n  return {\n    timeRange: { start, end },\n    logs: convertStreamsToLogs(response.data),\n    metadata: {\n      executedQueryString: query,\n    },\n  };\n};\n"],"names":["replaceVariables","DEFAULT_DATASOURCE","flattenObject","obj","parentKey","result","key","value","Object","entries","newKey","Array","isArray","convertStreamsToLogs","streams","map","entry","flattened","Timestamp","log_time","sortedEntry","keys","sort","a","b","localeCompare","forEach","line","filter","undefined","join","timestamp","labels","totalCount","length","getClickHouseLogData","spec","context","query","logs","timeRange","start","end","variableState","client","datasourceStore","getDatasourceClient","datasource","response","getTime","toString","data","metadata","executedQueryString"],"mappings":"AAAA,oCAAoC;AACpC,kEAAkE;AAClE,mEAAmE;AACnE,0CAA0C;AAC1C,EAAE;AACF,6CAA6C;AAC7C,EAAE;AACF,sEAAsE;AACtE,oEAAoE;AACpE,2EAA2E;AAC3E,sEAAsE;AACtE,iCAAiC;AAEjC,SAASA,gBAAgB,QAAQ,4BAA4B;AAI7D,SAASC,kBAAkB,QAAQ,eAAe;AAGlD,SAASC,cACPC,GAAwB,EACxBC,YAAY,EAAE,EACdC,SAA8B,CAAC,CAAC;IAEhC,KAAK,MAAM,CAACC,KAAKC,MAAM,IAAIC,OAAOC,OAAO,CAACN,KAAM;QAC9C,MAAMO,SAASN,YAAY,GAAGA,UAAU,CAAC,EAAEE,KAAK,GAAGA;QACnD,IAAIC,SAAS,OAAOA,UAAU,YAAY,CAACI,MAAMC,OAAO,CAACL,QAAQ;YAC/DL,cAAcK,OAAOG,QAAQL;QAC/B,OAAO;YACLA,MAAM,CAACK,OAAO,GAAGH;QACnB;IACF;IAEA,OAAOF;AACT;AAEA,SAASQ,qBAAqBC,OAAmB;IAC/C,MAAML,UAAsBK,QAAQC,GAAG,CAAC,CAACC;QACvC,MAAMC,YAAYf,cAAcc;QAEhC,IAAI,CAACC,UAAUC,SAAS,IAAID,UAAUE,QAAQ,EAAE;YAC9CF,UAAUC,SAAS,GAAGD,UAAUE,QAAQ;QAC1C;QAEA,MAAMC,cAAmC,CAAC;QAC1CZ,OAAOa,IAAI,CAACJ,WACTK,IAAI,CAAC,CAACC,GAAGC,IAAMD,EAAEE,aAAa,CAACD,IAC/BE,OAAO,CAAC,CAACpB;YACRc,WAAW,CAACd,IAAI,GAAGW,SAAS,CAACX,IAAI;QACnC;QAEF,MAAMqB,OAAOnB,OAAOC,OAAO,CAACW,aACzBQ,MAAM,CAAC,CAAC,CAACtB,IAAI,GAAKA,QAAQ,aAC1BS,GAAG,CAAC,CAAC,CAACT,KAAKC,MAAM,GAAK,CAAC,CAAC,EAAED,IAAI,EAAE,EAAEC,UAAU,MAAMA,UAAU,QAAQA,UAAUsB,YAAY,OAAOtB,OAAO,EACxGuB,IAAI,CAAC;QAER,OAAO;YACLC,WAAWX,aAAaF;YACxBc,QAAQZ;YACRO;QACF;IACF;IAEA,OAAO;QACLlB;QACAwB,YAAYxB,QAAQyB,MAAM;IAC5B;AACF;AAEA,OAAO,MAAMC,uBAA6E,OAAOC,MAAMC;IACrG,IAAID,KAAKE,KAAK,KAAKT,aAAaO,KAAKE,KAAK,KAAK,QAAQF,KAAKE,KAAK,KAAK,IAAI;QACxE,OAAO;YACLC,MAAM;gBAAE9B,SAAS,EAAE;gBAAEwB,YAAY;YAAE;YACnCO,WAAW;gBAAEC,OAAOJ,QAAQG,SAAS,CAACC,KAAK;gBAAEC,KAAKL,QAAQG,SAAS,CAACE,GAAG;YAAC;QAC1E;IACF;IAEA,MAAMJ,QAAQtC,iBAAiBoC,KAAKE,KAAK,EAAED,QAAQM,aAAa;IAEhE,MAAMC,SAAU,MAAMP,QAAQQ,eAAe,CAACC,mBAAmB,CAC/DV,KAAKW,UAAU,IAAI9C;IAGrB,MAAM,EAAEwC,KAAK,EAAEC,GAAG,EAAE,GAAGL,QAAQG,SAAS;IAExC,MAAMQ,WAAoC,MAAMJ,OAAON,KAAK,CAAC;QAC3DG,OAAOA,MAAMQ,OAAO,GAAGC,QAAQ;QAC/BR,KAAKA,IAAIO,OAAO,GAAGC,QAAQ;QAC3BZ;IACF;IAEA,OAAO;QACLE,WAAW;YAAEC;YAAOC;QAAI;QACxBH,MAAM1B,qBAAqBmC,SAASG,IAAI;QACxCC,UAAU;YACRC,qBAAqBf;QACvB;IACF;AACF,EAAE"}
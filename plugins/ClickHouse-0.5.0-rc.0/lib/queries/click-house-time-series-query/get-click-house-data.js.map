{"version":3,"sources":["../../../../src/queries/click-house-time-series-query/get-click-house-data.ts"],"sourcesContent":["// Copyright 2025 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { TimeSeries } from '@perses-dev/core';\nimport { TimeSeriesQueryPlugin, replaceVariables } from '@perses-dev/plugin-system';\nimport { ClickHouseTimeSeriesQuerySpec, DatasourceQueryResponse } from './click-house-query-types';\nimport { DEFAULT_DATASOURCE } from '../constants';\nimport { TimeSeriesEntry } from '../../model/click-house-data-types';\nimport { ClickHouseClient, ClickHouseQueryResponse } from '../../model/click-house-client';\n\nfunction buildTimeSeries(response?: DatasourceQueryResponse): TimeSeries[] {\n  if (!response || !response.data || response.data.length === 0) {\n    return [];\n  }\n\n  const values: Array<[number, number]> = response.data.map((row: TimeSeriesEntry) => {\n    const timestamp = new Date(row.time).getTime();\n    const value = Number(row.log_count);\n    return [timestamp, value];\n  });\n\n  return [\n    {\n      name: 'log_count',\n      values,\n    },\n  ];\n}\n\nexport const getTimeSeriesData: TimeSeriesQueryPlugin<ClickHouseTimeSeriesQuerySpec>['getTimeSeriesData'] = async (\n  spec,\n  context\n) => {\n  if (spec.query === undefined || spec.query === null || spec.query === '') {\n    return { series: [] };\n  }\n\n  const query = replaceVariables(spec.query, context.variableState);\n\n  const client = (await context.datasourceStore.getDatasourceClient(\n    spec.datasource ?? DEFAULT_DATASOURCE\n  )) as ClickHouseClient;\n\n  const { start, end } = context.timeRange;\n\n  const response: ClickHouseQueryResponse = await client.query({\n    start: start.getTime().toString(),\n    end: end.getTime().toString(),\n    query,\n  });\n\n  return {\n    series: buildTimeSeries(response),\n    timeRange: { start, end },\n    stepMs: 30 * 1000,\n    metadata: {\n      executedQueryString: query,\n    },\n  };\n};\n"],"names":["replaceVariables","DEFAULT_DATASOURCE","buildTimeSeries","response","data","length","values","map","row","timestamp","Date","time","getTime","value","Number","log_count","name","getTimeSeriesData","spec","context","query","undefined","series","variableState","client","datasourceStore","getDatasourceClient","datasource","start","end","timeRange","toString","stepMs","metadata","executedQueryString"],"mappings":"AAAA,oCAAoC;AACpC,kEAAkE;AAClE,mEAAmE;AACnE,0CAA0C;AAC1C,EAAE;AACF,6CAA6C;AAC7C,EAAE;AACF,sEAAsE;AACtE,oEAAoE;AACpE,2EAA2E;AAC3E,sEAAsE;AACtE,iCAAiC;AAGjC,SAAgCA,gBAAgB,QAAQ,4BAA4B;AAEpF,SAASC,kBAAkB,QAAQ,eAAe;AAIlD,SAASC,gBAAgBC,QAAkC;IACzD,IAAI,CAACA,YAAY,CAACA,SAASC,IAAI,IAAID,SAASC,IAAI,CAACC,MAAM,KAAK,GAAG;QAC7D,OAAO,EAAE;IACX;IAEA,MAAMC,SAAkCH,SAASC,IAAI,CAACG,GAAG,CAAC,CAACC;QACzD,MAAMC,YAAY,IAAIC,KAAKF,IAAIG,IAAI,EAAEC,OAAO;QAC5C,MAAMC,QAAQC,OAAON,IAAIO,SAAS;QAClC,OAAO;YAACN;YAAWI;SAAM;IAC3B;IAEA,OAAO;QACL;YACEG,MAAM;YACNV;QACF;KACD;AACH;AAEA,OAAO,MAAMW,oBAA+F,OAC1GC,MACAC;IAEA,IAAID,KAAKE,KAAK,KAAKC,aAAaH,KAAKE,KAAK,KAAK,QAAQF,KAAKE,KAAK,KAAK,IAAI;QACxE,OAAO;YAAEE,QAAQ,EAAE;QAAC;IACtB;IAEA,MAAMF,QAAQpB,iBAAiBkB,KAAKE,KAAK,EAAED,QAAQI,aAAa;IAEhE,MAAMC,SAAU,MAAML,QAAQM,eAAe,CAACC,mBAAmB,CAC/DR,KAAKS,UAAU,IAAI1B;IAGrB,MAAM,EAAE2B,KAAK,EAAEC,GAAG,EAAE,GAAGV,QAAQW,SAAS;IAExC,MAAM3B,WAAoC,MAAMqB,OAAOJ,KAAK,CAAC;QAC3DQ,OAAOA,MAAMhB,OAAO,GAAGmB,QAAQ;QAC/BF,KAAKA,IAAIjB,OAAO,GAAGmB,QAAQ;QAC3BX;IACF;IAEA,OAAO;QACLE,QAAQpB,gBAAgBC;QACxB2B,WAAW;YAAEF;YAAOC;QAAI;QACxBG,QAAQ,KAAK;QACbC,UAAU;YACRC,qBAAqBd;QACvB;IACF;AACF,EAAE"}
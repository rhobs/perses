{"version":3,"sources":["../../../src/utils/data-transform.ts"],"sourcesContent":["// Copyright 2023 The Perses Authors\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport type { YAXisComponentOption } from 'echarts';\nimport { LineSeriesOption, BarSeriesOption } from 'echarts/charts';\nimport {\n  StepOptions,\n  TimeScale,\n  TimeSeries,\n  TimeSeriesValueTuple,\n  getCommonTimeScale,\n  TimeSeriesData,\n} from '@perses-dev/core';\nimport {\n  OPTIMIZED_MODE_SERIES_LIMIT,\n  LegacyTimeSeries,\n  EChartsDataFormat,\n  EChartsValues,\n  TimeSeriesOption,\n} from '@perses-dev/components';\nimport { useTimeSeriesQueries, PanelData } from '@perses-dev/plugin-system';\nimport {\n  DEFAULT_AREA_OPACITY,\n  DEFAULT_CONNECT_NULLS,\n  DEFAULT_LINE_WIDTH,\n  DEFAULT_POINT_RADIUS,\n  DEFAULT_Y_AXIS,\n  POSITIVE_MIN_VALUE_MULTIPLIER,\n  NEGATIVE_MIN_VALUE_MULTIPLIER,\n  TimeSeriesChartVisualOptions,\n  TimeSeriesChartYAxisOptions,\n  LineStyleType,\n  LOG_BASE,\n} from '../time-series-chart-model';\n\nexport type RunningQueriesState = ReturnType<typeof useTimeSeriesQueries>;\n\nexport const EMPTY_GRAPH_DATA: EChartsDataFormat = {\n  timeSeries: [],\n  xAxis: [],\n  legendItems: [],\n};\n\nexport const HIDE_DATAPOINTS_LIMIT = 70;\n\nexport const BLUR_FADEOUT_OPACITY = 0.5;\n\n/**\n * Given a list of running queries, calculates a common time scale for use on\n * the x axis (i.e. start/end dates and a step that is divisible into all of\n * the queries' steps).\n */\nexport function getCommonTimeScaleForQueries(queries: Array<PanelData<TimeSeriesData>>): TimeScale | undefined {\n  const seriesData = queries.map((query) => query.data);\n  return getCommonTimeScale(seriesData);\n}\n\n/**\n * Gets ECharts line series option properties for regular trends\n */\nexport function getTimeSeries(\n  id: string,\n  datasetIndex: number,\n  formattedName: string,\n  visual: TimeSeriesChartVisualOptions,\n  timeScale: TimeScale,\n  paletteColor: string,\n  querySettings?: { lineStyle?: LineStyleType; areaOpacity?: number }\n): TimeSeriesOption {\n  const lineWidth = visual.lineWidth ?? DEFAULT_LINE_WIDTH;\n  const pointRadius = visual.pointRadius ?? DEFAULT_POINT_RADIUS;\n\n  // Shows datapoint symbols when selected time range is roughly 15 minutes or less\n  const minuteMs = 60000;\n  let showPoints = timeScale.rangeMs <= minuteMs * 15;\n  // Allows overriding default behavior and opt-in to always show all symbols (can hurt performance)\n  if (visual.showPoints === 'always') {\n    showPoints = true;\n  }\n\n  if (visual.display === 'bar') {\n    const series: BarSeriesOption = {\n      type: 'bar',\n      id: id,\n      datasetIndex,\n      name: formattedName,\n      color: paletteColor,\n      stack: visual.stack === 'all' ? visual.stack : undefined,\n      label: {\n        show: false,\n      },\n    };\n    return series;\n  }\n\n  const series: LineSeriesOption = {\n    type: 'line',\n    id: id,\n    datasetIndex,\n    name: formattedName,\n    connectNulls: visual.connectNulls ?? DEFAULT_CONNECT_NULLS,\n    color: paletteColor,\n    stack: visual.stack === 'all' ? visual.stack : undefined,\n    sampling: 'lttb',\n    progressiveThreshold: OPTIMIZED_MODE_SERIES_LIMIT, // https://echarts.apache.org/en/option.html#series-lines.progressiveThreshold\n    showSymbol: showPoints,\n    showAllSymbol: true,\n    symbolSize: pointRadius,\n    lineStyle: {\n      width: lineWidth,\n      type: (querySettings?.lineStyle ?? visual.lineStyle) as LineStyleType,\n    },\n    areaStyle: {\n      opacity: querySettings?.areaOpacity ?? visual.areaOpacity ?? DEFAULT_AREA_OPACITY,\n    },\n    // https://echarts.apache.org/en/option.html#series-line.emphasis\n    emphasis: {\n      focus: 'series',\n      disabled: visual.areaOpacity !== undefined && visual.areaOpacity > 0, // prevents flicker when moving cursor between shaded regions\n      lineStyle: {\n        width: lineWidth + 1,\n        opacity: 1,\n        type: visual.lineStyle,\n      },\n    },\n    selectedMode: 'single',\n    select: {\n      itemStyle: {\n        borderColor: paletteColor,\n        borderWidth: pointRadius + 0.5,\n      },\n    },\n    blur: {\n      lineStyle: {\n        width: lineWidth,\n        opacity: BLUR_FADEOUT_OPACITY,\n        type: visual.lineStyle,\n      },\n    },\n  };\n  return series;\n}\n\n/**\n * Gets threshold-specific line series styles\n * markLine cannot be used since it does not update yAxis max / min\n * and threshold data needs to show in the tooltip\n */\nexport function getThresholdSeries(name: string, threshold: StepOptions, seriesIndex: number): LineSeriesOption {\n  return {\n    type: 'line',\n    name: name,\n    id: name,\n    datasetId: name,\n    datasetIndex: seriesIndex,\n    color: threshold.color,\n    label: {\n      show: false,\n    },\n    lineStyle: {\n      type: 'dashed',\n      width: 2,\n    },\n    emphasis: {\n      focus: 'series',\n      lineStyle: {\n        width: 2.5,\n      },\n    },\n    blur: {\n      lineStyle: {\n        opacity: BLUR_FADEOUT_OPACITY,\n      },\n    },\n  };\n}\n\n/**\n * Converts percent threshold into absolute step value\n * If max is undefined, use the max value from time series data as default\n */\nexport function convertPercentThreshold(\n  percent: number,\n  data: LegacyTimeSeries[] | TimeSeries[],\n  max?: number,\n  min?: number\n): number {\n  const percentDecimal = percent / 100;\n  const adjustedMax = max ?? findMax(data);\n  const adjustedMin = min ?? 0;\n  const total = adjustedMax - adjustedMin;\n  return percentDecimal * total + adjustedMin;\n}\n\nfunction findMax(data: LegacyTimeSeries[] | TimeSeries[]): number {\n  let max = 0;\n  if (data.length && data[0] !== undefined && (data as TimeSeries[])[0]?.values) {\n    (data as TimeSeries[]).forEach((series) => {\n      series.values.forEach((valueTuple: TimeSeriesValueTuple) => {\n        // eslint-disable-next-line @typescript-eslint/no-unused-vars\n        const [_, value] = valueTuple;\n        if (typeof value === 'number' && value > max) {\n          max = value;\n        }\n      });\n    });\n  } else {\n    (data as LegacyTimeSeries[]).forEach((series) => {\n      if (series.data !== undefined) {\n        series.data.forEach((value: EChartsValues) => {\n          if (typeof value === 'number' && value > max) {\n            max = value;\n          }\n        });\n      }\n    });\n  }\n  return max;\n}\n\n/**\n * Converts Perses panel yAxis from dashboard spec to ECharts supported yAxis options.\n * Handles both linear and logarithmic scales with appropriate min/max calculations.\n */\nexport function convertPanelYAxis(\n  inputAxis: TimeSeriesChartYAxisOptions = {},\n  useLogarithmicBase: LOG_BASE\n): YAXisComponentOption {\n  // Determine the appropriate min value based on scale type and user input\n  let minValue: YAXisComponentOption['min'];\n\n  if (inputAxis?.min !== undefined) {\n    // User explicitly set a min value - use it for both linear and log scales\n    minValue = inputAxis.min;\n  } else if (useLogarithmicBase !== 'none') {\n    // For logarithmic scales without explicit min:\n    // Let ECharts auto-calculate the range based on data to avoid issues with\n    // function-based calculations which can result in improper ranges (e.g., 1-10)\n    minValue = undefined;\n  } else {\n    // For linear scales without explicit min:\n    // Use dynamic calculation with padding for better visualization\n    // https://echarts.apache.org/en/option.html#yAxis.min\n    minValue = (value): number => {\n      if (value.min >= 0 && value.min <= 1) {\n        // Helps with PercentDecimal units, or datasets that return 0 or 1 booleans\n        return 0;\n      }\n\n      // Note: We can tweak the MULTIPLIER constants if we want\n      // TODO: Experiment with using a padding that is based on the difference between max value and min value\n      if (value.min > 0) {\n        return roundDown(value.min * POSITIVE_MIN_VALUE_MULTIPLIER);\n      } else {\n        return roundDown(value.min * NEGATIVE_MIN_VALUE_MULTIPLIER);\n      }\n    };\n  }\n\n  // Build the yAxis configuration\n  const yAxis: YAXisComponentOption = {\n    show: true,\n    axisLabel: {\n      show: inputAxis?.show ?? DEFAULT_Y_AXIS.show,\n    },\n    min: minValue,\n    max: inputAxis?.max,\n  };\n\n  // Apply logarithmic scale settings if requested\n  if (useLogarithmicBase !== 'none') {\n    return {\n      ...yAxis,\n      type: 'log',\n      logBase: useLogarithmicBase,\n    };\n  }\n\n  return yAxis;\n}\n\n/**\n * Rounds down to nearest number with one significant digit.\n *\n * Examples:\n * 1. 675 --> 600\n * 2. 0.567 --> 0.5\n * 3. -12 --> -20\n */\nexport function roundDown(num: number): number {\n  const magnitude = Math.floor(Math.log10(Math.abs(num)));\n  const firstDigit = Math.floor(num / Math.pow(10, magnitude));\n  return firstDigit * Math.pow(10, magnitude);\n}\n"],"names":["getCommonTimeScale","OPTIMIZED_MODE_SERIES_LIMIT","DEFAULT_AREA_OPACITY","DEFAULT_CONNECT_NULLS","DEFAULT_LINE_WIDTH","DEFAULT_POINT_RADIUS","DEFAULT_Y_AXIS","POSITIVE_MIN_VALUE_MULTIPLIER","NEGATIVE_MIN_VALUE_MULTIPLIER","EMPTY_GRAPH_DATA","timeSeries","xAxis","legendItems","HIDE_DATAPOINTS_LIMIT","BLUR_FADEOUT_OPACITY","getCommonTimeScaleForQueries","queries","seriesData","map","query","data","getTimeSeries","id","datasetIndex","formattedName","visual","timeScale","paletteColor","querySettings","lineWidth","pointRadius","minuteMs","showPoints","rangeMs","display","series","type","name","color","stack","undefined","label","show","connectNulls","sampling","progressiveThreshold","showSymbol","showAllSymbol","symbolSize","lineStyle","width","areaStyle","opacity","areaOpacity","emphasis","focus","disabled","selectedMode","select","itemStyle","borderColor","borderWidth","blur","getThresholdSeries","threshold","seriesIndex","datasetId","convertPercentThreshold","percent","max","min","percentDecimal","adjustedMax","findMax","adjustedMin","total","length","values","forEach","valueTuple","_","value","convertPanelYAxis","inputAxis","useLogarithmicBase","minValue","roundDown","yAxis","axisLabel","logBase","num","magnitude","Math","floor","log10","abs","firstDigit","pow"],"mappings":"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"}